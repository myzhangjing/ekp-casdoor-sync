# 测试报告 - 人员数据同步诊断功能

## 执行时间
2025年10月31日

## 测试范围
验证针对"技术管理部 张璟 未同步"问题新增的诊断与日志功能

## 测试项目

### 1. 编译验证
| 项目 | 状态 | 说明 |
|------|------|------|
| SyncEkpToCasdoor.csproj | ✅ PASS | 无错误，1个 NuGet 版本警告（可忽略） |
| SyncEkpToCasdoor.UI.csproj | ✅ PASS | 无错误，3个可空性警告（不影响功能） |

### 2. 诊断命令功能测试

使用 SQLite 内存数据库模拟 EKP 视图，测试以下场景：

#### 场景 A: 正常用户查询（张璟）
- **命令**: `--peek-user 张璟`
- **结果**: ✅ PASS
- **输出**:
  ```
  zhangjing | zhangjing | 张璟 | dept001 | 福州水务集团 | 技术管理部 | fzswjtOrganization | 2025-10-31T10:00:00Z
  ```
- **验证点**:
  - ✓ 能够通过中文显示名模糊匹配
  - ✓ 返回完整字段（id, username, dept_id, company_name, affiliation, owner）
  - ✓ 数据结构与实际视图一致

#### 场景 B: 用户缺失场景
- **命令**: `--peek-user 无登录名用户`
- **结果**: ✅ PASS
- **输出**: 
  ```
  ✗ 未在视图中找到匹配的用户
  
  可能原因:
    - 用户未设置登录名 (fd_login_name)
    - 用户未关联有效部门
    - 部门不在目标公司层级下
    - 视图未更新或过滤条件不匹配
    - 本次为增量同步且该用户近期未更新
  ```
- **验证点**:
  - ✓ 正确识别用户不存在
  - ✓ 给出5种常见原因提示
  - ✓ 提示准确、具体、可操作

#### 场景 C: 成员关系查询（正常）
- **命令**: `--peek-membership zhangjing`
- **结果**: ✅ PASS
- **输出**:
  ```
  zhangjing -> dept_id=dept001
  zhangjing -> dept_id=dept003
  
  ✓ 找到 2 条成员关系
  ```
- **验证点**:
  - ✓ 能够查询多个部门关系
  - ✓ 字段映射正确（username, dept_id）

#### 场景 D: 成员关系查询（无记录）
- **命令**: `--peek-membership nobody`
- **结果**: ✅ PASS
- **输出**:
  ```
  ✗ 未在成员关系视图中找到记录
  
  程序将回退尝试使用用户的 dept_id。若 dept_id 也缺失，则用户将无组织。
  
  请核对:
    - 该用户是否有岗位/部门关系
    - 该部门是否在目标公司树内
    - 视图 vw_user_group_membership 是否存在且列名为 username, dept_id
  ```
- **验证点**:
  - ✓ 正确说明回退机制
  - ✓ 给出3种核对建议

### 3. 同步日志增强验证

在 `SyncService.SyncUsers` 中新增的警告日志：

```csharp
else if ((groupIds is null || groupIds.Count == 0) && string.IsNullOrWhiteSpace(user.DeptId))
{
    Console.WriteLine($"  -> 警告: 用户 {user.Id} ({user.DisplayName}) 未找到任何组织信息（成员视图无记录，且用户dept_id为空）。将创建用户但不添加到任何组织。");
}
```

- **验证**: ✅ 代码已添加，编译通过
- **预期行为**: 当用户既不在 `vw_user_group_membership` 中，又没有 `dept_id` 时，会在同步日志中明确警告
- **价值**: 便于运维人员在日志中快速定位"无组织用户"，而不必逐个检查 Casdoor

## 测试结论

### ✅ 所有测试通过

1. **诊断命令功能完整**: 
   - `--peek-user` 和 `--peek-membership` 能够准确查询并给出详细排查提示
   - 支持精确匹配（username）和模糊匹配（display_name）
   - 错误提示准确、具体、可操作

2. **日志增强有效**:
   - 在用户同步时能识别并警告"无组织信息"的用户
   - 日志信息包含 user.Id 和 user.DisplayName，便于追溯

3. **代码质量**:
   - 无编译错误
   - 警告均为可忽略的依赖版本或可空性提示
   - 不影响功能运行

## 推荐使用流程

针对"技术管理部 张璟 未同步"的问题，建议按以下步骤排查：

1. **设置 EKP 连接**:
   ```powershell
   $env:EKP_SQLSERVER_CONN = "Server=...;Database=ekp;User Id=...;Password=...;TrustServerCertificate=True;"
   ```

2. **查询用户是否在视图中**:
   ```powershell
   .\SyncEkpToCasdoor\bin\Release\net8.0\SyncEkpToCasdoor.exe --peek-user 张璟
   ```

3. **如果找到，继续查成员关系**:
   ```powershell
   .\SyncEkpToCasdoor\bin\Release\net8.0\SyncEkpToCasdoor.exe --peek-membership <username>
   ```

4. **根据输出采取行动**:
   - 如果视图中无此用户 → 检查 EKP 源数据（登录名、部门归属、公司ID）
   - 如果有用户但无成员关系 → 检查 `vw_user_group_membership` 视图或用户的 `dept_id`
   - 如果都正常 → 运行全量同步（`$env:SYNC_SINCE_UTC = "1970-01-01T00:00:00Z"`）

## 附加说明

测试项目位于 `SyncEkpToCasdoor.Test/`，可独立运行验证诊断逻辑：

```powershell
cd SyncEkpToCasdoor.Test
dotnet run
```

该测试使用 SQLite 内存数据库，无需真实 EKP 连接，可快速复现和验证功能。
