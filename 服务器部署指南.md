# æœåŠ¡å™¨éƒ¨ç½²æŒ‡å—

## å¿«é€Ÿéƒ¨ç½² (ä¸€é”®éƒ¨ç½²)

### æ–¹å¼1: ç›´æŽ¥ä¸‹è½½å¹¶è¿è¡Œè„šæœ¬

```bash
# ä¸‹è½½éƒ¨ç½²è„šæœ¬
wget https://raw.githubusercontent.com/myzhangjing/ekp-casdoor-sync/web-docker/server-deploy.sh

# æ·»åŠ æ‰§è¡Œæƒé™
chmod +x server-deploy.sh

# è¿è¡Œéƒ¨ç½²
./server-deploy.sh
```

### æ–¹å¼2: ä»Žæœ¬åœ°ä¸Šä¼ è„šæœ¬

```bash
# åœ¨æœ¬åœ° (Windows PowerShell)
scp server-deploy.sh root@ä½ çš„æœåŠ¡å™¨IP:/root/

# åœ¨æœåŠ¡å™¨ä¸Š
chmod +x /root/server-deploy.sh
/root/server-deploy.sh
```

## éƒ¨ç½²è„šæœ¬åŠŸèƒ½

è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬ä¼šå®Œæˆä»¥ä¸‹æ“ä½œ:

1. âœ… **æ£€æŸ¥ç³»ç»ŸçŽ¯å¢ƒ**
   - æ£€æŸ¥å¹¶å®‰è£… Git
   - æ£€æŸ¥å¹¶å®‰è£… .NET 8.0 SDK

2. âœ… **ä»£ç ç®¡ç†**
   - å…‹éš†GitHubä»“åº“ (é¦–æ¬¡éƒ¨ç½²)
   - æ‹‰å–æœ€æ–°ä»£ç  (æ›´æ–°éƒ¨ç½²)
   - è‡ªåŠ¨å¤‡ä»½å’Œæ¢å¤é…ç½®æ–‡ä»¶

3. âœ… **åœæ­¢çŽ°æœ‰æœåŠ¡**
   - åœæ­¢systemdæœåŠ¡
   - æ¸…ç†ç«¯å£å ç”¨è¿›ç¨‹

4. âœ… **ç¼–è¯‘å‘å¸ƒ**
   - Releaseæ¨¡å¼ç¼–è¯‘
   - å‘å¸ƒåˆ°æŒ‡å®šç›®å½•

5. âœ… **é…ç½®æœåŠ¡**
   - åˆ›å»ºsystemdæœåŠ¡å•å…ƒ
   - é…ç½®å¼€æœºè‡ªå¯åŠ¨
   - è®¾ç½®çŽ¯å¢ƒå˜é‡

6. âœ… **å¯åŠ¨æœåŠ¡**
   - å¯åŠ¨åº”ç”¨æœåŠ¡
   - å¥åº·æ£€æŸ¥
   - æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯

7. âœ… **éªŒè¯éƒ¨ç½²**
   - æµ‹è¯•æœåŠ¡å“åº”
   - æ˜¾ç¤ºè®¿é—®åœ°å€å’Œå¸¸ç”¨å‘½ä»¤

## éƒ¨ç½²åŽé…ç½®

### 1. ç¼–è¾‘é…ç½®æ–‡ä»¶

```bash
nano ~/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/SyncEkpToCasdoor.Web/appsettings.json
```

**å¿…é¡»é…ç½®çš„é¡¹ç›®:**

```json
{
  "EkpConnection": "Server=ä½ çš„EKPæ•°æ®åº“IP,1433;Database=ecology;User Id=sa;Password=ä½ çš„å¯†ç ;TrustServerCertificate=true",
  
  "CasdoorAuth": {
    "ClientId": "cb838421e04ecd30f72b",
    "ClientSecret": "e54b3c2d06c864ac9243a03b8002b75167dce01d",
    "Authority": "http://sso.fzcsps.com",
    "AllowedOwner": "built-in"
  },
  
  "CasdoorSdk": {
    "Endpoint": "http://sso.fzcsps.com",
    "OrganizationName": "built-in",
    "ApplicationName": "app-ekp-casdoor-sync",
    "ClientId": "cb838421e04ecd30f72b",
    "ClientSecret": "e54b3c2d06c864ac9243a03b8002b75167dce01d"
  },
  
  "TargetCompanyIds": "16f1c1a4910426f41649fd14862b99a1,18e389224b660b4d67413f8466285581",
  
  "ScheduledSync": {
    "Enabled": false,
    "IntervalSeconds": 3600
  }
}
```

### 2. é‡å¯æœåŠ¡ä½¿é…ç½®ç”Ÿæ•ˆ

```bash
sudo systemctl restart ekp-casdoor-sync
```

### 3. æŸ¥çœ‹æœåŠ¡çŠ¶æ€

```bash
# æŸ¥çœ‹ç³»ç»ŸæœåŠ¡çŠ¶æ€
sudo systemctl status ekp-casdoor-sync

# æŸ¥çœ‹å®žæ—¶æ—¥å¿—
sudo journalctl -u ekp-casdoor-sync -f

# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
tail -f ~/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/SyncEkpToCasdoor.Web/logs/*.log
```

## æœåŠ¡ç®¡ç†å‘½ä»¤

```bash
# å¯åŠ¨æœåŠ¡
sudo systemctl start ekp-casdoor-sync

# åœæ­¢æœåŠ¡
sudo systemctl stop ekp-casdoor-sync

# é‡å¯æœåŠ¡
sudo systemctl restart ekp-casdoor-sync

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status ekp-casdoor-sync

# å¯ç”¨å¼€æœºè‡ªå¯
sudo systemctl enable ekp-casdoor-sync

# ç¦ç”¨å¼€æœºè‡ªå¯
sudo systemctl disable ekp-casdoor-sync
```

## è®¿é—®åº”ç”¨

### å†…ç½‘è®¿é—®

```bash
# èŽ·å–æœåŠ¡å™¨IP
hostname -I

# è®¿é—®åœ°å€
http://æœåŠ¡å™¨IP:5233/login
```

### å¤–ç½‘è®¿é—® (éœ€é…ç½®Nginx)

#### 1. å®‰è£…Nginx

```bash
sudo apt-get update
sudo apt-get install -y nginx
```

#### 2. é…ç½®åå‘ä»£ç†

```bash
sudo nano /etc/nginx/sites-available/ekp-casdoor-sync
```

**é…ç½®å†…å®¹:**

```nginx
server {
    listen 80;
    server_name ä½ çš„åŸŸå.com;  # æˆ–è€…ä½¿ç”¨IP

    location / {
        proxy_pass http://localhost:5233;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection keep-alive;
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

#### 3. å¯ç”¨é…ç½®

```bash
sudo ln -s /etc/nginx/sites-available/ekp-casdoor-sync /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

#### 4. é…ç½®SSL (å¯é€‰,æŽ¨è)

```bash
# å®‰è£…certbot
sudo apt-get install -y certbot python3-certbot-nginx

# èŽ·å–SSLè¯ä¹¦
sudo certbot --nginx -d ä½ çš„åŸŸå.com

# è‡ªåŠ¨ç»­æœŸ
sudo certbot renew --dry-run
```

## æ›´æ–°éƒ¨ç½²

å½“ä»£ç æ›´æ–°åŽ,åœ¨æœåŠ¡å™¨ä¸Šé‡æ–°è¿è¡Œéƒ¨ç½²è„šæœ¬å³å¯:

```bash
./server-deploy.sh
```

è„šæœ¬ä¼šè‡ªåŠ¨:
- ä¿å­˜çŽ°æœ‰é…ç½®
- æ‹‰å–æœ€æ–°ä»£ç 
- é‡æ–°ç¼–è¯‘
- æ¢å¤é…ç½®
- é‡å¯æœåŠ¡

## é˜²ç«å¢™é…ç½®

å¦‚æžœä½¿ç”¨UFWé˜²ç«å¢™:

```bash
# å¼€æ”¾åº”ç”¨ç«¯å£
sudo ufw allow 5233/tcp

# å¼€æ”¾HTTP/HTTPS (å¦‚æžœä½¿ç”¨Nginx)
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# æŸ¥çœ‹çŠ¶æ€
sudo ufw status
```

## æ•…éšœæŽ’æŸ¥

### æœåŠ¡æ— æ³•å¯åŠ¨

```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—
sudo journalctl -u ekp-casdoor-sync -n 100 --no-pager

# æ£€æŸ¥ç«¯å£å ç”¨
sudo lsof -i :5233

# æ‰‹åŠ¨è¿è¡Œæµ‹è¯•
cd ~/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/SyncEkpToCasdoor.Web/bin/Release/net8.0/publish
dotnet SyncEkpToCasdoor.Web.dll
```

### æ•°æ®åº“è¿žæŽ¥å¤±è´¥

```bash
# æµ‹è¯•æ•°æ®åº“è¿žæŽ¥
telnet EKPæ•°æ®åº“IP 1433

# æ£€æŸ¥é…ç½®æ–‡ä»¶
cat ~/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/SyncEkpToCasdoor.Web/appsettings.json
```

### OAuthè®¤è¯å¤±è´¥

1. æ£€æŸ¥Casdooré…ç½®æ˜¯å¦æ­£ç¡®
2. ç¡®è®¤å›žè°ƒURLå·²åœ¨Casdoorä¸­é…ç½®
3. éªŒè¯ClientIdå’ŒClientSecret

### æ— æ³•è®¿é—®

```bash
# æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œ
sudo systemctl status ekp-casdoor-sync

# æ£€æŸ¥ç«¯å£ç›‘å¬
sudo netstat -tulpn | grep 5233

# æµ‹è¯•æœ¬åœ°è®¿é—®
curl http://localhost:5233/login
```

## æ€§èƒ½ä¼˜åŒ–

### 1. å¯ç”¨ç”Ÿäº§æ¨¡å¼

çŽ¯å¢ƒå˜é‡å·²åœ¨systemdæœåŠ¡ä¸­é…ç½®:
```
Environment=ASPNETCORE_ENVIRONMENT=Production
```

### 2. é…ç½®æ—¥å¿—çº§åˆ«

ç¼–è¾‘ `appsettings.json`:

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  }
}
```

### 3. æ•°æ®åº“è¿žæŽ¥æ± 

åœ¨è¿žæŽ¥å­—ç¬¦ä¸²ä¸­æ·»åŠ :
```
Min Pool Size=5;Max Pool Size=100;
```

## ç›‘æŽ§å’Œç»´æŠ¤

### å®šæœŸæ£€æŸ¥

```bash
# åˆ›å»ºç›‘æŽ§è„šæœ¬
cat > ~/check-app.sh << 'EOF'
#!/bin/bash
if ! curl -s http://localhost:5233/login > /dev/null; then
    echo "åº”ç”¨æ— å“åº”,é‡å¯æœåŠ¡..."
    sudo systemctl restart ekp-casdoor-sync
fi
EOF

chmod +x ~/check-app.sh

# æ·»åŠ åˆ°crontab (æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡)
crontab -e
# æ·»åŠ : */5 * * * * ~/check-app.sh
```

### æ—¥å¿—æ¸…ç†

```bash
# åˆ›å»ºæ—¥å¿—æ¸…ç†è„šæœ¬
cat > ~/cleanup-logs.sh << 'EOF'
#!/bin/bash
LOG_DIR=~/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/SyncEkpToCasdoor.Web/logs
find $LOG_DIR -name "*.log" -mtime +30 -delete
EOF

chmod +x ~/cleanup-logs.sh

# æ¯å‘¨æ‰§è¡Œä¸€æ¬¡
crontab -e
# æ·»åŠ : 0 0 * * 0 ~/cleanup-logs.sh
```

## å®‰å…¨å»ºè®®

1. âœ… ä½¿ç”¨å¼ºå¯†ç 
2. âœ… é…ç½®SSL/TLS (HTTPS)
3. âœ… é™åˆ¶æ•°æ®åº“è®¿é—®IP
4. âœ… å®šæœŸæ›´æ–°ç³»ç»Ÿå’Œä¾èµ–
5. âœ… é…ç½®é˜²ç«å¢™è§„åˆ™
6. âœ… å®šæœŸå¤‡ä»½é…ç½®å’Œæ•°æ®

## å¤‡ä»½å’Œæ¢å¤

### å¤‡ä»½é…ç½®

```bash
# åˆ›å»ºå¤‡ä»½è„šæœ¬
cat > ~/backup-config.sh << 'EOF'
#!/bin/bash
BACKUP_DIR=~/backups
mkdir -p $BACKUP_DIR
CONFIG_FILE=~/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/SyncEkpToCasdoor.Web/appsettings.json
cp $CONFIG_FILE $BACKUP_DIR/appsettings.json.$(date +%Y%m%d_%H%M%S)
# åªä¿ç•™æœ€è¿‘7å¤©çš„å¤‡ä»½
find $BACKUP_DIR -name "appsettings.json.*" -mtime +7 -delete
EOF

chmod +x ~/backup-config.sh
```

### æ¢å¤é…ç½®

```bash
# åˆ—å‡ºå¤‡ä»½
ls -l ~/backups/

# æ¢å¤ç‰¹å®šå¤‡ä»½
cp ~/backups/appsettings.json.YYYYMMDD_HHMMSS ~/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/SyncEkpToCasdoor.Web/appsettings.json

# é‡å¯æœåŠ¡
sudo systemctl restart ekp-casdoor-sync
```

## è”ç³»æ”¯æŒ

å¦‚æœ‰é—®é¢˜,è¯·æŸ¥çœ‹:
- ðŸ“– é¡¹ç›®æ–‡æ¡£: https://github.com/myzhangjing/ekp-casdoor-sync
- ðŸ› é—®é¢˜åé¦ˆ: https://github.com/myzhangjing/ekp-casdoor-sync/issues

---

**éƒ¨ç½²æˆåŠŸåŽ,è¯·è®¿é—®: http://ä½ çš„æœåŠ¡å™¨IP:5233/login**
