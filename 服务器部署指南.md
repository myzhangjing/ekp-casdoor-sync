# 服务器部署指南

## 快速部署 (一键部署)

### 方式1: 直接下载并运行脚本

```bash
# 下载部署脚本
wget https://raw.githubusercontent.com/myzhangjing/ekp-casdoor-sync/web-docker/server-deploy.sh

# 添加执行权限
chmod +x server-deploy.sh

# 运行部署
./server-deploy.sh
```

### 方式2: 从本地上传脚本

```bash
# 在本地 (Windows PowerShell)
scp server-deploy.sh root@你的服务器IP:/root/

# 在服务器上
chmod +x /root/server-deploy.sh
/root/server-deploy.sh
```

## 部署脚本功能

自动化部署脚本会完成以下操作:

1. ✅ **检查系统环境**
   - 检查并安装 Git
   - 检查并安装 .NET 8.0 SDK

2. ✅ **代码管理**
   - 克隆GitHub仓库 (首次部署)
   - 拉取最新代码 (更新部署)
   - 自动备份和恢复配置文件

3. ✅ **停止现有服务**
   - 停止systemd服务
   - 清理端口占用进程

4. ✅ **编译发布**
   - Release模式编译
   - 发布到指定目录

5. ✅ **配置服务**
   - 创建systemd服务单元
   - 配置开机自启动
   - 设置环境变量

6. ✅ **启动服务**
   - 启动应用服务
   - 健康检查
   - 显示状态信息

7. ✅ **验证部署**
   - 测试服务响应
   - 显示访问地址和常用命令

## 部署后配置

### 1. 编辑配置文件

```bash
nano ~/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/SyncEkpToCasdoor.Web/appsettings.json
```

**必须配置的项目:**

```json
{
  "EkpConnection": "Server=你的EKP数据库IP,1433;Database=ecology;User Id=sa;Password=你的密码;TrustServerCertificate=true",
  
  "CasdoorAuth": {
    "ClientId": "cb838421e04ecd30f72b",
    "ClientSecret": "e54b3c2d06c864ac9243a03b8002b75167dce01d",
    "Authority": "http://sso.fzcsps.com",
    "AllowedOwner": "built-in"
  },
  
  "CasdoorSdk": {
    "Endpoint": "http://sso.fzcsps.com",
    "OrganizationName": "built-in",
    "ApplicationName": "app-ekp-casdoor-sync",
    "ClientId": "cb838421e04ecd30f72b",
    "ClientSecret": "e54b3c2d06c864ac9243a03b8002b75167dce01d"
  },
  
  "TargetCompanyIds": "16f1c1a4910426f41649fd14862b99a1,18e389224b660b4d67413f8466285581",
  
  "ScheduledSync": {
    "Enabled": false,
    "IntervalSeconds": 3600
  }
}
```

### 2. 重启服务使配置生效

```bash
sudo systemctl restart ekp-casdoor-sync
```

### 3. 查看服务状态

```bash
# 查看系统服务状态
sudo systemctl status ekp-casdoor-sync

# 查看实时日志
sudo journalctl -u ekp-casdoor-sync -f

# 查看应用日志
tail -f ~/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/SyncEkpToCasdoor.Web/logs/*.log
```

## 服务管理命令

```bash
# 启动服务
sudo systemctl start ekp-casdoor-sync

# 停止服务
sudo systemctl stop ekp-casdoor-sync

# 重启服务
sudo systemctl restart ekp-casdoor-sync

# 查看状态
sudo systemctl status ekp-casdoor-sync

# 启用开机自启
sudo systemctl enable ekp-casdoor-sync

# 禁用开机自启
sudo systemctl disable ekp-casdoor-sync
```

## 访问应用

### 内网访问

```bash
# 获取服务器IP
hostname -I

# 访问地址
http://服务器IP:5233/login
```

### 外网访问 (需配置Nginx)

#### 1. 安装Nginx

```bash
sudo apt-get update
sudo apt-get install -y nginx
```

#### 2. 配置反向代理

```bash
sudo nano /etc/nginx/sites-available/ekp-casdoor-sync
```

**配置内容:**

```nginx
server {
    listen 80;
    server_name 你的域名.com;  # 或者使用IP

    location / {
        proxy_pass http://localhost:5233;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection keep-alive;
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

#### 3. 启用配置

```bash
sudo ln -s /etc/nginx/sites-available/ekp-casdoor-sync /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

#### 4. 配置SSL (可选,推荐)

```bash
# 安装certbot
sudo apt-get install -y certbot python3-certbot-nginx

# 获取SSL证书
sudo certbot --nginx -d 你的域名.com

# 自动续期
sudo certbot renew --dry-run
```

## 更新部署

当代码更新后,在服务器上重新运行部署脚本即可:

```bash
./server-deploy.sh
```

脚本会自动:
- 保存现有配置
- 拉取最新代码
- 重新编译
- 恢复配置
- 重启服务

## 防火墙配置

如果使用UFW防火墙:

```bash
# 开放应用端口
sudo ufw allow 5233/tcp

# 开放HTTP/HTTPS (如果使用Nginx)
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# 查看状态
sudo ufw status
```

## 故障排查

### 服务无法启动

```bash
# 查看详细错误日志
sudo journalctl -u ekp-casdoor-sync -n 100 --no-pager

# 检查端口占用
sudo lsof -i :5233

# 手动运行测试
cd ~/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/SyncEkpToCasdoor.Web/bin/Release/net8.0/publish
dotnet SyncEkpToCasdoor.Web.dll
```

### 数据库连接失败

```bash
# 测试数据库连接
telnet EKP数据库IP 1433

# 检查配置文件
cat ~/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/SyncEkpToCasdoor.Web/appsettings.json
```

### OAuth认证失败

1. 检查Casdoor配置是否正确
2. 确认回调URL已在Casdoor中配置
3. 验证ClientId和ClientSecret

### 无法访问

```bash
# 检查服务是否运行
sudo systemctl status ekp-casdoor-sync

# 检查端口监听
sudo netstat -tulpn | grep 5233

# 测试本地访问
curl http://localhost:5233/login
```

## 性能优化

### 1. 启用生产模式

环境变量已在systemd服务中配置:
```
Environment=ASPNETCORE_ENVIRONMENT=Production
```

### 2. 配置日志级别

编辑 `appsettings.json`:

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  }
}
```

### 3. 数据库连接池

在连接字符串中添加:
```
Min Pool Size=5;Max Pool Size=100;
```

## 监控和维护

### 定期检查

```bash
# 创建监控脚本
cat > ~/check-app.sh << 'EOF'
#!/bin/bash
if ! curl -s http://localhost:5233/login > /dev/null; then
    echo "应用无响应,重启服务..."
    sudo systemctl restart ekp-casdoor-sync
fi
EOF

chmod +x ~/check-app.sh

# 添加到crontab (每5分钟检查一次)
crontab -e
# 添加: */5 * * * * ~/check-app.sh
```

### 日志清理

```bash
# 创建日志清理脚本
cat > ~/cleanup-logs.sh << 'EOF'
#!/bin/bash
LOG_DIR=~/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/SyncEkpToCasdoor.Web/logs
find $LOG_DIR -name "*.log" -mtime +30 -delete
EOF

chmod +x ~/cleanup-logs.sh

# 每周执行一次
crontab -e
# 添加: 0 0 * * 0 ~/cleanup-logs.sh
```

## 安全建议

1. ✅ 使用强密码
2. ✅ 配置SSL/TLS (HTTPS)
3. ✅ 限制数据库访问IP
4. ✅ 定期更新系统和依赖
5. ✅ 配置防火墙规则
6. ✅ 定期备份配置和数据

## 备份和恢复

### 备份配置

```bash
# 创建备份脚本
cat > ~/backup-config.sh << 'EOF'
#!/bin/bash
BACKUP_DIR=~/backups
mkdir -p $BACKUP_DIR
CONFIG_FILE=~/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/SyncEkpToCasdoor.Web/appsettings.json
cp $CONFIG_FILE $BACKUP_DIR/appsettings.json.$(date +%Y%m%d_%H%M%S)
# 只保留最近7天的备份
find $BACKUP_DIR -name "appsettings.json.*" -mtime +7 -delete
EOF

chmod +x ~/backup-config.sh
```

### 恢复配置

```bash
# 列出备份
ls -l ~/backups/

# 恢复特定备份
cp ~/backups/appsettings.json.YYYYMMDD_HHMMSS ~/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/SyncEkpToCasdoor.Web/appsettings.json

# 重启服务
sudo systemctl restart ekp-casdoor-sync
```

## 联系支持

如有问题,请查看:
- 📖 项目文档: https://github.com/myzhangjing/ekp-casdoor-sync
- 🐛 问题反馈: https://github.com/myzhangjing/ekp-casdoor-sync/issues

---

**部署成功后,请访问: http://你的服务器IP:5233/login**
