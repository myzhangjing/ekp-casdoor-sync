# 🚀 远程服务器部署指南

## 服务器信息
- **IP地址**: 172.16.10.110
- **用户名**: root
- **密码**: fzwater@163.com

---

## 📦 部署文件

1. **auto-deploy-server.sh** - Linux部署脚本
2. **deploy-server.bat** - Windows一键部署批处理
3. **quick-deploy-server.ps1** - PowerShell部署脚本

---

## 🎯 部署方式

### 方式1: Windows批处理 (最简单) ⚡

双击运行或命令行执行:
```cmd
.\deploy-server.bat
```

脚本会自动:
1. 上传部署脚本到服务器
2. SSH执行部署
3. 显示结果

**需要输入密码2次**: `fzwater@163.com`

---

### 方式2: PowerShell脚本

```powershell
powershell -ExecutionPolicy Bypass -File quick-deploy-server.ps1
```

按提示输入密码即可。

---

### 方式3: 手动SSH部署

#### 步骤1: 上传脚本
```bash
scp auto-deploy-server.sh root@172.16.10.110:/tmp/auto-deploy.sh
```

#### 步骤2: SSH登录
```bash
ssh root@172.16.10.110
```

#### 步骤3: 执行部署
```bash
chmod +x /tmp/auto-deploy.sh
/tmp/auto-deploy.sh
```

---

## 🔄 部署流程

自动部署脚本会执行以下步骤:

1. ✅ **检查Git** - 如未安装则自动安装
2. ✅ **检查.NET SDK 8.0** - 如未安装则自动安装
3. ✅ **获取代码** - 从GitHub克隆/更新
4. ✅ **编译应用** - Release模式发布
5. ✅ **停止旧服务** - 如果存在
6. ✅ **配置systemd服务** - 自动启动配置
7. ✅ **启动新服务** - 立即启动应用

---

## 🌐 访问应用

部署完成后访问:

```
http://172.16.10.110:5233/login
```

**测试账号**:
- 用户名: admin
- 密码: 123
- 组织: built-in

---

## 🛠️ 服务管理

### 查看状态
```bash
ssh root@172.16.10.110 "systemctl status ekp-casdoor-sync"
```

### 重启服务
```bash
ssh root@172.16.10.110 "systemctl restart ekp-casdoor-sync"
```

### 查看日志
```bash
ssh root@172.16.10.110 "journalctl -u ekp-casdoor-sync -f"
```

### 停止服务
```bash
ssh root@172.16.10.110 "systemctl stop ekp-casdoor-sync"
```

### 启动服务
```bash
ssh root@172.16.10.110 "systemctl start ekp-casdoor-sync"
```

---

## 📝 配置文件

部署后需要配置:

### 1. SSH登录服务器
```bash
ssh root@172.16.10.110
```

### 2. 编辑配置文件
```bash
nano ~/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/SyncEkpToCasdoor.Web/appsettings.json
```

### 3. 修改配置项

```json
{
  "EkpConnection": "Server=你的数据库IP,1433;Database=ecology;User Id=sa;Password=密码;TrustServerCertificate=true",
  
  "CasdoorAuth": {
    "ClientId": "cb838421e04ecd30f72b",
    "ClientSecret": "e54b3c2d06c864ac9243a03b8002b75167dce01d",
    "Authority": "http://sso.fzcsps.com",
    "AllowedOwner": "built-in"
  },
  
  "CasdoorSdk": {
    "Endpoint": "http://sso.fzcsps.com",
    "OrganizationName": "built-in",
    "ApplicationName": "app-ekp-casdoor-sync",
    "ClientId": "cb838421e04ecd30f72b",
    "ClientSecret": "e54b3c2d06c864ac9243a03b8002b75167dce01d"
  },
  
  "TargetCompanyIds": "16f1c1a4910426f41649fd14862b99a1,18e389224b660b4d67413f8466285581",
  
  "ScheduledSync": {
    "Enabled": false,
    "IntervalSeconds": 3600
  }
}
```

### 4. 重启服务使配置生效
```bash
systemctl restart ekp-casdoor-sync
```

---

## 🔍 验证部署

### 1. 检查服务状态
```bash
systemctl status ekp-casdoor-sync
```

应该显示: **active (running)**

### 2. 检查端口监听
```bash
netstat -tulpn | grep 5233
```

应该显示: **LISTEN on 0.0.0.0:5233**

### 3. 测试访问
```bash
curl http://localhost:5233/login
```

应该返回: **HTTP 200 或 302**

### 4. 浏览器测试
打开浏览器访问:
```
http://172.16.10.110:5233/login
```

---

## 🐛 故障排查

### 问题1: SSH连接失败
```
Connection refused 或 Connection timeout
```

**解决**:
- 检查服务器IP是否正确
- 确认服务器SSH服务运行中
- 检查防火墙规则

### 问题2: scp上传失败
```
Permission denied
```

**解决**:
- 确认用户名密码正确
- 检查SSH密钥配置
- 尝试手动SSH登录测试

### 问题3: 服务启动失败
```bash
# 查看详细错误
journalctl -u ekp-casdoor-sync -n 50

# 常见原因:
# - 端口被占用
# - 配置文件错误
# - .NET运行时问题
```

### 问题4: 无法访问应用
```
Connection refused
```

**检查**:
```bash
# 1. 服务是否运行
systemctl status ekp-casdoor-sync

# 2. 端口是否监听
netstat -tulpn | grep 5233

# 3. 防火墙规则
ufw status
ufw allow 5233/tcp

# 4. 查看日志
journalctl -u ekp-casdoor-sync -f
```

---

## 🔄 更新部署

代码更新后,重新运行部署脚本即可:

```cmd
.\deploy-server.bat
```

或手动更新:
```bash
ssh root@172.16.10.110
cd ~/ekp-casdoor-sync
git pull origin web-docker
cd SyncEkpToCasdoor_webdocker/SyncEkpToCasdoor.Web
dotnet publish -c Release -o bin/Release/net8.0/publish
systemctl restart ekp-casdoor-sync
```

---

## 📊 服务器要求

### 最低配置
- **CPU**: 2核
- **内存**: 4GB
- **磁盘**: 20GB
- **系统**: Ubuntu 20.04/22.04 或 Debian 10/11

### 推荐配置
- **CPU**: 4核+
- **内存**: 8GB+
- **磁盘**: 50GB+
- **系统**: Ubuntu 22.04 LTS

---

## 🔐 安全建议

1. ✅ **修改默认密码**
2. ✅ **配置防火墙**
   ```bash
   ufw allow 22/tcp
   ufw allow 5233/tcp
   ufw enable
   ```
3. ✅ **使用SSH密钥认证**
4. ✅ **定期更新系统**
   ```bash
   apt-get update && apt-get upgrade
   ```
5. ✅ **配置Nginx反向代理(推荐)**
6. ✅ **启用HTTPS/SSL**

---

## 📞 获取帮助

### SSH工具下载
- **PuTTY**: https://www.putty.org/
- **Windows Terminal**: Microsoft Store
- **MobaXterm**: https://mobaxterm.mobatek.net/

### 文档
- **项目README**: https://github.com/myzhangjing/ekp-casdoor-sync
- **服务器部署指南**: 本文档

---

## ✅ 部署清单

部署前:
- [ ] 服务器已准备好(172.16.10.110)
- [ ] SSH可以连接
- [ ] 有root权限
- [ ] 本地有SSH工具(Windows自带或PuTTY)

部署中:
- [ ] 上传脚本成功
- [ ] 脚本执行完成
- [ ] 无错误提示

部署后:
- [ ] 服务状态active (running)
- [ ] 可以访问登录页面
- [ ] 配置文件已修改
- [ ] OAuth登录测试通过

---

**🎉 部署完成后访问**: http://172.16.10.110:5233/login
