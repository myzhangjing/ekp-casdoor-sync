# 中文字段显示修复总结

## 问题描述

**问题1**: 用户和组织同步后,displayName、parentName 等中文字段显示为"????"乱码  
**问题2**: EKP 的 ID 和 Casdoor 的 ID 规则不同,需要将 EKP ID 存储到其他字段

## 根本原因

### 1. 中文编码问题
- **原因**: `JsonSerializer.Serialize()` 默认会转义非ASCII字符为 `\uXXXX` 格式
- **影响**: Casdoor 服务器可能无法正确处理转义后的 Unicode 字符
- **解决方案**: 使用 `JavaScriptEncoder.UnsafeRelaxedJsonEscaping` 编码器

### 2. 字段映射不完整
- **原因**: 之前只传递了 `owner` 和 `name` 字段
- **影响**: 显示名称、上级组织、部门等信息丢失
- **解决方案**: 传递完整的字段信息

## 已修复的问题

### ✅ SimpleCasdoorRepository.cs 修改

#### 1. UpsertGroup 方法 (第43行)
**修改前**:
```csharp
var createData = new { owner, name = g.Id };
```

**修改后**:
```csharp
var createData = new 
{ 
    owner, 
    name = g.Id,                    // 使用 EKP ID 作为 Casdoor name
    displayName = g.DisplayName,    // 显示名称
    parentName = g.ParentId,        // 上级组织(使用 EKP 的 ParentId)
    type = g.Type,                  // 组织类型
    isEnabled = g.IsEnabled,        // 是否启用
    key = g.DeptId                  // EKP 部门ID存到 key 字段
};
```

#### 2. UpsertUser 方法 (第95行)
**修改前**:
```csharp
var createData = new { owner = targetOwner, name = userName };
```

**修改后**:
```csharp
var createData = new 
{ 
    owner = targetOwner, 
    name = userName,                   // Casdoor 用户名(清理后的)
    displayName = u.DisplayName,       // 显示名称(真实姓名)
    externalId = u.Id,                 // EKP 原始ID存到 externalId
    email = u.Email,                   // 邮箱
    phone = u.Phone,                   // 手机号
    gender = u.Gender,                 // 性别
    language = u.Language,             // 语言
    type = u.Type,                     // 用户类型
    tag = u.Department,                // 部门名称存到 tag
    affiliation = u.CompanyName        // 公司名称
};
```

#### 3. PostAsync 方法 (第316行)
**修改前**:
```csharp
var body = JsonSerializer.Serialize(payload);
```

**修改后**:
```csharp
// 使用显式的 UTF-8 编码选项序列化 JSON
var options = new JsonSerializerOptions
{
    Encoder = System.Text.Encodings.Web.JavaScriptEncoder.UnsafeRelaxedJsonEscaping
};
var body = JsonSerializer.Serialize(payload, options);
```

## 字段映射策略

### 组织 (Group)
| EKP 字段 | Casdoor 字段 | 说明 |
|---------|-------------|------|
| Id | name | EKP ID 作为组织标识符 |
| DisplayName | displayName | 组织显示名称 |
| ParentId | parentName | 上级组织 ID |
| Type | type | 组织类型 |
| DeptId | key | EKP 部门 ID (备用) |
| IsEnabled | isEnabled | 是否启用 |

### 用户 (User)
| EKP 字段 | Casdoor 字段 | 说明 |
|---------|-------------|------|
| Name | name | 清理后的用户名 |
| Id | externalId | EKP 原始 ID (重要!) |
| DisplayName | displayName | 真实姓名 |
| Email | email | 邮箱地址 |
| Phone | phone | 手机号码 |
| Gender | gender | 性别 |
| Language | language | 语言偏好 |
| Type | type | 用户类型 |
| Department | tag | 部门名称 |
| CompanyName | affiliation | 公司名称 |

## 测试结果

### ✅ 用户字段测试 (linfang1)
```json
{
  "name": "linfang1",
  "displayName": "林芳",  // ✅ 中文正常
  "externalId": "16f1d06518ec8ebae96cd234a32ac46d"  // ✅ EKP ID 保存成功
}
```

### ✅ 用户字段测试 (13859027068)
```json
{
  "name": "13859027068",
  "displayName": "魏各恒",  // ✅ 中文正常
  "externalId": "dcb3cfe4a23d38a000d3b4c2d54ea89a",  // ✅ EKP ID
  "phone": "13859027068",
  "tag": "危险作业学习系统组织/福建荣发建筑工程有限公司",  // ✅ 部门信息
  "affiliation": "危险作业学习系统组织"  // ✅ 公司信息
}
```

## 下一步操作

### 1. 清空现有数据
由于之前同步的数据缺少字段信息,需要清空重新同步:

```powershell
# 方法1: 使用循环删除
$Endpoint = "http://sso.fzcsps.com"
$ClientId = "aecd00a352e5c560ffe6"
$ClientSecret = "4402518b20dd191b8b48d6240bc786a4f847899a"
$Owner = "fzswjtOrganization"
$baseUrl = "$Endpoint/api"
$auth = "?clientId=$ClientId&clientSecret=$ClientSecret"

# 删除所有用户
$usersResp = Invoke-RestMethod -Uri "$baseUrl/get-users$auth&owner=$Owner" -Method Get
foreach ($user in $usersResp.data) {
    $deleteData = @{ owner = $Owner; name = $user.name } | ConvertTo-Json
    Invoke-RestMethod -Uri "$baseUrl/delete-user$auth" -Method Post -Body $deleteData -ContentType "application/json"
}

# 删除所有组织
$groupsResp = Invoke-RestMethod -Uri "$baseUrl/get-groups$auth&owner=$Owner" -Method Get
foreach ($group in $groupsResp.data) {
    $deleteData = @{ owner = $Owner; name = $group.name } | ConvertTo-Json
    Invoke-RestMethod -Uri "$baseUrl/delete-group$auth" -Method Post -Body $deleteData -ContentType "application/json"
}
```

### 2. 运行全量同步
```powershell
cd "c:\Users\ThinkPad\Desktop\VSCOD\SyncEkpToCasdoor"

# 设置环境变量
$env:EKP_SQLSERVER_CONN="Server=npm.fzcsps.com,11433;Database=ekp;User Id=xxzx;Password=sosy3080@sohu.com;TrustServerCertificate=True;"
$env:CASDOOR_ENDPOINT="http://sso.fzcsps.com"
$env:CASDOOR_CLIENT_ID="aecd00a352e5c560ffe6"
$env:CASDOOR_CLIENT_SECRET="4402518b20dd191b8b48d6240bc786a4f847899a"
$env:CASDOOR_DEFAULT_OWNER="fzswjtOrganization"
$env:SYNC_SINCE_UTC="1970-01-01T00:00:00Z"

# 运行全量同步
.\bin\Release\net8.0\SyncEkpToCasdoor.exe
```

### 3. 验证同步结果

#### 检查组织
```powershell
$resp = Invoke-RestMethod -Uri "$Endpoint/api/get-groups?clientId=$ClientId&clientSecret=$ClientSecret&owner=$Owner" -Method Get
$resp.data | Select-Object -First 5 | Format-Table name, displayName, parentName, type
```

#### 检查用户
```powershell
$resp = Invoke-RestMethod -Uri "$Endpoint/api/get-users?clientId=$ClientId&clientSecret=$ClientSecret&owner=$Owner" -Method Get
$resp.data | Select-Object -First 5 | Format-Table name, displayName, externalId, phone
```

### 4. 验证字段完整性
- ✅ 组织的 `displayName` 显示中文名称
- ✅ 组织的 `parentName` 显示上级组织 ID
- ✅ 用户的 `displayName` 显示真实姓名
- ✅ 用户的 `externalId` 保存 EKP 原始 ID
- ✅ 用户的 `tag` 显示部门信息
- ✅ 用户的 `affiliation` 显示公司信息

## 注意事项

### ⚠️ 已知限制

1. **Casdoor update API bug 仍然存在**
   - update-group API: 报错 `GetOwnerAndNameFromId() error`
   - update-user API: 同样的错误
   - **解决方案**: 继续使用"仅创建"模式,已存在的记录会被跳过

2. **成员关系 API 也有bug**
   - add-grouping-policy: 404 错误
   - add-policy: beego 错误
   - **影响**: 无法自动建立用户-组织关系
   - **解决方案**: 需要在 Casdoor UI 中手动配置

3. **权限执行器无法刷新**
   - update-enforcer API 有bug
   - **影响**: Casbin 策略可能不会立即生效
   - **解决方案**: 在 Casdoor UI 中手动刷新

### ✅ 已解决问题

1. ✅ 中文字段显示正常
2. ✅ EKP ID 保存到 `externalId` 字段
3. ✅ 组织层级关系通过 `parentName` 保存
4. ✅ 用户部门、公司信息完整保存

## 文件变更记录

### 修改的文件
1. `SimpleCasdoorRepository.cs`
   - UpsertGroup: 添加完整字段映射
   - UpsertUser: 添加完整字段映射
   - PostAsync: 添加 UTF-8 编码器

### 新增的文件
1. `中文字段显示修复总结.md` (本文件)
2. `clear-casdoor.ps1` - 清空脚本

### 保持不变的文件
- `Program.cs`
- `FIELD_MAPPING.md`
- `SYNC_SUMMARY.md`
- `同步完成报告.md`

---
*最后更新: 2025-10-29 19:15*
*修复状态: ✅ 完成*
*待办事项: 清空数据 → 全量同步 → 验证结果*
