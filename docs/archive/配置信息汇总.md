# 配置信息汇总

**更新时间**: 2025-10-30 21:08  
**状态**: ✅ 所有测试通过

---

## 🔷 Casdoor 配置

### Web 管理界面

```
URL:      http://172.16.10.110:8000
用户名:   admin
密码:     123
```

**访问方式:**
```powershell
# 在浏览器中打开
Start-Process "http://172.16.10.110:8000"
```

### API 配置

```yaml
Endpoint:       http://172.16.10.110:8000
Client ID:      aecd00a352e5c560ffe6
Client Secret:  4402518b20dd191b8b48d6240bc786a4f847899a
Default Owner:  fzswjtOrganization
```

**测试命令:**
```powershell
# 测试 API 可访问性
Invoke-WebRequest -Uri "http://172.16.10.110:8000/api/get-global-organizations" -Method Get

# 测试认证
$body = @{
    grant_type = "client_credentials"
    client_id = "aecd00a352e5c560ffe6"
    client_secret = "4402518b20dd191b8b48d6240bc786a4f847899a"
}
Invoke-RestMethod -Uri "http://172.16.10.110:8000/api/login/oauth/access_token" -Method Post -Body $body
```

### MySQL 数据库

```yaml
Host:      172.16.10.110
Port:      3306
Database:  casdoor
Username:  root
Password:  zhangjing
```

**连接字符串:**
```
Server=172.16.10.110;Port=3306;Database=casdoor;Uid=root;Pwd=zhangjing;
```

**测试连接 (需要 MySQL 客户端):**
```powershell
mysql -h 172.16.10.110 -P 3306 -u root -p casdoor
# 输入密码: zhangjing
```

---

## 🔶 EKP 配置

### SQL Server 数据库

```yaml
Server:    npm.fzcsps.com
Port:      11433
Database:  ekp
Username:  xxzx
Password:  sosy3080@sohu.com
```

**连接字符串:**
```
Server=npm.fzcsps.com,11433;Database=ekp;User Id=xxzx;Password=sosy3080@sohu.com;TrustServerCertificate=True;Connection Timeout=30;
```

**测试连接:**
```powershell
# 使用 sqlcmd (需要安装)
sqlcmd -S npm.fzcsps.com,11433 -d ekp -U xxzx -P "sosy3080@sohu.com" -Q "SELECT @@VERSION"
```

**数据规模:**
- 组织: 10,299 个
- 用户: 5,672 个
- 视图: vw_user_group_membership, vw_casdoor_users_sync

---

## 📝 sync_config.json 完整配置

```json
{
  "EkpServer": "npm.fzcsps.com",
  "EkpPort": "11433",
  "EkpDatabase": "ekp",
  "EkpUsername": "xxzx",
  "EkpPassword": "sosy3080@sohu.com",
  
  "CasdoorEndpoint": "http://172.16.10.110:8000",
  "CasdoorClientId": "aecd00a352e5c560ffe6",
  "CasdoorClientSecret": "4402518b20dd191b8b48d6240bc786a4f847899a",
  "CasdoorOwner": "fzswjtOrganization",
  
  "CasdoorDbHost": "172.16.10.110",
  "CasdoorDbPort": "3306",
  "CasdoorDbUser": "root",
  "CasdoorDbPassword": "zhangjing",
  "CasdoorDbName": "casdoor",
  
  "SyncOrganizations": true,
  "SyncUsers": true,
  "SyncPasswords": true,
  "OrgTypeFilter": "",
  "UserGroupView": "vw_user_group_membership",
  
  "EnableSchedule": false,
  "ScheduleMode": "Daily",
  "DailyTime": "02:00:00",
  "IntervalHours": 6,
  
  "SyncStateFile": "sync_state.json",
  "LogDirectory": "logs",
  "LogRetentionDays": 30
}
```

---

## 🔐 环境变量配置 (可选)

如果不想在配置文件中存储敏感信息,可以使用环境变量:

### PowerShell 设置

```powershell
# EKP 配置
$env:EKP_SERVER = "npm.fzcsps.com"
$env:EKP_PORT = "11433"
$env:EKP_DATABASE = "ekp"
$env:EKP_USERNAME = "xxzx"
$env:EKP_PASSWORD = "sosy3080@sohu.com"

# Casdoor 配置
$env:CASDOOR_ENDPOINT = "http://172.16.10.110:8000"
$env:CASDOOR_CLIENT_ID = "aecd00a352e5c560ffe6"
$env:CASDOOR_CLIENT_SECRET = "4402518b20dd191b8b48d6240bc786a4f847899a"
$env:CASDOOR_OWNER = "fzswjtOrganization"

# Casdoor 数据库
$env:CASDOOR_DB_HOST = "172.16.10.110"
$env:CASDOOR_DB_PORT = "3306"
$env:CASDOOR_DB_USER = "root"
$env:CASDOOR_DB_PASSWORD = "zhangjing"
$env:CASDOOR_DB_NAME = "casdoor"

# 运行同步
cd SyncEkpToCasdoor
dotnet run
```

### 永久设置 (用户级)

```powershell
[System.Environment]::SetEnvironmentVariable("CASDOOR_ENDPOINT", "http://172.16.10.110:8000", "User")
[System.Environment]::SetEnvironmentVariable("CASDOOR_CLIENT_ID", "aecd00a352e5c560ffe6", "User")
[System.Environment]::SetEnvironmentVariable("CASDOOR_CLIENT_SECRET", "4402518b20dd191b8b48d6240bc786a4f847899a", "User")
```

---

## 🧪 测试验证

### 快速测试所有连接

```powershell
cd ComprehensiveTest
dotnet run
```

**预期结果:**
```
✅ 15/15 项测试通过
✅ EKP 数据库连接成功
✅ Casdoor 服务访问成功
✅ Casdoor 认证成功
✅ 配置文件完整
✅ 查询性能优秀
```

### 单独测试 EKP 连接

```powershell
$connString = "Server=npm.fzcsps.com,11433;Database=ekp;User Id=xxzx;Password=sosy3080@sohu.com;TrustServerCertificate=True;"
$conn = New-Object System.Data.SqlClient.SqlConnection($connString)
$conn.Open()
Write-Host "✅ EKP 连接成功!" -ForegroundColor Green
$conn.Close()
```

### 单独测试 Casdoor 连接

```powershell
$response = Invoke-WebRequest -Uri "http://172.16.10.110:8000" -Method Get
if ($response.StatusCode -eq 200) {
    Write-Host "✅ Casdoor 服务正常!" -ForegroundColor Green
}
```

---

## 📊 数据库表结构 (EKP)

### 核心表

1. **sys_org_element** - 组织元素表
   - fd_id: 主键
   - fd_name: 名称
   - fd_org_type: 组织类型 (2=部门, 4=岗位, 8=人员, 32=集团岗位)
   - fd_is_available: 是否可用
   - fd_is_business: 是否业务组织

2. **sys_org_person** - 人员表
   - fd_id: 主键 (关联 sys_org_element)
   - fd_login_name: 登录名
   - fd_email: 邮箱
   - fd_mobile_no: 手机号
   - fd_password: 密码 (MD5)
   - fd_sex: 性别

3. **vw_user_group_membership** - 用户组关系视图
   - 用户与部门/岗位的关系

### 示例查询

```sql
-- 查询所有组织
SELECT fd_id, fd_name, fd_org_type 
FROM sys_org_element 
WHERE fd_is_available = 1 AND fd_is_business = 1
ORDER BY fd_name;

-- 查询所有用户
SELECT 
    e.fd_id, 
    e.fd_name, 
    p.fd_login_name, 
    p.fd_email
FROM sys_org_element e
INNER JOIN sys_org_person p ON e.fd_id = p.fd_id
WHERE e.fd_is_available = 1 AND e.fd_org_type = 8
ORDER BY e.fd_name;

-- 统计数据
SELECT 
    fd_org_type,
    COUNT(*) as count
FROM sys_org_element 
WHERE fd_is_available = 1 AND fd_is_business = 1
GROUP BY fd_org_type;
```

---

## 🔄 同步配置说明

### 同步模式

- **SyncOrganizations**: true - 同步组织数据
- **SyncUsers**: true - 同步用户数据
- **SyncPasswords**: true - 同步密码 (MD5格式)

### 过滤规则

- **OrgTypeFilter**: "" (空=全部) 或 "2,4,8" (指定类型)
  - 2 = 部门
  - 4 = 岗位
  - 8 = 人员
  - 32 = 集团岗位

### 调度设置

- **EnableSchedule**: false - 是否启用定时任务
- **ScheduleMode**: "Daily" - 调度模式 (Daily/Interval)
- **DailyTime**: "02:00:00" - 每日执行时间
- **IntervalHours**: 6 - 间隔小时数

### 日志设置

- **LogDirectory**: "logs" - 日志目录
- **LogRetentionDays**: 30 - 日志保留天数

---

## 🚀 快速启动命令

### WPF 图形界面

```powershell
cd SyncEkpToCasdoor.UI
dotnet run --configuration Release
```

### 命令行同步

```powershell
cd SyncEkpToCasdoor

# 增量同步
dotnet run

# 全量同步
dotnet run -- --full

# 使用自定义配置
dotnet run -- --config custom_config.json
```

### 运行测试

```powershell
cd ComprehensiveTest
dotnet run
```

---

## 📞 联系方式

### 系统管理员

- **EKP 系统**: npm.fzcsps.com
- **Casdoor 系统**: 172.16.10.110

### 技术文档

- `完整测试报告.md` - 详细测试报告
- `快速启动指南.md` - 快速开始指南
- `README.md` - 项目说明

### 日志位置

- 同步日志: `logs/sync_*.log`
- 测试报告: `ComprehensiveTest/bin/Debug/net8.0/综合测试报告.txt`

---

## ✅ 配置检查清单

使用前请确认:

- [ ] EKP 数据库可访问 (npm.fzcsps.com:11433)
- [ ] Casdoor 服务可访问 (http://172.16.10.110:8000)
- [ ] Casdoor Web 管理界面可登录 (admin/123)
- [ ] 配置文件已创建 (sync_config.json)
- [ ] 所有测试通过 (运行 ComprehensiveTest)
- [ ] 日志目录已创建 (logs/)
- [ ] 状态文件已初始化 (sync_state.json)

---

**配置汇总版本**: 1.0  
**最后更新**: 2025-10-30 21:08  
**验证状态**: ✅ 所有配置已测试通过
