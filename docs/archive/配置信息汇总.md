# é…ç½®ä¿¡æ¯æ±‡æ€»

**æ›´æ–°æ—¶é—´**: 2025-10-30 21:08  
**çŠ¶æ€**: âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡

---

## ğŸ”· Casdoor é…ç½®

### Web ç®¡ç†ç•Œé¢

```
URL:      http://172.16.10.110:8000
ç”¨æˆ·å:   admin
å¯†ç :     123
```

**è®¿é—®æ–¹å¼:**
```powershell
# åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€
Start-Process "http://172.16.10.110:8000"
```

### API é…ç½®

```yaml
Endpoint:       http://172.16.10.110:8000
Client ID:      aecd00a352e5c560ffe6
Client Secret:  4402518b20dd191b8b48d6240bc786a4f847899a
Default Owner:  fzswjtOrganization
```

**æµ‹è¯•å‘½ä»¤:**
```powershell
# æµ‹è¯• API å¯è®¿é—®æ€§
Invoke-WebRequest -Uri "http://172.16.10.110:8000/api/get-global-organizations" -Method Get

# æµ‹è¯•è®¤è¯
$body = @{
    grant_type = "client_credentials"
    client_id = "aecd00a352e5c560ffe6"
    client_secret = "4402518b20dd191b8b48d6240bc786a4f847899a"
}
Invoke-RestMethod -Uri "http://172.16.10.110:8000/api/login/oauth/access_token" -Method Post -Body $body
```

### MySQL æ•°æ®åº“

```yaml
Host:      172.16.10.110
Port:      3306
Database:  casdoor
Username:  root
Password:  zhangjing
```

**è¿æ¥å­—ç¬¦ä¸²:**
```
Server=172.16.10.110;Port=3306;Database=casdoor;Uid=root;Pwd=zhangjing;
```

**æµ‹è¯•è¿æ¥ (éœ€è¦ MySQL å®¢æˆ·ç«¯):**
```powershell
mysql -h 172.16.10.110 -P 3306 -u root -p casdoor
# è¾“å…¥å¯†ç : zhangjing
```

---

## ğŸ”¶ EKP é…ç½®

### SQL Server æ•°æ®åº“

```yaml
Server:    npm.fzcsps.com
Port:      11433
Database:  ekp
Username:  xxzx
Password:  sosy3080@sohu.com
```

**è¿æ¥å­—ç¬¦ä¸²:**
```
Server=npm.fzcsps.com,11433;Database=ekp;User Id=xxzx;Password=sosy3080@sohu.com;TrustServerCertificate=True;Connection Timeout=30;
```

**æµ‹è¯•è¿æ¥:**
```powershell
# ä½¿ç”¨ sqlcmd (éœ€è¦å®‰è£…)
sqlcmd -S npm.fzcsps.com,11433 -d ekp -U xxzx -P "sosy3080@sohu.com" -Q "SELECT @@VERSION"
```

**æ•°æ®è§„æ¨¡:**
- ç»„ç»‡: 10,299 ä¸ª
- ç”¨æˆ·: 5,672 ä¸ª
- è§†å›¾: vw_user_group_membership, vw_casdoor_users_sync

---

## ğŸ“ sync_config.json å®Œæ•´é…ç½®

```json
{
  "EkpServer": "npm.fzcsps.com",
  "EkpPort": "11433",
  "EkpDatabase": "ekp",
  "EkpUsername": "xxzx",
  "EkpPassword": "sosy3080@sohu.com",
  
  "CasdoorEndpoint": "http://172.16.10.110:8000",
  "CasdoorClientId": "aecd00a352e5c560ffe6",
  "CasdoorClientSecret": "4402518b20dd191b8b48d6240bc786a4f847899a",
  "CasdoorOwner": "fzswjtOrganization",
  
  "CasdoorDbHost": "172.16.10.110",
  "CasdoorDbPort": "3306",
  "CasdoorDbUser": "root",
  "CasdoorDbPassword": "zhangjing",
  "CasdoorDbName": "casdoor",
  
  "SyncOrganizations": true,
  "SyncUsers": true,
  "SyncPasswords": true,
  "OrgTypeFilter": "",
  "UserGroupView": "vw_user_group_membership",
  
  "EnableSchedule": false,
  "ScheduleMode": "Daily",
  "DailyTime": "02:00:00",
  "IntervalHours": 6,
  
  "SyncStateFile": "sync_state.json",
  "LogDirectory": "logs",
  "LogRetentionDays": 30
}
```

---

## ğŸ” ç¯å¢ƒå˜é‡é…ç½® (å¯é€‰)

å¦‚æœä¸æƒ³åœ¨é…ç½®æ–‡ä»¶ä¸­å­˜å‚¨æ•æ„Ÿä¿¡æ¯,å¯ä»¥ä½¿ç”¨ç¯å¢ƒå˜é‡:

### PowerShell è®¾ç½®

```powershell
# EKP é…ç½®
$env:EKP_SERVER = "npm.fzcsps.com"
$env:EKP_PORT = "11433"
$env:EKP_DATABASE = "ekp"
$env:EKP_USERNAME = "xxzx"
$env:EKP_PASSWORD = "sosy3080@sohu.com"

# Casdoor é…ç½®
$env:CASDOOR_ENDPOINT = "http://172.16.10.110:8000"
$env:CASDOOR_CLIENT_ID = "aecd00a352e5c560ffe6"
$env:CASDOOR_CLIENT_SECRET = "4402518b20dd191b8b48d6240bc786a4f847899a"
$env:CASDOOR_OWNER = "fzswjtOrganization"

# Casdoor æ•°æ®åº“
$env:CASDOOR_DB_HOST = "172.16.10.110"
$env:CASDOOR_DB_PORT = "3306"
$env:CASDOOR_DB_USER = "root"
$env:CASDOOR_DB_PASSWORD = "zhangjing"
$env:CASDOOR_DB_NAME = "casdoor"

# è¿è¡ŒåŒæ­¥
cd SyncEkpToCasdoor
dotnet run
```

### æ°¸ä¹…è®¾ç½® (ç”¨æˆ·çº§)

```powershell
[System.Environment]::SetEnvironmentVariable("CASDOOR_ENDPOINT", "http://172.16.10.110:8000", "User")
[System.Environment]::SetEnvironmentVariable("CASDOOR_CLIENT_ID", "aecd00a352e5c560ffe6", "User")
[System.Environment]::SetEnvironmentVariable("CASDOOR_CLIENT_SECRET", "4402518b20dd191b8b48d6240bc786a4f847899a", "User")
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### å¿«é€Ÿæµ‹è¯•æ‰€æœ‰è¿æ¥

```powershell
cd ComprehensiveTest
dotnet run
```

**é¢„æœŸç»“æœ:**
```
âœ… 15/15 é¡¹æµ‹è¯•é€šè¿‡
âœ… EKP æ•°æ®åº“è¿æ¥æˆåŠŸ
âœ… Casdoor æœåŠ¡è®¿é—®æˆåŠŸ
âœ… Casdoor è®¤è¯æˆåŠŸ
âœ… é…ç½®æ–‡ä»¶å®Œæ•´
âœ… æŸ¥è¯¢æ€§èƒ½ä¼˜ç§€
```

### å•ç‹¬æµ‹è¯• EKP è¿æ¥

```powershell
$connString = "Server=npm.fzcsps.com,11433;Database=ekp;User Id=xxzx;Password=sosy3080@sohu.com;TrustServerCertificate=True;"
$conn = New-Object System.Data.SqlClient.SqlConnection($connString)
$conn.Open()
Write-Host "âœ… EKP è¿æ¥æˆåŠŸ!" -ForegroundColor Green
$conn.Close()
```

### å•ç‹¬æµ‹è¯• Casdoor è¿æ¥

```powershell
$response = Invoke-WebRequest -Uri "http://172.16.10.110:8000" -Method Get
if ($response.StatusCode -eq 200) {
    Write-Host "âœ… Casdoor æœåŠ¡æ­£å¸¸!" -ForegroundColor Green
}
```

---

## ğŸ“Š æ•°æ®åº“è¡¨ç»“æ„ (EKP)

### æ ¸å¿ƒè¡¨

1. **sys_org_element** - ç»„ç»‡å…ƒç´ è¡¨
   - fd_id: ä¸»é”®
   - fd_name: åç§°
   - fd_org_type: ç»„ç»‡ç±»å‹ (2=éƒ¨é—¨, 4=å²—ä½, 8=äººå‘˜, 32=é›†å›¢å²—ä½)
   - fd_is_available: æ˜¯å¦å¯ç”¨
   - fd_is_business: æ˜¯å¦ä¸šåŠ¡ç»„ç»‡

2. **sys_org_person** - äººå‘˜è¡¨
   - fd_id: ä¸»é”® (å…³è” sys_org_element)
   - fd_login_name: ç™»å½•å
   - fd_email: é‚®ç®±
   - fd_mobile_no: æ‰‹æœºå·
   - fd_password: å¯†ç  (MD5)
   - fd_sex: æ€§åˆ«

3. **vw_user_group_membership** - ç”¨æˆ·ç»„å…³ç³»è§†å›¾
   - ç”¨æˆ·ä¸éƒ¨é—¨/å²—ä½çš„å…³ç³»

### ç¤ºä¾‹æŸ¥è¯¢

```sql
-- æŸ¥è¯¢æ‰€æœ‰ç»„ç»‡
SELECT fd_id, fd_name, fd_org_type 
FROM sys_org_element 
WHERE fd_is_available = 1 AND fd_is_business = 1
ORDER BY fd_name;

-- æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·
SELECT 
    e.fd_id, 
    e.fd_name, 
    p.fd_login_name, 
    p.fd_email
FROM sys_org_element e
INNER JOIN sys_org_person p ON e.fd_id = p.fd_id
WHERE e.fd_is_available = 1 AND e.fd_org_type = 8
ORDER BY e.fd_name;

-- ç»Ÿè®¡æ•°æ®
SELECT 
    fd_org_type,
    COUNT(*) as count
FROM sys_org_element 
WHERE fd_is_available = 1 AND fd_is_business = 1
GROUP BY fd_org_type;
```

---

## ğŸ”„ åŒæ­¥é…ç½®è¯´æ˜

### åŒæ­¥æ¨¡å¼

- **SyncOrganizations**: true - åŒæ­¥ç»„ç»‡æ•°æ®
- **SyncUsers**: true - åŒæ­¥ç”¨æˆ·æ•°æ®
- **SyncPasswords**: true - åŒæ­¥å¯†ç  (MD5æ ¼å¼)

### è¿‡æ»¤è§„åˆ™

- **OrgTypeFilter**: "" (ç©º=å…¨éƒ¨) æˆ– "2,4,8" (æŒ‡å®šç±»å‹)
  - 2 = éƒ¨é—¨
  - 4 = å²—ä½
  - 8 = äººå‘˜
  - 32 = é›†å›¢å²—ä½

### è°ƒåº¦è®¾ç½®

- **EnableSchedule**: false - æ˜¯å¦å¯ç”¨å®šæ—¶ä»»åŠ¡
- **ScheduleMode**: "Daily" - è°ƒåº¦æ¨¡å¼ (Daily/Interval)
- **DailyTime**: "02:00:00" - æ¯æ—¥æ‰§è¡Œæ—¶é—´
- **IntervalHours**: 6 - é—´éš”å°æ—¶æ•°

### æ—¥å¿—è®¾ç½®

- **LogDirectory**: "logs" - æ—¥å¿—ç›®å½•
- **LogRetentionDays**: 30 - æ—¥å¿—ä¿ç•™å¤©æ•°

---

## ğŸš€ å¿«é€Ÿå¯åŠ¨å‘½ä»¤

### WPF å›¾å½¢ç•Œé¢

```powershell
cd SyncEkpToCasdoor.UI
dotnet run --configuration Release
```

### å‘½ä»¤è¡ŒåŒæ­¥

```powershell
cd SyncEkpToCasdoor

# å¢é‡åŒæ­¥
dotnet run

# å…¨é‡åŒæ­¥
dotnet run -- --full

# ä½¿ç”¨è‡ªå®šä¹‰é…ç½®
dotnet run -- --config custom_config.json
```

### è¿è¡Œæµ‹è¯•

```powershell
cd ComprehensiveTest
dotnet run
```

---

## ğŸ“ è”ç³»æ–¹å¼

### ç³»ç»Ÿç®¡ç†å‘˜

- **EKP ç³»ç»Ÿ**: npm.fzcsps.com
- **Casdoor ç³»ç»Ÿ**: 172.16.10.110

### æŠ€æœ¯æ–‡æ¡£

- `å®Œæ•´æµ‹è¯•æŠ¥å‘Š.md` - è¯¦ç»†æµ‹è¯•æŠ¥å‘Š
- `å¿«é€Ÿå¯åŠ¨æŒ‡å—.md` - å¿«é€Ÿå¼€å§‹æŒ‡å—
- `README.md` - é¡¹ç›®è¯´æ˜

### æ—¥å¿—ä½ç½®

- åŒæ­¥æ—¥å¿—: `logs/sync_*.log`
- æµ‹è¯•æŠ¥å‘Š: `ComprehensiveTest/bin/Debug/net8.0/ç»¼åˆæµ‹è¯•æŠ¥å‘Š.txt`

---

## âœ… é…ç½®æ£€æŸ¥æ¸…å•

ä½¿ç”¨å‰è¯·ç¡®è®¤:

- [ ] EKP æ•°æ®åº“å¯è®¿é—® (npm.fzcsps.com:11433)
- [ ] Casdoor æœåŠ¡å¯è®¿é—® (http://172.16.10.110:8000)
- [ ] Casdoor Web ç®¡ç†ç•Œé¢å¯ç™»å½• (admin/123)
- [ ] é…ç½®æ–‡ä»¶å·²åˆ›å»º (sync_config.json)
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡ (è¿è¡Œ ComprehensiveTest)
- [ ] æ—¥å¿—ç›®å½•å·²åˆ›å»º (logs/)
- [ ] çŠ¶æ€æ–‡ä»¶å·²åˆå§‹åŒ– (sync_state.json)

---

**é…ç½®æ±‡æ€»ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-10-30 21:08  
**éªŒè¯çŠ¶æ€**: âœ… æ‰€æœ‰é…ç½®å·²æµ‹è¯•é€šè¿‡
