# EKP-Casdoor 同步系统改进计划

## 改进概述
本次改进将系统从命令行工具升级为具有图形界面的企业级同步解决方案。

## 1. MD5密码同步 ✓
- **目标**: 将EKP的MD5密码字段同步到Casdoor
- **实施**: 
  - 在EkpUser模型添加Password字段
  - 修改视图包含fd_password
  - Casdoor API支持password字段

## 2. 配置管理系统
### 2.1 配置数据模型
```csharp
- ConnectionSettings: 数据库/API连接配置
- SyncRules: 同步规则(时间范围、过滤条件)
- FieldMapping: 字段映射配置
- ScheduleConfig: 定时同步配置
```

### 2.2 配置UI (WPF)
```
主窗口
├── 连接配置页
│   ├── EKP数据库配置
│   ├── Casdoor API配置
│   └── 连接测试按钮
├── 同步规则页
│   ├── 时间范围选择器
│   ├── 过滤条件编辑器
│   ├── 字段映射表格
│   └── 规则预览
├── 同步监控页
│   ├── 实时进度条
│   ├── 日志输出窗口
│   ├── 统计信息面板
│   └── 操作按钮(开始/停止/暂停)
└── 定时任务页
    ├── Cron表达式编辑器
    ├── 任务历史记录
    └── 下次执行时间预览
```

## 3. 可配置项清单
### 3.1 连接配置
- EKP SQL Server (服务器/端口/数据库/认证)
- Casdoor API (端点/ClientID/Secret/Owner)
- 连接池配置
- 超时设置

### 3.2 同步规则
- 时间范围 (增量/全量/自定义时间段)
- 组织过滤 (指定公司/部门ID)
- 用户过滤 (状态/类型/自定义SQL)
- 同步方向 (单向/双向)
- 冲突解决策略

### 3.3 字段映射
- 用户字段映射 (EKP -> Casdoor)
- 组织字段映射
- 自定义字段扩展
- 数据转换规则 (格式化/默认值)

### 3.4 性能配置
- 批量大小
- 并发线程数
- 重试策略
- 缓存配置

### 3.5 通知配置
- 邮件通知
- 企业微信/钉钉
- 日志级别
- 错误告警阈值

## 4. 实时状态显示
### 4.1 进度指标
- 总进度百分比
- 当前阶段 (组织/用户/成员关系)
- 成功/失败/跳过计数
- 剩余时间估算

### 4.2 日志系统
- 实时控制台输出
- 结构化日志存储
- 日志级别过滤
- 导出功能

### 4.3 性能监控
- 同步速度 (条/秒)
- 网络延迟
- 数据库查询时间
- API响应时间

## 5. EKP视图优化
### 5.1 用户视图增强
```sql
vw_user_sync_complete:
- 基础信息 (姓名/账号/邮箱/手机)
- 密码 (MD5)
- 组织关系 (部门/公司/岗位)
- 扩展信息 (入职日期/证件/领导)
- 状态标记 (可用/激活/可登录)
```

### 5.2 组织视图增强
```sql
vw_org_sync_complete:
- 递归层级结构
- 完整路径
- 人员数量统计
- 负责人信息
- 自定义属性
```

### 5.3 成员关系视图
```sql
vw_user_org_membership:
- 用户ID
- 组织ID (支持多部门)
- 主副部门标记
- 生效/失效时间
```

## 实施步骤
1. [x] 分析EKP数据库表结构
2. [ ] 添加MD5密码同步
3. [ ] 创建配置数据模型
4. [ ] 构建WPF配置UI
5. [ ] 实现进度推送机制
6. [ ] 优化EKP视图
7. [ ] 集成测试
8. [ ] 文档更新

## 技术栈
- **后端**: .NET 8 / C# 12
- **UI**: WPF (MVVM模式)
- **配置**: JSON / 加密存储
- **日志**: Serilog
- **调度**: Quartz.NET (可选)
