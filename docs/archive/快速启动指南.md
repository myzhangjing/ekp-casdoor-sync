# 🚀 EKP-Casdoor 同步工具 - 快速启动指南

## ✅ 系统状态

**所有测试通过！系统就绪！**

- ✅ 15/15 项自动化测试全部通过
- ✅ 成功率: 100%
- ✅ EKP 数据源: 10,299个组织 + 5,672个用户
- ✅ Casdoor 目标系统: 连接正常
- ✅ 历史同步记录: 78次

---

## 🎯 三种使用方式

### 方式 1: WPF 图形界面 (推荐)

```powershell
cd SyncEkpToCasdoor.UI
dotnet run --configuration Release
```

**功能:**
- 🎨 美观的 MaterialDesign 界面
- ⚙️ 可视化配置管理
- 📊 实时同步监控
- 📈 数据查看和对比
- 📝 日志查看器

### 方式 2: 命令行同步

```powershell
cd SyncEkpToCasdoor

# 增量同步 (推荐日常使用)
dotnet run

# 全量同步 (首次或数据重建)
dotnet run -- --full
```

### 方式 3: 编译后执行

```powershell
cd SyncEkpToCasdoor
dotnet build --configuration Release
.\bin\Release\net8.0\SyncEkpToCasdoor.exe
```

---

## 📋 首次使用步骤

### Step 1: 验证配置 ✅

配置文件已准备好: `sync_config.json`

```json
{
  "EkpServer": "npm.fzcsps.com",
  "EkpPort": "11433",
  "EkpDatabase": "ekp",
  "CasdoorEndpoint": "http://172.16.10.110:8000",
  "CasdoorClientId": "aecd00a352e5c560ffe6",
  "SyncOrganizations": true,
  "SyncUsers": true,
  "SyncPasswords": true
}
```

### Step 2: 启动 WPF 应用

```powershell
cd SyncEkpToCasdoor.UI
dotnet run
```

### Step 3: 测试连接

在 WPF 应用的"配置"标签页:
1. 点击"测试 EKP 连接" - 应显示✅成功
2. 点击"测试 Casdoor 连接" - 应显示✅成功

### Step 4: 查看数据 (可选)

在"数据查看"标签页:
- 查看 EKP 的 10,299个组织
- 查看 EKP 的 5,672个用户
- 对比 Casdoor 现有数据

### Step 5: 执行同步

在"执行同步"标签页:
1. 首次使用选择"全量同步"
2. 点击"开始同步"
3. 实时查看进度和日志

---

## ⚡ 快速命令

### 查看状态

```powershell
# 查看最新日志
Get-Content logs\sync_*.log -Tail 50

# 查看同步状态
Get-Content sync_state.json | ConvertFrom-Json

# 查看配置
Get-Content sync_config.json | ConvertFrom-Json
```

### 运行测试

```powershell
# 运行综合测试
cd ComprehensiveTest
dotnet run
```

### 清理重置

```powershell
# 清空同步状态 (重新全量同步)
Remove-Item sync_state.json
echo '{"LastSyncTime":null}' > sync_state.json
```

---

## 📊 预期结果

### 首次全量同步

- **数据量**: ~31,000条记录
- **预计时间**: 20-35分钟
- **组织**: 10,299条
- **用户**: 5,672条
- **关系**: ~15,000条

### 日常增量同步

- **频率**: 建议每天1-2次
- **时间**: 通常 <5分钟
- **内容**: 仅同步变更数据

---

## ⚠️ 重要提醒

### 生产使用前

1. ✅ **已完成**: 所有测试通过
2. ⚠️ **建议**: 在测试环境先验证完整同步流程
3. ⚠️ **必须**: 备份 Casdoor 数据库
4. 💡 **推荐**: 在业务低峰期执行首次同步
5. 💡 **推荐**: 使用 DPAPI 加密密码(WPF应用自动处理)

### 监控要点

- 📝 定期检查日志文件: `logs/sync_*.log`
- 📊 监控同步状态: `sync_state.json`
- ⚠️ 关注错误信息
- 📈 验证数据一致性

---

## 🎓 配置说明

### EKP 数据源

```yaml
服务器: npm.fzcsps.com:11433
数据库: ekp
用户: xxzx
密码: sosy3080@sohu.com (测试配置为明文)
状态: ✅ 连接正常
数据: 10,299组织 + 5,672用户
性能: ⚡ 优秀 (19ms查询)
```

### Casdoor 目标系统

```yaml
Web界面: http://172.16.10.110:8000
管理账号: admin / 123

API配置:
  Endpoint: http://172.16.10.110:8000
  Client ID: aecd00a352e5c560ffe6
  Client Secret: 4402518b20dd191b8b48d6240bc786a4f847899a
  Owner: fzswjtOrganization

数据库(可选):
  Host: 172.16.10.110:3306
  Database: casdoor
  User: root
  Password: zhangjing
```

---

## 🔧 故障排除

### 问题: 连接失败

```powershell
# 1. 测试网络连接
Test-NetConnection npm.fzcsps.com -Port 11433
Test-NetConnection 172.16.10.110 -Port 8000

# 2. 检查配置文件
Get-Content sync_config.json

# 3. 运行测试程序
cd ComprehensiveTest
dotnet run
```

### 问题: 同步卡住

```powershell
# 1. 查看日志
Get-Content logs\sync_*.log -Tail 100

# 2. 检查进程
Get-Process | Where-Object {$_.ProcessName -like "*Sync*"}

# 3. 重启同步
# 按 Ctrl+C 停止，然后重新运行
```

### 问题: 数据不一致

```powershell
# 执行全量同步
cd SyncEkpToCasdoor
dotnet run -- --full

# 或在 WPF 应用中选择"全量同步"
```

---

## 📞 获取帮助

### 文档

- 📄 完整测试报告: `完整测试报告.md`
- 📄 配置示例: `sync_config.json`
- 📄 测试结果: `ComprehensiveTest/bin/Debug/net8.0/综合测试报告.txt`

### 日志位置

- 📁 同步日志: `logs/sync_*.log`
- 📄 状态文件: `sync_state.json`

### 运行测试

```powershell
# 完整测试套件
cd ComprehensiveTest
dotnet run

# 查看测试报告
Get-Content bin\Debug\net8.0\综合测试报告.txt
```

---

## 🎉 开始使用

```powershell
# 启动 WPF 应用 (推荐)
cd SyncEkpToCasdoor.UI
dotnet run --configuration Release
```

**系统已就绪！开始使用吧！** 🚀

---

**快速指南版本**: 1.0  
**更新时间**: 2025-10-30 21:08  
**系统状态**: ✅ 完全就绪
