# 定时同步任务快速监控指南

## ✅ 问题：如何知道每天 1:07 的定时同步任务有没有执行？

---

## 🚀 快速检查方法

### 方法 1：运行监控脚本（推荐）⭐

```powershell
cd C:\Users\ThinkPad\Desktop\VSCOD
PowerShell -ExecutionPolicy Bypass -File ".\scripts\check-sync-status.ps1"
```

**一键查看**：
- ✅ 最后执行时间
- ✅ 同步是否成功  
- ✅ 日志文件内容
- ✅ 计划任务状态
- ✅ 环境变量配置

---

### 方法 2：查看状态文件（最快）⚡

查看 `sync_state.json` 中的 `LastRunUtc` 字段：

```powershell
# 查看 JSON 文件
Get-Content C:\Users\ThinkPad\Desktop\VSCOD\SyncEkpToCasdoor\sync_state.json

# 转换为本地时间
$state = Get-Content C:\Users\ThinkPad\Desktop\VSCOD\SyncEkpToCasdoor\sync_state.json | ConvertFrom-Json
[DateTime]::Parse($state.LastRunUtc).ToLocalTime()
```

**示例输出**：
```json
{
  "LastRunUtc": "2025-10-30T17:09:13.9457098Z"  ← UTC 时间
}
```

转换为本地时间：`2025-10-31 01:09:13`（北京时间 = UTC + 8 小时）

**判断标准**：
- ✅ `LastRunUtc` 在今天 1:07 左右 → 执行成功
- ❌ `LastRunUtc` 还是昨天或更早 → 未执行（可能出问题了）

---

### 方法 3：检查日志文件

```powershell
# 进入日志目录
cd C:\Users\ThinkPad\Desktop\VSCOD\logs

# 查看今天的日志
Get-ChildItem sync_*.log | Where-Object { $_.LastWriteTime.Date -eq (Get-Date).Date }

# 查看最新日志的最后 50 行
Get-Content (Get-ChildItem sync_*.log | Sort-Object LastWriteTime -Descending | Select-Object -First 1).FullName -Tail 50
```

**关键标识**：
- ✅ `"同步流程结束，检查点已写入"` → 成功
- ✅ `"组织同步完成，共处理 XXX 条记录"` → 成功
- ❌ `"同步失败"` 或 `"错误"` → 失败

---

### 方法 4：查看 Windows 计划任务

```powershell
# 查看任务信息
Get-ScheduledTask -TaskName "EKP-Casdoor-DailySync" | Get-ScheduledTaskInfo

# 查看上次运行时间和结果
$task = Get-ScheduledTaskInfo -TaskName "EKP-Casdoor-DailySync"
Write-Host "上次运行: $($task.LastRunTime)"
Write-Host "下次运行: $($task.NextRunTime)"  
Write-Host "运行结果: $($task.LastTaskResult)"  # 0 = 成功
```

**或者使用 GUI**：
1. 按 `Win + R`，输入 `taskschd.msc`
2. 找到任务 `EKP-Casdoor-DailySync`
3. 查看 **上次运行时间** 和 **上次运行结果**
4. 点击 **历史记录** 标签查看详细日志

---

## 📊 判断标准对照表

| 检查项 | 正常 | 异常 |
|--------|------|------|
| **LastRunUtc** | 今天 1:07 左右 | 昨天或更早 |
| **任务状态** | `Ready` | `Disabled` |
| **上次结果** | `0x0` (成功) | 非 0 值 |
| **日志文件** | 今天有新日志 | 没有今天的日志 |
| **日志内容** | "同步流程结束" | "同步失败" |

---

## 🔧 如果没有执行怎么办？

### 1. 检查计划任务是否启用

```powershell
# 查看状态
Get-ScheduledTask -TaskName "EKP-Casdoor-DailySync" | Select-Object State

# 如果是 Disabled，启用它
Enable-ScheduledTask -TaskName "EKP-Casdoor-DailySync"
```

### 2. 手动运行一次测试

```powershell
# 手动触发计划任务
Start-ScheduledTask -TaskName "EKP-Casdoor-DailySync"

# 等待几秒后查看结果
Start-Sleep -Seconds 30
Get-ScheduledTaskInfo -TaskName "EKP-Casdoor-DailySync"
```

### 3. 查看错误日志

```powershell
# 查看最新的日志
$latestLog = Get-ChildItem C:\Users\ThinkPad\Desktop\VSCOD\logs\sync_*.log | 
             Sort-Object LastWriteTime -Descending | 
             Select-Object -First 1

Get-Content $latestLog.FullName -Tail 100
```

### 4. 检查环境变量

定时任务需要系统级环境变量：

```powershell
# 检查必需的环境变量
[Environment]::GetEnvironmentVariable("EKP_SQLSERVER_CONN", "Machine")
[Environment]::GetEnvironmentVariable("CASDOOR_ENDPOINT", "Machine")
[Environment]::GetEnvironmentVariable("CASDOOR_CLIENT_ID", "Machine")
[Environment]::GetEnvironmentVariable("CASDOOR_CLIENT_SECRET", "Machine")
[Environment]::GetEnvironmentVariable("CASDOOR_DEFAULT_OWNER", "Machine")
```

如果为空，需要在**系统环境变量**中配置（不是用户环境变量）。

---

## 📧 设置邮件告警（可选）

如果想在同步失败时自动收到邮件，可以在 `scripts\run-sync.ps1` 末尾添加告警逻辑：

```powershell
# 在 run-sync.ps1 末尾添加
if ($process.ExitCode -ne 0) {
    Send-MailMessage `
        -From "sync@example.com" `
        -To "admin@example.com" `
        -Subject "EKP-Casdoor 同步失败告警" `
        -Body "同步任务执行失败，请查看日志: $logFile" `
        -SmtpServer "smtp.example.com" `
        -Port 587 `
        -Credential (Get-Credential) `
        -UseSsl
}
```

---

## 📝 每日检查清单

**建议每天早上检查一次**：

- [ ] 1. 查看 `sync_state.json` 的 `LastRunUtc` 是否更新
- [ ] 2. 确认时间在今天 1:07 左右
- [ ] 3. 检查 logs 目录有今天的日志文件
- [ ] 4. 查看日志最后几行是否有 "同步流程结束"
- [ ] 5. 确认计划任务的下次运行时间是明天 1:07

**一键检查命令**：
```powershell
PowerShell -ExecutionPolicy Bypass -File "C:\Users\ThinkPad\Desktop\VSCOD\scripts\check-sync-status.ps1"
```

---

## 🎯 总结

**最快速的检查方法**：
```powershell
# 方法 A：查看状态文件（最快）
$state = Get-Content C:\Users\ThinkPad\Desktop\VSCOD\SyncEkpToCasdoor\sync_state.json | ConvertFrom-Json
[DateTime]::Parse($state.LastRunUtc).ToLocalTime()

# 方法 B：运行监控脚本（最全面）
PowerShell -ExecutionPolicy Bypass -File "C:\Users\ThinkPad\Desktop\VSCOD\scripts\check-sync-status.ps1"
```

**判断标准**：
- ✅ 时间显示今天 1:07 左右 = 执行成功
- ❌ 时间还是昨天或更早 = 未执行

---

## 📚 相关文档

- 详细文档：[定时同步监控指南.md](定时同步监控指南.md)
- 监控脚本：`scripts/check-sync-status.ps1`
- 同步脚本：`scripts/run-sync.ps1`

---

**快速帮助**：有问题先运行监控脚本 `check-sync-status.ps1`，它会告诉你所有的状态信息！
