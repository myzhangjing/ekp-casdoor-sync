# å®šæ—¶åŒæ­¥ä»»åŠ¡å¿«é€Ÿç›‘æ§æŒ‡å—

## âœ… é—®é¢˜ï¼šå¦‚ä½•çŸ¥é“æ¯å¤© 1:07 çš„å®šæ—¶åŒæ­¥ä»»åŠ¡æœ‰æ²¡æœ‰æ‰§è¡Œï¼Ÿ

---

## ğŸš€ å¿«é€Ÿæ£€æŸ¥æ–¹æ³•

### æ–¹æ³• 1ï¼šè¿è¡Œç›‘æ§è„šæœ¬ï¼ˆæ¨èï¼‰â­

```powershell
cd C:\Users\ThinkPad\Desktop\VSCOD
PowerShell -ExecutionPolicy Bypass -File ".\scripts\check-sync-status.ps1"
```

**ä¸€é”®æŸ¥çœ‹**ï¼š
- âœ… æœ€åæ‰§è¡Œæ—¶é—´
- âœ… åŒæ­¥æ˜¯å¦æˆåŠŸ  
- âœ… æ—¥å¿—æ–‡ä»¶å†…å®¹
- âœ… è®¡åˆ’ä»»åŠ¡çŠ¶æ€
- âœ… ç¯å¢ƒå˜é‡é…ç½®

---

### æ–¹æ³• 2ï¼šæŸ¥çœ‹çŠ¶æ€æ–‡ä»¶ï¼ˆæœ€å¿«ï¼‰âš¡

æŸ¥çœ‹ `sync_state.json` ä¸­çš„ `LastRunUtc` å­—æ®µï¼š

```powershell
# æŸ¥çœ‹ JSON æ–‡ä»¶
Get-Content C:\Users\ThinkPad\Desktop\VSCOD\SyncEkpToCasdoor\sync_state.json

# è½¬æ¢ä¸ºæœ¬åœ°æ—¶é—´
$state = Get-Content C:\Users\ThinkPad\Desktop\VSCOD\SyncEkpToCasdoor\sync_state.json | ConvertFrom-Json
[DateTime]::Parse($state.LastRunUtc).ToLocalTime()
```

**ç¤ºä¾‹è¾“å‡º**ï¼š
```json
{
  "LastRunUtc": "2025-10-30T17:09:13.9457098Z"  â† UTC æ—¶é—´
}
```

è½¬æ¢ä¸ºæœ¬åœ°æ—¶é—´ï¼š`2025-10-31 01:09:13`ï¼ˆåŒ—äº¬æ—¶é—´ = UTC + 8 å°æ—¶ï¼‰

**åˆ¤æ–­æ ‡å‡†**ï¼š
- âœ… `LastRunUtc` åœ¨ä»Šå¤© 1:07 å·¦å³ â†’ æ‰§è¡ŒæˆåŠŸ
- âŒ `LastRunUtc` è¿˜æ˜¯æ˜¨å¤©æˆ–æ›´æ—© â†’ æœªæ‰§è¡Œï¼ˆå¯èƒ½å‡ºé—®é¢˜äº†ï¼‰

---

### æ–¹æ³• 3ï¼šæ£€æŸ¥æ—¥å¿—æ–‡ä»¶

```powershell
# è¿›å…¥æ—¥å¿—ç›®å½•
cd C:\Users\ThinkPad\Desktop\VSCOD\logs

# æŸ¥çœ‹ä»Šå¤©çš„æ—¥å¿—
Get-ChildItem sync_*.log | Where-Object { $_.LastWriteTime.Date -eq (Get-Date).Date }

# æŸ¥çœ‹æœ€æ–°æ—¥å¿—çš„æœ€å 50 è¡Œ
Get-Content (Get-ChildItem sync_*.log | Sort-Object LastWriteTime -Descending | Select-Object -First 1).FullName -Tail 50
```

**å…³é”®æ ‡è¯†**ï¼š
- âœ… `"åŒæ­¥æµç¨‹ç»“æŸï¼Œæ£€æŸ¥ç‚¹å·²å†™å…¥"` â†’ æˆåŠŸ
- âœ… `"ç»„ç»‡åŒæ­¥å®Œæˆï¼Œå…±å¤„ç† XXX æ¡è®°å½•"` â†’ æˆåŠŸ
- âŒ `"åŒæ­¥å¤±è´¥"` æˆ– `"é”™è¯¯"` â†’ å¤±è´¥

---

### æ–¹æ³• 4ï¼šæŸ¥çœ‹ Windows è®¡åˆ’ä»»åŠ¡

```powershell
# æŸ¥çœ‹ä»»åŠ¡ä¿¡æ¯
Get-ScheduledTask -TaskName "EKP-Casdoor-DailySync" | Get-ScheduledTaskInfo

# æŸ¥çœ‹ä¸Šæ¬¡è¿è¡Œæ—¶é—´å’Œç»“æœ
$task = Get-ScheduledTaskInfo -TaskName "EKP-Casdoor-DailySync"
Write-Host "ä¸Šæ¬¡è¿è¡Œ: $($task.LastRunTime)"
Write-Host "ä¸‹æ¬¡è¿è¡Œ: $($task.NextRunTime)"  
Write-Host "è¿è¡Œç»“æœ: $($task.LastTaskResult)"  # 0 = æˆåŠŸ
```

**æˆ–è€…ä½¿ç”¨ GUI**ï¼š
1. æŒ‰ `Win + R`ï¼Œè¾“å…¥ `taskschd.msc`
2. æ‰¾åˆ°ä»»åŠ¡ `EKP-Casdoor-DailySync`
3. æŸ¥çœ‹ **ä¸Šæ¬¡è¿è¡Œæ—¶é—´** å’Œ **ä¸Šæ¬¡è¿è¡Œç»“æœ**
4. ç‚¹å‡» **å†å²è®°å½•** æ ‡ç­¾æŸ¥çœ‹è¯¦ç»†æ—¥å¿—

---

## ğŸ“Š åˆ¤æ–­æ ‡å‡†å¯¹ç…§è¡¨

| æ£€æŸ¥é¡¹ | æ­£å¸¸ | å¼‚å¸¸ |
|--------|------|------|
| **LastRunUtc** | ä»Šå¤© 1:07 å·¦å³ | æ˜¨å¤©æˆ–æ›´æ—© |
| **ä»»åŠ¡çŠ¶æ€** | `Ready` | `Disabled` |
| **ä¸Šæ¬¡ç»“æœ** | `0x0` (æˆåŠŸ) | é 0 å€¼ |
| **æ—¥å¿—æ–‡ä»¶** | ä»Šå¤©æœ‰æ–°æ—¥å¿— | æ²¡æœ‰ä»Šå¤©çš„æ—¥å¿— |
| **æ—¥å¿—å†…å®¹** | "åŒæ­¥æµç¨‹ç»“æŸ" | "åŒæ­¥å¤±è´¥" |

---

## ğŸ”§ å¦‚æœæ²¡æœ‰æ‰§è¡Œæ€ä¹ˆåŠï¼Ÿ

### 1. æ£€æŸ¥è®¡åˆ’ä»»åŠ¡æ˜¯å¦å¯ç”¨

```powershell
# æŸ¥çœ‹çŠ¶æ€
Get-ScheduledTask -TaskName "EKP-Casdoor-DailySync" | Select-Object State

# å¦‚æœæ˜¯ Disabledï¼Œå¯ç”¨å®ƒ
Enable-ScheduledTask -TaskName "EKP-Casdoor-DailySync"
```

### 2. æ‰‹åŠ¨è¿è¡Œä¸€æ¬¡æµ‹è¯•

```powershell
# æ‰‹åŠ¨è§¦å‘è®¡åˆ’ä»»åŠ¡
Start-ScheduledTask -TaskName "EKP-Casdoor-DailySync"

# ç­‰å¾…å‡ ç§’åæŸ¥çœ‹ç»“æœ
Start-Sleep -Seconds 30
Get-ScheduledTaskInfo -TaskName "EKP-Casdoor-DailySync"
```

### 3. æŸ¥çœ‹é”™è¯¯æ—¥å¿—

```powershell
# æŸ¥çœ‹æœ€æ–°çš„æ—¥å¿—
$latestLog = Get-ChildItem C:\Users\ThinkPad\Desktop\VSCOD\logs\sync_*.log | 
             Sort-Object LastWriteTime -Descending | 
             Select-Object -First 1

Get-Content $latestLog.FullName -Tail 100
```

### 4. æ£€æŸ¥ç¯å¢ƒå˜é‡

å®šæ—¶ä»»åŠ¡éœ€è¦ç³»ç»Ÿçº§ç¯å¢ƒå˜é‡ï¼š

```powershell
# æ£€æŸ¥å¿…éœ€çš„ç¯å¢ƒå˜é‡
[Environment]::GetEnvironmentVariable("EKP_SQLSERVER_CONN", "Machine")
[Environment]::GetEnvironmentVariable("CASDOOR_ENDPOINT", "Machine")
[Environment]::GetEnvironmentVariable("CASDOOR_CLIENT_ID", "Machine")
[Environment]::GetEnvironmentVariable("CASDOOR_CLIENT_SECRET", "Machine")
[Environment]::GetEnvironmentVariable("CASDOOR_DEFAULT_OWNER", "Machine")
```

å¦‚æœä¸ºç©ºï¼Œéœ€è¦åœ¨**ç³»ç»Ÿç¯å¢ƒå˜é‡**ä¸­é…ç½®ï¼ˆä¸æ˜¯ç”¨æˆ·ç¯å¢ƒå˜é‡ï¼‰ã€‚

---

## ğŸ“§ è®¾ç½®é‚®ä»¶å‘Šè­¦ï¼ˆå¯é€‰ï¼‰

å¦‚æœæƒ³åœ¨åŒæ­¥å¤±è´¥æ—¶è‡ªåŠ¨æ”¶åˆ°é‚®ä»¶ï¼Œå¯ä»¥åœ¨ `scripts\run-sync.ps1` æœ«å°¾æ·»åŠ å‘Šè­¦é€»è¾‘ï¼š

```powershell
# åœ¨ run-sync.ps1 æœ«å°¾æ·»åŠ 
if ($process.ExitCode -ne 0) {
    Send-MailMessage `
        -From "sync@example.com" `
        -To "admin@example.com" `
        -Subject "EKP-Casdoor åŒæ­¥å¤±è´¥å‘Šè­¦" `
        -Body "åŒæ­¥ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—: $logFile" `
        -SmtpServer "smtp.example.com" `
        -Port 587 `
        -Credential (Get-Credential) `
        -UseSsl
}
```

---

## ğŸ“ æ¯æ—¥æ£€æŸ¥æ¸…å•

**å»ºè®®æ¯å¤©æ—©ä¸Šæ£€æŸ¥ä¸€æ¬¡**ï¼š

- [ ] 1. æŸ¥çœ‹ `sync_state.json` çš„ `LastRunUtc` æ˜¯å¦æ›´æ–°
- [ ] 2. ç¡®è®¤æ—¶é—´åœ¨ä»Šå¤© 1:07 å·¦å³
- [ ] 3. æ£€æŸ¥ logs ç›®å½•æœ‰ä»Šå¤©çš„æ—¥å¿—æ–‡ä»¶
- [ ] 4. æŸ¥çœ‹æ—¥å¿—æœ€åå‡ è¡Œæ˜¯å¦æœ‰ "åŒæ­¥æµç¨‹ç»“æŸ"
- [ ] 5. ç¡®è®¤è®¡åˆ’ä»»åŠ¡çš„ä¸‹æ¬¡è¿è¡Œæ—¶é—´æ˜¯æ˜å¤© 1:07

**ä¸€é”®æ£€æŸ¥å‘½ä»¤**ï¼š
```powershell
PowerShell -ExecutionPolicy Bypass -File "C:\Users\ThinkPad\Desktop\VSCOD\scripts\check-sync-status.ps1"
```

---

## ğŸ¯ æ€»ç»“

**æœ€å¿«é€Ÿçš„æ£€æŸ¥æ–¹æ³•**ï¼š
```powershell
# æ–¹æ³• Aï¼šæŸ¥çœ‹çŠ¶æ€æ–‡ä»¶ï¼ˆæœ€å¿«ï¼‰
$state = Get-Content C:\Users\ThinkPad\Desktop\VSCOD\SyncEkpToCasdoor\sync_state.json | ConvertFrom-Json
[DateTime]::Parse($state.LastRunUtc).ToLocalTime()

# æ–¹æ³• Bï¼šè¿è¡Œç›‘æ§è„šæœ¬ï¼ˆæœ€å…¨é¢ï¼‰
PowerShell -ExecutionPolicy Bypass -File "C:\Users\ThinkPad\Desktop\VSCOD\scripts\check-sync-status.ps1"
```

**åˆ¤æ–­æ ‡å‡†**ï¼š
- âœ… æ—¶é—´æ˜¾ç¤ºä»Šå¤© 1:07 å·¦å³ = æ‰§è¡ŒæˆåŠŸ
- âŒ æ—¶é—´è¿˜æ˜¯æ˜¨å¤©æˆ–æ›´æ—© = æœªæ‰§è¡Œ

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- è¯¦ç»†æ–‡æ¡£ï¼š[å®šæ—¶åŒæ­¥ç›‘æ§æŒ‡å—.md](å®šæ—¶åŒæ­¥ç›‘æ§æŒ‡å—.md)
- ç›‘æ§è„šæœ¬ï¼š`scripts/check-sync-status.ps1`
- åŒæ­¥è„šæœ¬ï¼š`scripts/run-sync.ps1`

---

**å¿«é€Ÿå¸®åŠ©**ï¼šæœ‰é—®é¢˜å…ˆè¿è¡Œç›‘æ§è„šæœ¬ `check-sync-status.ps1`ï¼Œå®ƒä¼šå‘Šè¯‰ä½ æ‰€æœ‰çš„çŠ¶æ€ä¿¡æ¯ï¼
