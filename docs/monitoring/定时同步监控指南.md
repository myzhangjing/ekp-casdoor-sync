# 定时同步任务监控指南

## 📋 概述

本指南介绍如何设置和监控 EKP 到 Casdoor 的定时同步任务，确保每日定时同步能够正常执行。

---

## 🚀 快速开始

### 1. 创建 Windows 计划任务（每日 1:07 执行）

打开 **任务计划程序**（Task Scheduler），创建新任务：

#### 基本设置
- **名称**: `EKP-Casdoor-DailySync`
- **描述**: `每日 1:07 自动同步 EKP 数据到 Casdoor`
- **安全选项**: 
  - ✅ 不管用户是否登录都要运行
  - ✅ 使用最高权限运行

#### 触发器设置
```
触发器类型: 每日
开始时间: 1:07:00 AM
重复任务间隔: （不设置）
停止任务如果运行时间超过: 1 小时
```

#### 操作设置
```
操作: 启动程序

程序或脚本:
C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe

添加参数:
-ExecutionPolicy Bypass -File "C:\Users\ThinkPad\Desktop\VSCOD\scripts\run-sync.ps1"

起始于:
C:\Users\ThinkPad\Desktop\VSCOD
```

#### 条件设置
- ❌ 只有在计算机使用交流电源时才启动此任务
- ✅ 如果计算机改用电池电源，停止

#### 设置
- ✅ 允许按需运行任务
- ✅ 如果任务失败，按以下时间间隔重新启动: 10 分钟
- ✅ 尝试重新启动次数: 3

---

## 🔍 监控方法

### 方法 1：使用状态检查脚本（推荐）

运行自动化检查脚本：

```powershell
cd C:\Users\ThinkPad\Desktop\VSCOD
.\scripts\check-sync-status.ps1
```

**输出示例**：
```
=====================================
  EKP-Casdoor 同步状态检查工具
=====================================

[1] 检查同步状态文件
  ✓ 状态文件存在: C:\...\sync_state.json

  最后执行时间: 2025-10-31 01:07:23 (距今 5 小时 32 分钟)
  组织同步: 2025-10-31 01:07:45
  用户同步: 2025-10-31 01:09:12

[2] 检查同步日志
  ✓ 找到 15 个日志文件
  最新日志: sync_20251031_010723.log
  生成时间: 2025-10-31 01:07:23
  文件大小: 52.3 KB

  日志分析:
    组织处理: 120 条
    用户处理: 485 条
    错误数量: 0 个

[3] 检查 Windows 计划任务
  ✓ 找到 1 个相关计划任务:

  任务名称: EKP-Casdoor-DailySync
    状态: Ready
    上次运行: 2025-10-31 01:07:00
    下次运行: 2025-11-01 01:07:00
    上次结果: 成功 (0x0)
    触发器:
      每日 01:07 执行

[4] 检查环境变量配置
  EKP_SQLSERVER_CONN: 已配置 (******)
  CASDOOR_ENDPOINT: 已配置 (http://sso.fzcsps.com)
  CASDOOR_CLIENT_ID: 已配置 (******)
  CASDOOR_CLIENT_SECRET: 已配置 (******)
  CASDOOR_DEFAULT_OWNER: 已配置 (fzswjtOrganization)

[5] 总体健康度评估
  ✓ 状态文件正常且最近有执行
  ✓ 日志文件存在
  ✓ 计划任务已配置且就绪
  ✓ 环境变量配置完整
  ✓ 最近的同步未出现错误

  健康度得分: 5/5 (100%)

=====================================
```

---

### 方法 2：手动检查状态文件

查看 `sync_state.json`：

```powershell
Get-Content C:\Users\ThinkPad\Desktop\VSCOD\SyncEkpToCasdoor\sync_state.json | ConvertFrom-Json | Format-List
```

**输出示例**：
```
LastGroupSyncUtc      : 2025-10-30T17:07:45.2097449Z
LastUserSyncUtc       : 2025-10-30T17:09:12.9314122Z
LastMembershipSyncUtc : 2025-10-30T17:09:12.9315362Z
LastRunUtc            : 2025-10-30T17:09:13.9457098Z
```

**时间转换**（UTC → 本地时间）：
```powershell
$state = Get-Content sync_state.json | ConvertFrom-Json
[DateTime]::Parse($state.LastRunUtc).ToLocalTime()
# 输出: 2025-10-31 01:09:13
```

---

### 方法 3：检查日志文件

查看最新的同步日志：

```powershell
cd C:\Users\ThinkPad\Desktop\VSCOD\logs

# 查看所有日志文件
Get-ChildItem sync_*.log | Sort-Object LastWriteTime -Descending

# 查看最新日志的最后 50 行
Get-Content (Get-ChildItem sync_*.log | Sort-Object LastWriteTime -Descending | Select-Object -First 1).FullName -Tail 50
```

**关键日志标识**：
```
✓ 成功标识: "同步流程结束"、"检查点已写入"、"组织同步完成"
✗ 失败标识: "同步失败"、"错误"、"异常"、"失败"
⚠ 警告标识: "警告"、"未找到"
```

---

### 方法 4：查看计划任务历史

#### 通过 PowerShell：

```powershell
# 查看计划任务信息
Get-ScheduledTask -TaskName "EKP-Casdoor-DailySync" | Get-ScheduledTaskInfo

# 查看任务上次运行结果
$task = Get-ScheduledTaskInfo -TaskName "EKP-Casdoor-DailySync"
Write-Host "上次运行: $($task.LastRunTime)"
Write-Host "下次运行: $($task.NextRunTime)"
Write-Host "上次结果: $($task.LastTaskResult)"
```

**退出代码说明**：
- `0x0` (0): 成功
- `0x1` (1): 一般性失败
- `0x41301`: 任务当前正在运行
- `0x41303`: 任务尚未运行

#### 通过任务计划程序 GUI：

1. 打开 **任务计划程序**
2. 找到任务 `EKP-Casdoor-DailySync`
3. 点击 **历史记录** 标签
4. 查看任务执行的详细事件日志

---

## 📊 监控指标

### 核心指标

| 指标 | 检查方法 | 正常标准 |
|------|---------|---------|
| **最后执行时间** | `sync_state.json` 的 `LastRunUtc` | 距今 < 24 小时 |
| **任务状态** | 计划任务的 State | `Ready` |
| **上次结果** | 计划任务的 LastTaskResult | `0x0` (成功) |
| **组织数量** | 日志文件 | 与 EKP 组织数量一致 |
| **用户数量** | 日志文件 | 与 EKP 用户数量一致 |
| **错误计数** | 日志文件 | 0 |
| **日志大小** | 日志文件大小 | 10KB - 500KB (正常范围) |

---

## ⚠️ 故障排查

### 问题 1：任务未执行（LastRunUtc 超过 24 小时）

**可能原因**：
- 计算机在 1:07 时处于关机状态
- 计划任务被禁用
- 环境变量缺失

**解决方法**：
```powershell
# 1. 检查任务状态
Get-ScheduledTask -TaskName "EKP-Casdoor-DailySync" | Select-Object State

# 2. 如果是 Disabled，启用任务
Enable-ScheduledTask -TaskName "EKP-Casdoor-DailySync"

# 3. 手动运行一次测试
Start-ScheduledTask -TaskName "EKP-Casdoor-DailySync"

# 4. 查看运行结果
Get-ScheduledTaskInfo -TaskName "EKP-Casdoor-DailySync"
```

---

### 问题 2：任务执行但失败（LastTaskResult ≠ 0）

**可能原因**：
- 环境变量配置错误
- 数据库连接失败
- Casdoor API 不可用
- 脚本路径错误

**解决方法**：
```powershell
# 1. 查看最新日志
$latestLog = Get-ChildItem C:\Users\ThinkPad\Desktop\VSCOD\logs\sync_*.log | 
             Sort-Object LastWriteTime -Descending | 
             Select-Object -First 1

Get-Content $latestLog.FullName -Tail 100

# 2. 手动运行同步脚本（看详细错误）
cd C:\Users\ThinkPad\Desktop\VSCOD
.\scripts\run-sync.ps1

# 3. 检查环境变量
$env:EKP_SQLSERVER_CONN
$env:CASDOOR_ENDPOINT
$env:CASDOOR_CLIENT_ID
$env:CASDOOR_CLIENT_SECRET
$env:CASDOOR_DEFAULT_OWNER

# 4. 测试数据库连接
Test-NetConnection -ComputerName 172.16.10.110 -Port 1433

# 5. 测试 Casdoor API
Invoke-WebRequest -Uri "http://sso.fzcsps.com/api/get-organizations?owner=fzswjtOrganization" -Method Get
```

---

### 问题 3：同步部分数据缺失

**可能原因**：
- 视图数据不完整
- 权限不足
- 数据格式问题

**解决方法**：
```powershell
# 1. 检查 EKP 视图数据
# 在 SQL Server 中执行：
# SELECT COUNT(*) FROM vw_org_structure_sync;
# SELECT COUNT(*) FROM vw_casdoor_users_sync;

# 2. 执行全量同步（重置增量标记）
$env:SYNC_SINCE_UTC = "1970-01-01T00:00:00Z"
.\scripts\run-sync.ps1

# 3. 清空状态文件重新同步
Remove-Item C:\Users\ThinkPad\Desktop\VSCOD\SyncEkpToCasdoor\sync_state.json
.\scripts\run-sync.ps1
```

---

## 📧 邮件告警（可选）

### 配置邮件告警脚本

创建 `scripts\send-alert-email.ps1`：

```powershell
param(
    [string]$Subject,
    [string]$Body,
    [string]$To = "admin@example.com"
)

$From = "sync-monitor@example.com"
$SmtpServer = "smtp.example.com"
$SmtpPort = 587
$SmtpUser = "sync-monitor@example.com"
$SmtpPassword = "your-password"

$Credential = New-Object System.Management.Automation.PSCredential($SmtpUser, (ConvertTo-SecureString $SmtpPassword -AsPlainText -Force))

Send-MailMessage -From $From -To $To -Subject $Subject -Body $Body -SmtpServer $SmtpServer -Port $SmtpPort -Credential $Credential -UseSsl
```

### 在 run-sync.ps1 中添加告警

在 `scripts\run-sync.ps1` 末尾添加：

```powershell
# 检查同步是否成功
if ($process.ExitCode -ne 0) {
    $alertScript = Join-Path $scriptsDir "send-alert-email.ps1"
    if (Test-Path $alertScript) {
        & $alertScript -Subject "EKP-Casdoor 同步失败" -Body "同步任务执行失败，请查看日志: $logFile"
    }
}
```

---

## 🔔 监控建议

### 日常监控（每天）
- ✅ 检查 `sync_state.json` 的 `LastRunUtc` 是否更新
- ✅ 查看最新日志文件的大小和修改时间
- ✅ 确认计划任务的下次运行时间正确

### 每周监控
- ✅ 运行 `check-sync-status.ps1` 全面检查
- ✅ 审查日志文件中的警告信息
- ✅ 验证同步的数据数量是否合理

### 每月监控
- ✅ 清理旧日志文件（保留最近 30 天）
- ✅ 检查磁盘空间
- ✅ 验证 Casdoor 中的数据完整性

---

## 🔧 自动化监控脚本（进阶）

创建 `scripts\monitor-and-alert.ps1`：

```powershell
# 自动监控并告警
$ErrorActionPreference = "Stop"

$stateFile = "C:\Users\ThinkPad\Desktop\VSCOD\SyncEkpToCasdoor\sync_state.json"
$alertThreshold = 25  # 超过 25 小时未执行则告警

if (Test-Path $stateFile) {
    $state = Get-Content $stateFile -Raw | ConvertFrom-Json
    $lastRun = [DateTime]::Parse($state.LastRunUtc).ToLocalTime()
    $hoursSince = ((Get-Date) - $lastRun).TotalHours
    
    if ($hoursSince -gt $alertThreshold) {
        # 发送告警邮件
        $subject = "⚠️ EKP-Casdoor 同步任务超时未执行"
        $body = @"
同步任务已经 $([Math]::Floor($hoursSince)) 小时未执行！

最后执行时间: $($lastRun.ToString('yyyy-MM-dd HH:mm:ss'))
当前时间: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')

请立即检查计划任务和系统状态。
"@
        
        # 调用告警脚本（需要先配置）
        # .\send-alert-email.ps1 -Subject $subject -Body $body
        
        Write-Warning $body
    } else {
        Write-Host "✓ 同步任务正常，最后执行于 $hoursSince 小时前" -ForegroundColor Green
    }
} else {
    Write-Error "状态文件不存在，可能从未执行过同步！"
}
```

配置此脚本为计划任务，每小时运行一次。

---

## 📚 相关文件

| 文件 | 用途 | 位置 |
|------|------|------|
| `sync_state.json` | 同步状态记录 | `SyncEkpToCasdoor/` |
| `sync_YYYYMMDD_HHmmss.log` | 同步日志 | `logs/` |
| `run-sync.ps1` | 同步执行脚本 | `scripts/` |
| `check-sync-status.ps1` | 状态检查脚本 | `scripts/` |
| 计划任务 | Windows 定时调度 | 任务计划程序 |

---

## 💡 最佳实践

1. **定期检查**：建议每天早上查看一次同步状态
2. **日志保留**：保留最近 30 天的日志，定期清理
3. **告警机制**：配置邮件或短信告警，及时发现问题
4. **备份策略**：定期备份 Casdoor 数据库
5. **监控自动化**：使用 `check-sync-status.ps1` 脚本自动检查
6. **文档记录**：记录每次故障和解决方法

---

## 📞 支持

遇到问题？
1. 查看 `logs/` 目录下的最新日志
2. 运行 `.\scripts\check-sync-status.ps1` 诊断
3. 参考本文档的故障排查章节
4. 联系系统管理员

---

**最后更新**: 2025-10-31  
**版本**: 1.0
