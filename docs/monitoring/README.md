# 定时同步监控文档

本目录包含 EKP-Casdoor 同步工具的定时任务配置与监控相关文档。

## 📚 文档列表

### 🔍 [如何检查定时同步是否执行](./如何检查定时同步是否执行.md)

**适用场景**：日常快速检查  
**内容摘要**：
- ✅ 4 种快速检查方法
- ✅ 判断标准对照表
- ✅ 常见问题排查步骤
- ✅ 每日检查清单

**推荐指数**：⭐⭐⭐⭐⭐（必读）

---

### 📊 [定时同步监控指南](./定时同步监控指南.md)

**适用场景**：完整监控方案设计  
**内容摘要**：
- 🔧 Windows 定时任务详细配置步骤
- 🔍 4 种监控方法详解
- 📧 邮件告警配置（可选）
- 🤖 自动化监控脚本配置
- 🔧 故障排查指南

**推荐指数**：⭐⭐⭐⭐（深度参考）

---

### 🛠️ [修复说明-两次操作问题](./修复说明-两次操作问题.md)

**适用场景**：了解历史问题与修复方案  
**内容摘要**：
- ❌ 问题现象：清库 + 全量同步需执行两次才完成
- 🔍 根本原因：Casdoor 索引更新时序问题
- ✅ 解决方案：等待 + 重试机制
- 📝 代码修改详情
- ⚙️ 使用说明

**推荐指数**：⭐⭐⭐（问题参考）

---

## 🚀 快速开始

### 1️⃣ 设置定时任务

```powershell
# 打开任务计划程序
taskschd.msc

# 创建任务（示例：每天凌晨 1:07）
# 详细步骤见《定时同步监控指南》第 1 节
```

### 2️⃣ 快速检查同步状态

```powershell
# 使用自动化检查脚本（推荐）
.\scripts\check-sync-status.ps1

# 或手动查看状态文件
Get-Content sync_state.json | ConvertFrom-Json | Select-Object LastRunUtc

# 或查看最新日志
Get-ChildItem logs\ | Sort-Object LastWriteTime -Descending | Select-Object -First 1
```

### 3️⃣ 判断执行状态

| 检查项 | 正常标准 | 异常情况 |
|--------|---------|---------|
| **LastRunUtc** | 与预期时间相符（误差 ±5 分钟） | 时间停滞不更新 |
| **日志文件** | 存在今日日期的日志文件 | 没有新日志生成 |
| **任务历史** | 最后运行结果：成功 (0x0) | 失败或从未运行 |
| **环境变量** | 5 个必需变量已配置 | 缺失或值为空 |

---

## 📝 监控最佳实践

### 日常监控（推荐频率：每天）

1. **上午第一件事**：运行 `check-sync-status.ps1`
2. **查看健康分数**：
   - ✅ **绿色**：一切正常
   - ⚠️ **黄色**：需要关注（如日志稍旧）
   - ❌ **红色**：需要立即处理

### 定期审查（推荐频率：每周）

1. **查看日志文件**：检查是否有警告或错误
2. **数据比对**：使用 WPF 界面"数据查看"功能验证数据一致性
3. **清理旧日志**：保留最近 30 天日志，归档或删除更早的

### 紧急情况处理

如果发现同步未执行：
1. ✅ 立即运行 `.\scripts\run-sync.ps1` 手动触发同步
2. 🔍 查看最新日志文件排查原因
3. 🔧 根据《定时同步监控指南》第 4 节排查故障
4. 📧 配置邮件告警避免遗漏（可选）

---

## 🛠️ 相关工具与脚本

| 工具 | 路径 | 用途 |
|------|------|------|
| **监控脚本** | `scripts/check-sync-status.ps1` | 一键检查同步状态 |
| **增量同步** | `scripts/run-sync.ps1` | 手动触发增量同步 |
| **全量同步** | `scripts/run-sync-full.ps1` | 手动触发全量同步 |
| **WPF 界面** | `SyncEkpToCasdoor.UI.exe` | 可视化配置与数据比对 |

---

## 📞 获取帮助

- **查看日志**：`logs/sync_YYYYMMDD_HHmmss.log`
- **提交问题**：[GitHub Issues](https://github.com/myzhangjing/ekp-casdoor-sync/issues)
- **阅读文档**：[项目主文档](../../README.md)

---

## 📅 文档更新历史

- **2025-10-31**：初始版本，包含监控指南与快速参考
- **2025-10-31**：添加"两次操作问题"修复说明

---

**提示**：建议先阅读《如何检查定时同步是否执行》快速上手，遇到问题时参考《定时同步监控指南》深度排查。
