# 强制登录验证说明

## 🔒 安全机制

从 **v1.3.1** 版本开始，EKP-Casdoor 同步工具实施**强制身份验证**机制：

- ✅ 用户**必须**通过 Casdoor OAuth2 登录验证才能使用程序
- ✅ 未登录或登录失败，程序将自动退出
- ✅ 登录成功后，用户信息显示在状态栏
- ✅ 访问令牌在应用运行期间保持有效

---

## 🚀 快速开始

### 步骤1：配置 Casdoor 环境变量

**必须**设置以下环境变量（否则无法启动）：

```powershell
# 方式1：临时设置（当前 PowerShell 会话）
$env:CASDOOR_ENDPOINT = "http://sso.fzcsps.com"
$env:CASDOOR_CLIENT_ID = "aecd00a352e5c560ffe6"
$env:CASDOOR_CLIENT_SECRET = "your-client-secret"

# 方式2：永久设置（推荐）
[System.Environment]::SetEnvironmentVariable("CASDOOR_ENDPOINT", "http://sso.fzcsps.com", "Machine")
[System.Environment]::SetEnvironmentVariable("CASDOOR_CLIENT_ID", "aecd00a352e5c560ffe6", "Machine")
[System.Environment]::SetEnvironmentVariable("CASDOOR_CLIENT_SECRET", "your-secret", "Machine")
```

**📝 使用配置脚本（推荐）**：

```powershell
# 编辑 scripts/setup-env.ps1 中的配置值
# 然后运行：
.\scripts\setup-env.ps1
```

### 步骤2：启动应用

```powershell
# 确保已设置环境变量后启动
.\SyncEkpToCasdoor\SyncEkpToCasdoor.UI\bin\Release\net8.0-windows\SyncEkpToCasdoor.UI.exe
```

### 步骤3：完成 OAuth2 登录

1. **自动弹出登录窗口**
2. 点击"使用 Casdoor 登录"
3. 浏览器自动打开授权页面
4. 输入用户名和密码
5. 点击"授权"
6. **自动返回应用**（使用 `ekpsync://` 协议）
7. 登录成功，进入主界面

---

## 🔐 安全特性

### 1. 配置验证

启动时检查配置完整性：

```
✅ CASDOOR_ENDPOINT - 必需
✅ CASDOOR_CLIENT_ID - 必需
⚠️  CASDOOR_CLIENT_SECRET - 推荐（某些场景可选）
```

如果配置不完整：
```
❌ 显示错误提示
❌ 说明需要配置的环境变量
❌ 应用自动退出
```

### 2. 强制登录

```csharp
private bool RequiresLogin()
{
    // 检查是否有有效的访问令牌缓存
    var cachedToken = Application.Current.Properties["AccessToken"] as string;
    if (!string.IsNullOrEmpty(cachedToken))
    {
        return false; // 有缓存的 token，不需要重新登录
    }

    // 必须进行登录验证
    return true;
}
```

### 3. 登录失败处理

```
用户取消登录 → 显示警告 → 应用退出
网络错误 → 显示错误信息 → 可重试或退出
授权失败 → 显示错误详情 → 应用退出
```

### 4. 用户信息显示

登录成功后，状态栏显示：

```
👤 [用户显示名称] 
```

用户信息来源：
- 优先：`displayName`（显示名称）
- 备用：`name`（用户名）
- 默认：`已登录`

---

## 🎯 Casdoor 配置要求

### Application 设置

在 Casdoor 管理后台配置：

```
Name: EKP-Casdoor-Sync
Redirect URIs:
  - ekpsync://callback         ← 优先使用（自定义协议）
  - http://localhost:9000/callback  ← 备用

Grant Types:
  ☑ Authorization Code         ← 必须启用

Scopes:
  ☑ read                       ← 基本权限
  ☑ profile                    ← 获取用户信息（推荐）
```

### 用户权限

确保用户账号：
- ✅ 已在 Casdoor 中创建
- ✅ 属于正确的 Organization
- ✅ 账号状态为"启用"
- ✅ 有权限使用该应用

---

## 📊 登录流程图

```
应用启动
   ↓
检查配置
   ├─ 不完整 → 显示错误 → 退出
   └─ 完整
       ↓
   检查 Token 缓存
       ├─ 有效 Token → 跳过登录 → 进入主界面
       └─ 无 Token
           ↓
       显示登录窗口
           ↓
       用户点击登录
           ↓
       浏览器授权
           ├─ 取消 → 退出应用
           ├─ 失败 → 显示错误 → 退出应用
           └─ 成功
               ↓
           获取访问令牌
               ↓
           获取用户信息
               ↓
           保存到内存
               ↓
           进入主界面
```

---

## 🛠️ 故障排查

### 问题1：启动时提示"配置不完整"

**原因**：未设置环境变量

**解决**：
```powershell
# 检查环境变量
Get-ChildItem Env:CASDOOR_*

# 设置环境变量
.\scripts\setup-env.ps1
```

### 问题2：登录后立即退出

**原因**：用户取消了授权或授权失败

**解决**：
1. 检查 Casdoor 服务是否可访问
2. 验证 Client ID 和 Secret 是否正确
3. 确认用户账号有权限使用该应用

### 问题3：浏览器授权后没有自动返回

**原因1**：URI Scheme 未注册

**解决**：
- 首次运行会自动注册
- 或使用"手动输入授权码"方式

**原因2**：防火墙或安全软件阻止

**解决**：
- 允许应用通过防火墙
- 或使用手动输入方式

### 问题4：登录成功但显示"已登录"而非用户名

**原因**：未获取到用户信息

**解决**：
1. 检查 Casdoor Application 是否启用了 `profile` scope
2. 查看日志文件：`logs/error_YYYYMMDD.log`
3. 验证网络连接

---

## 🔄 Token 管理

### 当前实现

```csharp
// Token 存储位置
Application.Current.Properties["AccessToken"] = accessToken;

// 用户信息存储
Application.Current.Properties["UserName"] = userName;
Application.Current.Properties["UserDisplayName"] = displayName;
```

### 生命周期

- ✅ **有效期**：应用运行期间
- ⚠️  **持久化**：未实现（关闭应用后失效）
- 🔄 **刷新**：未实现（需要重新登录）

### 未来改进

- [ ] Token 持久化（Windows 凭据管理器）
- [ ] Token 过期检测
- [ ] 自动刷新机制
- [ ] "记住我"选项

---

## 📝 开发者说明

### 跳过登录（仅用于开发测试）

**⚠️  不推荐用于生产环境**

临时修改 `App.xaml.cs`：

```csharp
private bool RequiresLogin()
{
    // 临时跳过登录
    return false; // ← 修改这里
}
```

### 自定义登录逻辑

```csharp
// 在 App.xaml.cs 的 ShowLoginWindow() 方法中
// 可以自定义登录失败后的行为
```

### 添加权限检查

```csharp
// 获取用户信息后，可以添加权限验证
private async Task GetUserInfoAsync(string accessToken)
{
    // ... 获取用户信息
    
    // 验证用户权限
    if (!HasRequiredPermissions(userInfo))
    {
        MessageBox.Show("您没有权限使用此程序");
        Shutdown();
    }
}
```

---

## 📞 获取帮助

遇到问题？

1. **查看日志**：`logs/error_YYYYMMDD.log`
2. **检查配置**：运行 `.\scripts\check-sync-status.ps1`
3. **提交 Issue**：[GitHub Issues](https://github.com/myzhangjing/ekp-casdoor-sync/issues)

---

**更新日期**：2025-10-31  
**版本**：v1.3.1  
**变更**：实施强制 OAuth2 登录验证
