# 执行同步功能使用说明

## 功能概述

**执行同步**页面提供了图形化的同步操作界面，支持：
- ✅ 增量同步：仅同步自上次以来发生变化的数据
- ✅ 全量同步：重新同步所有数据
- ✅ 实时进度显示：进度条和百分比
- ✅ 统计信息：组织数、用户数、成功数、失败数、耗时
- ✅ 实时日志：同步过程的详细日志输出
- ✅ 取消同步：随时中止正在进行的同步
- ✅ 日志管理：清除日志记录

## 界面说明

### 1. 同步控制面板

#### 增量同步（推荐）
- **用途**：同步自上次同步以来发生变化的数据
- **优点**：速度快，资源占用少
- **适用场景**：日常定期同步
- **执行时间**：通常几秒到几分钟

**操作步骤：**
1. 确保已在"配置管理"页面完成配置
2. 点击"增量同步"按钮
3. 确认对话框，点击"是"
4. 观察进度条和实时日志
5. 等待同步完成，查看统计结果

#### 全量同步（慎用）
- **用途**：重新同步所有数据，忽略上次同步时间
- **优点**：确保数据完整性
- **适用场景**：
  - 首次同步
  - 数据校正
  - 同步中断后的恢复
- **执行时间**：可能需要几分钟到几小时（取决于数据量）

**⚠️ 注意事项：**
- 全量同步会处理所有数据，耗时较长
- 建议在非业务高峰期执行
- 确保网络连接稳定

**操作步骤：**
1. 点击"全量同步"按钮（橙色）
2. 仔细阅读警告对话框
3. 确认执行，点击"是"
4. 观察同步过程
5. 等待完成

#### 取消同步
- 点击"取消"按钮（红色）可中止正在进行的同步
- 系统会尝试安全终止同步进程
- 已处理的数据会保留

#### 清除日志
- 清除实时日志区域的所有记录
- 不影响持久化日志文件

### 2. 进度显示

#### 进度条
- **同步中**：显示不确定进度条（动画效果）
- **完成/待命**：显示当前进度百分比

#### 状态信息
- **左侧**：当前状态消息（就绪/同步中/同步完成/同步失败）
- **右侧**：详细进度信息（处理的具体内容）

### 3. 统计面板

实时显示同步统计数据：

| 统计项 | 说明 |
|--------|------|
| **组织数** | 已处理的组织数量 |
| **用户数** | 已处理的用户数量 |
| **成功** | 成功同步的记录数（绿色） |
| **失败** | 同步失败的记录数（红色） |
| **耗时** | 同步持续时间（mm:ss 格式） |
| **上次同步** | 上次同步的结果和时间 |

### 4. 实时日志

#### 日志格式
```
[HH:mm:ss] 🔍 调试信息
[HH:mm:ss] ℹ️ 普通信息
[HH:mm:ss] ⚠️ 警告信息
[HH:mm:ss] ❌ 错误信息
```

#### 日志功能
- ✅ 实时显示：同步过程的详细日志
- ✅ 自动滚动：最新日志显示在顶部
- ✅ 限制数量：最多保留 500 条（防止内存溢出）
- ✅ 等宽字体：使用 Consolas 字体便于阅读
- ✅ 横向滚动：支持长日志消息

## 使用场景

### 场景 1：首次同步
```
1. 打开应用程序
2. 在"配置管理"页面完成所有配置
3. 点击"测试所有连接"确保连接正常
4. 切换到"执行同步"页面
5. 点击"全量同步"（首次必须全量）
6. 等待同步完成
7. 查看统计结果和日志
```

### 场景 2：日常增量同步
```
1. 打开应用程序（已有配置）
2. 切换到"执行同步"页面
3. 点击"增量同步"
4. 确认执行
5. 查看同步结果
```

### 场景 3：同步失败处理
```
1. 查看实时日志中的错误信息
2. 根据错误类型采取措施：
   - 连接错误：检查网络和服务状态
   - 配置错误：返回"配置管理"修正
   - 数据错误：查看详细日志，联系管理员
3. 修正问题后重新执行同步
```

### 场景 4：中止长时间同步
```
1. 如果同步时间过长或发现问题
2. 点击"取消"按钮
3. 等待进程安全终止
4. 检查日志了解已完成的进度
5. 根据需要重新执行
```

## 技术细节

### 同步引擎
- 基于进程调用：启动独立的 `SyncEkpToCasdoor.exe` 进程
- 环境变量传递：通过环境变量传递配置（避免命令行暴露敏感信息）
- 输出解析：实时解析标准输出，提取进度和统计信息

### 事件机制
```
SyncEngineService
├── ProgressChanged   → 更新进度条和进度消息
├── LogReceived       → 添加到实时日志
└── SyncCompleted     → 显示最终结果对话框
```

### 配置要求

在执行同步前，确保已配置：

**必需配置：**
- ✅ EKP 数据库连接（服务器、数据库、用户名、密码）
- ✅ Casdoor API（端点、Client ID、Client Secret）
- ✅ Casdoor 拥有者（Owner 名称）

**可选配置：**
- 🔲 Casdoor 数据库（高级功能）
- 🔲 EKP 用户组视图（自定义查询）
- 🔲 组织类型过滤器（按类型过滤）

### 同步逻辑

#### 增量同步流程
```
1. 读取 sync_state.json（上次同步时间）
2. 查询 EKP 数据库：WHERE 更新时间 > 上次同步时间
3. 对比 Casdoor 数据
4. 更新/创建变更的组织和用户
5. 更新 sync_state.json
```

#### 全量同步流程
```
1. 忽略 sync_state.json
2. 查询 EKP 数据库：全部数据
3. 对比 Casdoor 数据
4. 更新/创建所有组织和用户
5. 创建新的 sync_state.json
```

## 常见问题

### Q1：配置不完整或无效
**问题**：点击同步按钮时提示"配置不完整或无效"

**解决方案**：
1. 切换到"配置管理"页面
2. 检查所有必填字段（标记为红色的）
3. 点击"测试所有连接"确保连接正常
4. 点击"保存配置"
5. 返回"执行同步"页面重试

### Q2：同步失败
**问题**：同步完成后显示"同步失败"

**解决方案**：
1. 查看实时日志中的最后几条错误消息
2. 常见错误类型：
   - **连接超时**：检查网络和服务器状态
   - **认证失败**：检查用户名/密码/Client Secret
   - **权限不足**：检查数据库用户权限
   - **数据格式错误**：查看详细错误信息
3. 修正问题后重新同步

### Q3：进度条不动
**问题**：进度条显示但一直不动

**原因**：
- 不确定进度条：表示正在处理，但无法准确估算进度
- 实时日志会显示处理进度

**建议**：
- 观察实时日志而非进度条
- 等待同步完成或查看日志确认是否卡住

### Q4：统计数据为 0
**问题**：同步完成但统计数据都是 0

**可能原因**：
1. 没有需要同步的数据（增量同步时常见）
2. EKP 数据库中没有数据
3. 组织类型过滤器过滤掉了所有数据

**检查方法**：
1. 在"配置管理"页面点击"获取数据预览"
2. 查看 EKP 数据库中的实际数据量
3. 检查"同步规则"页面的过滤器设置

### Q5：同步耗时过长
**问题**：全量同步运行了很长时间

**正常情况**：
- 全量同步需要处理所有数据
- 时间取决于数据量、网络速度、服务器性能

**预估时间**：
- 1000 个用户：约 1-2 分钟
- 5000 个用户：约 5-10 分钟
- 10000+ 个用户：可能需要 20+ 分钟

**优化建议**：
1. 使用增量同步（日常使用）
2. 在非高峰期执行全量同步
3. 检查网络连接质量
4. 考虑使用组织类型过滤器

## 最佳实践

### 1. 首次部署
```
第一天：
- 完成配置
- 测试所有连接
- 执行全量同步
- 验证数据正确性

第二天开始：
- 每天执行一次增量同步
- 观察同步结果
- 建立同步日志审查机制
```

### 2. 日常维护
```
建议频率：
- 增量同步：每天 1-2 次
- 全量同步：每周/每月一次（数据校验）

监控重点：
- 失败数是否增加
- 同步耗时是否异常
- 日志中是否有警告
```

### 3. 故障恢复
```
如果发现数据不一致：
1. 检查 EKP 和 Casdoor 的数据
2. 执行全量同步（强制对齐）
3. 验证同步结果
4. 恢复日常增量同步
```

### 4. 性能优化
```
如果同步速度慢：
1. 检查数据库查询性能
2. 优化网络连接
3. 使用组织类型过滤器减少数据量
4. 考虑调整同步频率
```

## 下一步

完成同步执行后，您可以：
1. ✅ 配置任务调度（开发中）：自动化定时同步
2. ✅ 查看日志页面：查看历史同步记录
3. ✅ 调整同步规则：优化同步范围和频率
4. ✅ 监控同步状态：建立监控和告警机制

---

**💡 提示**：
- 首次同步建议在测试环境验证
- 定期检查日志，及时发现问题
- 保持配置备份（sync_config.json）
- 遇到问题查看实时日志中的详细错误信息
