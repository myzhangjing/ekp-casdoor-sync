# 更新日志 - 同步执行功能

## 版本信息
- **日期**: 2024-01-XX
- **版本**: v1.1.0
- **更新内容**: 实现同步执行界面和引擎

## 新增功能

### 1. 同步引擎服务 (SyncEngineService)

新增 `SyncEkpToCasdoor.UI/Services/SyncEngineService.cs`

**核心功能：**
- ✅ 进程管理：启动和控制 SyncEkpToCasdoor.exe 进程
- ✅ 环境变量配置：安全传递敏感配置信息
- ✅ 输出解析：实时解析同步进程的输出
- ✅ 进度计算：根据关键字估算同步进度
- ✅ 事件通知：ProgressChanged、LogReceived、SyncCompleted

**API：**
```csharp
// 增量同步
public async Task<SyncResult> ExecuteSyncAsync(
    SyncConfiguration config, 
    CancellationToken cancellationToken)

// 全量同步
public async Task<SyncResult> ExecuteFullSyncAsync(
    SyncConfiguration config, 
    CancellationToken cancellationToken)

// 取消同步
public void CancelSync()

// 事件
public event EventHandler<SyncProgressEventArgs>? ProgressChanged;
public event EventHandler<LogMessageEventArgs>? LogReceived;
public event EventHandler<SyncCompletedEventArgs>? SyncCompleted;
```

**技术特点：**
- 自动查找可执行文件路径
- 支持 Release 和 Debug 构建
- 进程树终止（包括子进程）
- 异步执行，UI 不阻塞
- 支持取消令牌

### 2. 同步执行 ViewModel (SyncExecutionViewModel)

新增 `SyncEkpToCasdoor.UI/ViewModels/SyncExecutionViewModel.cs`

**属性：**
- Configuration: 同步配置
- IsSyncing: 是否正在同步
- ProgressPercentage: 进度百分比（0-100）
- ProgressMessage: 进度详细信息
- StatusMessage: 状态消息
- RealtimeLogs: 实时日志集合（最多 500 条）
- OrganizationCount: 组织数量
- UserCount: 用户数量
- SuccessCount: 成功数量
- ErrorCount: 失败数量
- SyncStartTime: 同步开始时间
- SyncDuration: 同步持续时间
- LastSyncResult: 上次同步结果

**命令：**
- StartIncrementalSyncCommand: 开始增量同步
- StartFullSyncCommand: 开始全量同步
- CancelSyncCommand: 取消同步
- ClearLogsCommand: 清除日志

**功能：**
- ✅ 配置验证：启动前检查必需配置
- ✅ 确认对话框：防止误操作
- ✅ 实时更新：通过 Dispatcher 更新 UI
- ✅ 结果显示：同步完成后显示详细统计
- ✅ 异常处理：捕获并显示异常信息

### 3. 执行同步界面

更新 `SyncEkpToCasdoor.UI/MainWindow.xaml` - 第 3 个标签页

**界面布局：**

#### 控制面板
- **增量同步**按钮：绿色主题，启动增量同步
- **全量同步**按钮：橙色主题，警告性颜色
- **取消**按钮：红色主题，中止同步
- **清除日志**按钮：次要按钮，清理日志
- **进度条**：
  - 同步中：不确定进度条（动画效果）
  - 完成/待命：确定进度条（显示百分比）
- **状态信息**：左侧显示状态，右侧显示详细消息

#### 统计面板
6 列统计卡片：
- 组织数
- 用户数
- 成功数（绿色）
- 失败数（红色）
- 耗时（mm:ss 格式）
- 上次同步结果

#### 实时日志
- 列表框显示日志
- Consolas 等宽字体
- 支持横向和纵向滚动
- 最新日志在顶部
- 日志级别图标：🔍 ℹ️ ⚠️ ❌

**数据绑定：**
```xaml
<!-- 按钮绑定 -->
<Button Command="{Binding SyncExecutionViewModel.StartIncrementalSyncCommand}"
        IsEnabled="{Binding SyncExecutionViewModel.IsSyncing, 
                           Converter={StaticResource InverseBooleanConverter}}"/>

<!-- 进度条绑定 -->
<ProgressBar Value="{Binding SyncExecutionViewModel.ProgressPercentage}"
             IsIndeterminate="{Binding SyncExecutionViewModel.IsSyncing}"/>

<!-- 统计绑定 -->
<TextBlock Text="{Binding SyncExecutionViewModel.OrganizationCount}"/>

<!-- 日志绑定 -->
<ListBox ItemsSource="{Binding SyncExecutionViewModel.RealtimeLogs}"/>
```

### 4. MainViewModel 集成

更新 `SyncEkpToCasdoor.UI/ViewModels/MainViewModel.cs`

**新增属性：**
```csharp
[ObservableProperty]
private SyncExecutionViewModel _syncExecutionViewModel;
```

**初始化：**
```csharp
public MainViewModel()
{
    // ... 现有代码 ...
    
    // 初始化同步执行 ViewModel，并共享配置
    _syncExecutionViewModel = new SyncExecutionViewModel();
    _syncExecutionViewModel.Configuration = _configuration;
}
```

**配置共享：**
- MainViewModel 和 SyncExecutionViewModel 共享同一个 Configuration 对象
- 配置更改自动同步
- 保存配置时两者都会更新

## 技术改进

### 1. 进程管理
```csharp
// 查找可执行文件
private string FindSyncExecutable()
{
    var baseDir = AppDomain.CurrentDomain.BaseDirectory;
    var searchPaths = new[]
    {
        Path.Combine(baseDir, "SyncEkpToCasdoor.exe"),
        Path.Combine(baseDir, "..", "..", "..", "bin", "Release", "net8.0", "SyncEkpToCasdoor.exe"),
        Path.Combine(baseDir, "..", "..", "..", "bin", "Debug", "net8.0", "SyncEkpToCasdoor.exe"),
        Path.Combine(baseDir, "..", "SyncEkpToCasdoor", "bin", "Release", "net8.0", "SyncEkpToCasdoor.exe")
    };
    // ...
}
```

### 2. 环境变量配置
```csharp
private void SetEnvironmentVariables(Process process, SyncConfiguration config, bool isFullSync)
{
    var env = process.StartInfo.Environment;
    
    // 数据库连接
    env["EKP_SQLSERVER_CONN"] = config.EkpConnectionString;
    
    // Casdoor API
    env["CASDOOR_ENDPOINT"] = config.CasdoorEndpoint;
    env["CASDOOR_CLIENT_ID"] = config.CasdoorClientId;
    env["CASDOOR_CLIENT_SECRET"] = config.CasdoorClientSecret;
    env["CASDOOR_DEFAULT_OWNER"] = config.CasdoorOwner;
    
    // 全量同步标记
    if (isFullSync)
    {
        env["SYNC_SINCE_UTC"] = "1970-01-01T00:00:00Z";
    }
}
```

### 3. 输出解析
```csharp
private void ProcessOutputLine(string line)
{
    if (line.Contains("组织"))
    {
        _currentResult.OrganizationCount++;
        UpdateProgress();
    }
    else if (line.Contains("用户"))
    {
        _currentResult.UserCount++;
        UpdateProgress();
    }
    else if (line.Contains("成功"))
    {
        _currentResult.SuccessCount++;
    }
    else if (line.Contains("失败") || line.Contains("错误"))
    {
        _currentResult.ErrorCount++;
    }
}
```

### 4. UI 线程同步
```csharp
private void OnSyncProgressChanged(object? sender, SyncProgressEventArgs e)
{
    Application.Current.Dispatcher.Invoke(() =>
    {
        ProgressPercentage = e.Percentage;
        ProgressMessage = e.Message;
        StatusMessage = $"同步中... {e.Percentage}%";
    });
}
```

## 用户体验改进

...（内容同原文，已完整迁移）
