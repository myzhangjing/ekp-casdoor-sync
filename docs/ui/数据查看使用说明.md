# 数据查看功能使用说明

## 功能概述

**数据查看**模块让您无需登录 EKP 或 Casdoor 平台，就能直观查看和比对组织和用户数据。

### 核心功能
- ✅ **多数据源**：查看 EKP、Casdoor 或比对两者的数据
- ✅ **多视图**：组织视图和用户视图随意切换
- ✅ **实时查询**：直接从 EKP 数据库和 Casdoor API 获取最新数据
- ✅ **数据比对**：自动比对 EKP 和 Casdoor 的数据差异
- ✅ **搜索过滤**：按名称、邮箱、手机等关键字快速搜索
- ✅ **状态筛选**：筛选已同步、仅在 EKP、仅在 Casdoor 的数据
- ✅ **数据导出**：导出为 CSV 格式便于分析

## 界面说明

### 1. 工具栏

#### 数据源选择
| 数据源 | 说明 | 适用场景 |
|--------|------|----------|
| **EKP** | 显示 EKP 数据库中的原始数据 | 查看 EKP 系统的组织和用户 |
| **Casdoor** | 显示 Casdoor 系统中的数据 | 查看 Casdoor 中已同步的数据 |
| **比对** | 对比两个系统的数据差异 | 检查同步状态，发现未同步的数据 |

#### 视图类型
- **组织**：显示组织/部门列表
- **用户**：显示用户列表

#### 搜索框
- 支持模糊搜索
- 按 Enter 键执行搜索
- 搜索内容：
  - 组织视图：名称、显示名称、类型
  - 用户视图：用户名、显示名称、邮箱、手机

#### 操作按钮
- **加载**：首次加载数据
- **刷新**：重新从服务器获取最新数据
- **导出**：导出当前显示的数据为 CSV 文件

### 2. 统计信息栏

显示数据统计和同步状态：

| 统计项 | 说明 | 颜色 |
|--------|------|------|
| **已同步** | EKP 和 Casdoor 都存在的数据 | 绿色 |
| **仅 EKP** | 只在 EKP 中存在，未同步到 Casdoor | 橙色 |
| **仅 Casdoor** | 只在 Casdoor 中存在，EKP 中没有 | 红色 |

#### 筛选器
- **全部**：显示所有数据
- **已同步**：仅显示两边都有的数据
- **仅在 EKP**：仅显示未同步到 Casdoor 的数据
- **仅在 Casdoor**：仅显示 Casdoor 独有的数据

### 3. 数据表格

#### 组织视图列
| 列名 | 说明 |
|------|------|
| ID | 组织唯一标识 |
| 名称 | 组织名称（ID） |
| 显示名称 | 用户友好的显示名称 |
| 类型 | 组织类型（部门、公司等） |
| 成员数 | 该组织下的用户数量 |
| 启用 | 是否启用状态 |
| 数据来源 | EKP / Casdoor |
| 同步状态 | 已同步 / 仅在 EKP / 仅在 Casdoor |

**右键菜单**：
- 选中组织后右键 → "查看该组织的用户" → 自动切换到用户视图并过滤该组织的用户

#### 用户视图列
| 列名 | 说明 |
|------|------|
| ID | 用户唯一标识 |
| 用户名 | 登录用户名 |
| 显示名称 | 用户的真实姓名 |
| 邮箱 | 电子邮箱地址 |
| 手机 | 手机号码 |
| 组织 | 所属组织名称 |
| 启用 | 是否启用状态 |
| 数据来源 | EKP / Casdoor |
| 同步状态 | 已同步 / 仅在 EKP / 仅在 Casdoor |

## 使用场景

### 场景 1：查看 EKP 原始数据
```
目的：了解 EKP 系统中有多少组织和用户

步骤：
1. 数据源：选择 "EKP"
2. 视图：选择 "组织" 或 "用户"
3. 点击 "加载" 按钮
4. 查看数据表格

结果：
- 显示 EKP 数据库中的所有组织/用户
- 可以看到成员数量、启用状态等信息
```

### 场景 2：查看 Casdoor 同步结果
```
目的：检查 Casdoor 中已同步的数据

步骤：
1. 数据源：选择 "Casdoor"
2. 视图：选择 "组织" 或 "用户"
3. 点击 "加载" 按钮
4. 对比 EKP 和 Casdoor 的数据量

结果：
- 显示 Casdoor 系统中的所有数据
- 可以看到创建时间、头像等 Casdoor 特有信息
```

### 场景 3：比对同步状态（重要）
```
目的：发现未同步的数据，检查同步完整性

步骤：
1. 数据源：选择 "比对"
2. 视图：选择 "组织" 或 "用户"
3. 点击 "加载" 按钮
4. 查看统计栏：
   - 已同步：绿色数字
   - 仅 EKP：橙色数字（需要同步）
   - 仅 Casdoor：红色数字（可能是手动创建的）

5. 使用筛选器查看具体数据：
   - 筛选 "仅在 EKP" 查看哪些数据未同步
   - 筛选 "仅在 Casdoor" 查看哪些数据是 Casdoor 独有的

结果：
- 清楚了解同步状态
- 发现需要处理的数据
- 为下一次同步做准备
```

### 场景 4：搜索特定用户
```
目的：快速查找某个用户的同步状态

步骤：
1. 数据源：选择 "比对"
2. 视图：选择 "用户"
3. 点击 "加载" 按钮
4. 在搜索框输入用户名、姓名或邮箱
5. 按 Enter 或点击搜索
6. 查看搜索结果的 "同步状态" 列

结果：
- 快速定位目标用户
- 查看该用户是否已同步
- 了解用户的详细信息
```

### 场景 5：查看组织成员
```
目的：查看某个组织下有哪些用户

步骤：
1. 数据源：选择 "EKP" 或 "Casdoor"
2. 视图：选择 "组织"
3. 点击 "加载" 按钮
4. 找到目标组织，右键点击
5. 选择 "查看该组织的用户"
6. 自动切换到用户视图并显示该组织的用户

结果：
- 查看组织成员列表
- 了解成员数量和状态
```

### 场景 6：导出数据分析
```
目的：导出数据到 Excel 进行深入分析

步骤：
1. 选择数据源和视图
2. 点击 "加载" 按钮
3. （可选）使用搜索和筛选缩小范围
4. 点击 "导出" 按钮
5. 数据自动保存到桌面

结果：
- 生成 CSV 文件：数据导出_[数据源]_[视图]_[时间戳].csv
- 可以用 Excel 打开进行进一步分析
- 包含所有列的详细信息
```

## 数据比对详解

### 比对逻辑

#### 组织比对
```
匹配规则：EKP.fd_id == Casdoor.name

分类：
- 已同步：EKP 和 Casdoor 都存在该 ID
- 仅在 EKP：EKP 有但 Casdoor 没有（待同步）
- 仅在 Casdoor：Casdoor 有但 EKP 没有（手动创建或 EKP 已删除）
```

#### 用户比对
```
匹配规则：EKP.fd_login_name == Casdoor.name

分类：
- 已同步：两边都存在该用户名
- 仅在 EKP：EKP 有但 Casdoor 没有（待同步）
- 仅在 Casdoor：Casdoor 有但 EKP 没有（手动创建或 EKP 已删除）
```

### 同步状态说明

| 状态 | 颜色 | 说明 | 操作建议 |
|------|------|------|----------|
| **已同步** | 绿色 | 数据已正常同步 | 无需处理，定期增量同步维护 |
| **仅在 EKP** | 橙色 | EKP 中新增的数据 | 执行增量同步或全量同步 |
| **仅在 Casdoor** | 红色 | Casdoor 中独有的数据 | 检查是否手动创建，确认是否需要保留 |

### 常见比对结果分析

#### 情况 1：大量"仅在 EKP"
```
原因：
- 首次同步前
- 长时间未同步
- 上次同步失败

解决方案：
1. 执行全量同步
2. 检查同步配置
3. 查看同步日志确认错误
```

#### 情况 2：少量"仅在 EKP"
```
原因：
- EKP 新增了组织/用户
- 正常的增量同步场景

解决方案：
1. 执行增量同步
2. 数据会自动同步到 Casdoor
```

#### 情况 3：存在"仅在 Casdoor"
```
原因：
- 在 Casdoor 中手动创建了组织/用户
- EKP 中删除了某些数据

解决方案：
1. 如果是手动创建的，保留即可
2. 如果是 EKP 删除的，考虑在 Casdoor 中也删除
3. 或者调整同步规则
```

## 技术细节

### 数据来源

#### EKP 数据
```sql
-- 组织查询
SELECT fd_id, fd_name, fd_org_type, fd_parentid, 
       fd_order, fd_is_available
FROM sys_org_element
WHERE fd_is_business = 1

-- 用户查询
SELECT p.fd_id, p.fd_login_name, p.fd_name, 
       p.fd_email, p.fd_mobile_no, p.fd_org_id,
       o.fd_name as org_name
FROM sys_org_person p
LEFT JOIN sys_org_element o ON p.fd_org_id = o.fd_id
```

#### Casdoor 数据
```http
GET /api/get-organizations?owner={owner}
Authorization: Bearer {access_token}

GET /api/get-users?owner={owner}
Authorization: Bearer {access_token}
```

### 性能考虑

- **查询优化**：使用索引字段查询
- **分页加载**：大数据量时建议使用筛选器
- **缓存机制**：数据加载后缓存在内存中
- **异步操作**：所有网络请求都是异步的，不阻塞 UI

### 数据刷新

- 点击"刷新"按钮重新从服务器获取数据
- 修改配置后建议刷新数据
- 执行同步后建议刷新查看结果

## 常见问题

### Q1：点击加载没有反应
**问题**：点击"加载"按钮后没有数据显示

**原因**：
1. 配置不完整
2. 网络连接问题
3. 数据库/API 访问权限不足

**解决方案**：
1. 检查"配置管理"页面的配置是否完整
2. 使用"测试连接"功能验证连接
3. 查看状态栏的错误提示
4. 检查防火墙和网络设置

### Q2：加载速度很慢
**问题**：数据加载需要很长时间

**原因**：
1. 数据量大
2. 网络延迟
3. 服务器响应慢

**优化方法**：
1. 使用筛选器减少数据量
2. 优化数据库查询（添加索引）
3. 检查网络连接质量
4. 考虑分批加载

### Q3：比对结果不准确
**问题**："已同步"数量与实际不符

**可能原因**：
1. 匹配规则的理解偏差
2. 数据不一致（如 ID 不匹配）
3. 缓存数据过期

**解决方案**：
1. 点击"刷新"获取最新数据
2. 检查 EKP 和 Casdoor 的 ID 映射关系
3. 执行全量同步重新对齐数据

### Q4：导出的 CSV 文件乱码
**问题**：Excel 打开 CSV 文件显示乱码

**原因**：编码问题

**解决方案**：
1. 使用 Excel 的"数据" → "从文本/CSV"导入功能
2. 选择 UTF-8 编码
3. 或使用记事本/VSCode 等工具打开查看

### Q5：某些字段显示为空
**问题**：部分字段（如邮箱、手机）显示为空

**原因**：
1. 数据库中该字段本身就是空的
2. 用户权限不足，无法查询某些敏感字段
3. 字段映射配置问题

**解决方案**：
1. 检查 EKP 数据库中的原始数据
2. 确认数据库用户权限
3. 检查字段映射配置

## 最佳实践

### 1. 同步前检查
```
建议流程：
1. 数据查看 → 选择"比对" → 加载组织
2. 查看统计：仅在 EKP 的数量
3. 使用筛选器查看具体数据
4. 确认需要同步的数据
5. 切换到"执行同步"页面 → 执行同步
6. 返回"数据查看"页面 → 刷新 → 验证结果
```

### 2. 定期巡检
```
建议频率：每天或每周

检查内容：
1. 已同步数量是否增长
2. 仅在 EKP 数量是否异常增多
3. 仅在 Casdoor 数量是否有异常数据
4. 搜索重点用户确认状态
```

### 3. 问题排查
```
当发现同步问题时：
1. 数据查看 → 比对模式 → 搜索问题数据
2. 查看该数据的详细信息
3. 对比 EKP 和 Casdoor 的数据差异
4. 导出数据进行深入分析
5. 根据分析结果调整同步策略
```

### 4. 数据审计
```
定期导出数据：
1. 每月导出一次完整数据
2. 保存为档案备份
3. 用于数据分析和趋势统计
4. 用于合规性审计
```

## 下一步

使用数据查看功能后，您可以：
1. ✅ 发现未同步的数据 → 执行同步
2. ✅ 验证同步结果 → 确保数据一致性
3. ✅ 导出数据报告 → 向管理层汇报
4. ✅ 定期巡检 → 建立数据质量监控机制

---

**💡 提示**：
- 数据查看不会修改任何数据，可以放心使用
- 建议在执行同步前后都使用数据查看功能
- 导出的数据可用于审计和分析
- 发现数据异常时，先用数据查看功能定位问题
