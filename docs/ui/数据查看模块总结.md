# 数据查看模块开发总结

## 版本信息
- **更新日期**: 2025-10-30
- **版本**: v1.2.0
- **新增功能**: 数据查看与比对

## 新增内容

### 1. 数据模型

#### OrganizationInfo.cs
组织信息模型，包含：
- 基本信息：ID、名称、显示名称、类型
- 层级关系：ParentId、Order
- 状态信息：IsEnabled、CreatedTime、UpdatedTime
- 统计数据：MemberCount
- 同步信息：Source（EKP/Casdoor）、SyncStatus

#### UserInfo.cs
用户信息模型，包含：
- 基本信息：ID、用户名、显示名称
- 联系方式：Email、Phone
- 组织关系：OrganizationId、OrganizationName
- 权限信息：IsAdmin、IsEnabled
- 时间记录：CreatedTime、UpdatedTime、LastLoginTime
- 同步信息：Source、SyncStatus、Avatar

### 2. 数据服务 (DataViewService.cs)

#### EKP 数据查询
```csharp
// 获取 EKP 组织列表
Task<List<OrganizationInfo>> GetEkpOrganizationsAsync(SyncConfiguration)

// 获取 EKP 用户列表（支持按组织过滤）
Task<List<UserInfo>> GetEkpUsersAsync(SyncConfiguration, organizationId?)
```

**特点**：
- 直接查询 EKP SQL Server 数据库
- 查询 `sys_org_element` 和 `sys_org_person` 表
- 自动计算组织成员数量
- 支持按组织ID过滤用户

#### Casdoor 数据查询
```csharp
// 获取 Casdoor 组织列表
Task<List<OrganizationInfo>> GetCasdoorOrganizationsAsync(SyncConfiguration)

// 获取 Casdoor 用户列表（支持按组织过滤）
Task<List<UserInfo>> GetCasdoorUsersAsync(SyncConfiguration, organizationName?)
```

**特点**：
- 调用 Casdoor REST API
- 使用 OAuth2 认证（简化实现）
- 解析 JSON 响应数据
- 支持按组织名称过滤用户

#### 数据比对功能
```csharp
// 比对组织数据
Task<(List<OrganizationInfo> EkpOnly, 
      List<OrganizationInfo> CasdoorOnly, 
      List<OrganizationInfo> Both)> CompareOrganizationsAsync(SyncConfiguration)

// 比对用户数据
Task<(List<UserInfo> EkpOnly, 
      List<UserInfo> CasdoorOnly, 
      List<UserInfo> Both)> CompareUsersAsync(SyncConfiguration, organizationId?)
```

**比对逻辑**：
- 组织匹配：EKP.fd_id == Casdoor.name
- 用户匹配：EKP.fd_login_name == Casdoor.name
- 返回三类数据：仅在 EKP、仅在 Casdoor、两边都有

### 3. 视图模型 (DataViewViewModel.cs)

#### 核心属性
```csharp
// 配置
SyncConfiguration Configuration

// 数据源和视图
string SelectedDataSource    // EKP / Casdoor / 比对
string SelectedView          // 组织 / 用户

// 数据集合
ObservableCollection<OrganizationInfo> Organizations
ObservableCollection<UserInfo> Users

// 搜索和过滤
string SearchText
string FilterStatus          // 全部 / 已同步 / 仅在 EKP / 仅在 Casdoor

// 统计
int TotalOrganizations / TotalUsers
int EkpOnlyCount
int CasdoorOnlyCount
int SyncedCount

// 状态
bool IsLoading
string StatusMessage
```

#### 核心命令
```csharp
LoadDataCommand              // 加载数据
RefreshCommand              // 刷新数据
SearchCommand               // 搜索
SwitchViewCommand           // 切换视图（组织/用户）
SwitchDataSourceCommand     // 切换数据源
ViewOrganizationUsersCommand // 查看组织用户
ExportDataCommand           // 导出数据
```

#### 核心功能
1. **数据加载**
   - 根据数据源调用不同服务
   - 异步加载不阻塞 UI
   - 显示加载进度和状态

2. **数据过滤**
   - 搜索：支持模糊匹配多个字段
   - 筛选：按同步状态过滤
   - 实时更新显示结果

3. **数据导出**
   - 导出为 CSV 格式
   - UTF-8 编码
   - 保存到桌面，文件名包含时间戳

### 4. 用户界面 (MainWindow.xaml 新增标签页)

#### 工具栏区域
```xaml
- 数据源选择：ComboBox（EKP / Casdoor / 比对）
- 视图类型：ComboBox（组织 / 用户）
- 搜索框：TextBox + Enter 键绑定
- 操作按钮：加载 / 刷新 / 导出
```

#### 统计信息栏
```xaml
- 状态消息：显示当前操作状态
- 比对统计（仅"比对"模式）：
  - 已同步（绿色）
  - 仅 EKP（橙色）
  - 仅 Casdoor（红色）
- 状态筛选器：ComboBox
```

#### 数据表格区域
```xaml
组织视图 (DataGrid):
- 8 列：ID / 名称 / 显示名称 / 类型 / 成员数 / 启用 / 数据来源 / 同步状态
- 右键菜单：查看该组织的用户

用户视图 (DataGrid):
- 9 列：ID / 用户名 / 显示名称 / 邮箱 / 手机 / 组织 / 启用 / 数据来源 / 同步状态

加载指示器：
- 半透明遮罩
- 圆形进度条
- 状态消息
```

## 技术亮点

### 1. 多数据源架构
```
DataViewService
├── EKP 数据查询    → SQL Server
├── Casdoor 数据查询 → REST API
└── 数据比对        → 内存对比
```

### 2. 响应式设计
- 数据加载时显示进度指示器
- 搜索和筛选实时更新
- 异步操作不阻塞 UI

### 3. 智能比对
- 自动匹配 EKP 和 Casdoor 数据
- 三分类展示：已同步 / 仅 EKP / 仅 Casdoor
- 彩色标识便于识别

### 4. 灵活导出
- CSV 格式兼容 Excel
- UTF-8 编码支持中文
- 文件名包含时间戳和元数据

### 5. 用户体验
- 右键菜单快速查看组织用户
- Enter 键快速搜索
- 状态栏实时反馈
- 颜色编码直观显示

## 使用价值

### 1. 无需登录平台
- 不用登录 EKP 查看组织架构
- 不用登录 Casdoor 查看用户数据
- 集中式查看所有数据

### 2. 同步状态监控
- 实时比对数据差异
- 发现未同步的数据
- 验证同步完整性

### 3. 数据审计
- 导出数据用于分析
- 追踪数据变化
- 合规性审查

### 4. 问题排查
- 快速定位问题数据
- 搜索特定用户/组织
- 比对数据差异

## 应用场景

### 场景 1：首次部署验证
```
1. 查看 EKP 原始数据量
2. 执行全量同步
3. 查看 Casdoor 同步结果
4. 使用"比对"模式验证
5. 确认所有数据已同步
```

### 场景 2：日常监控
```
1. 每天打开"数据查看"
2. 选择"比对"模式
3. 查看"仅在 EKP"数量
4. 如有新增，执行增量同步
5. 刷新验证同步结果
```

### 场景 3：问题排查
```
1. 用户反馈无法登录 Casdoor
2. 打开"数据查看"
3. 搜索该用户
4. 查看同步状态
5. 确认是否同步成功
6. 根据结果处理问题
```

### 场景 4：数据审计
```
1. 每月导出一次数据
2. 对比上月数据
3. 统计新增/变更/删除
4. 生成数据报告
5. 向管理层汇报
```

### 场景 5：组织重构
```
1. EKP 调整组织架构
2. 查看"比对"模式
3. 确认哪些组织有变化
4. 执行同步
5. 验证组织成员关系
```

## 性能优化

### 1. 缓存机制
- 加载的数据缓存在内存
- 搜索和筛选不重新查询
- 点击刷新才重新加载

### 2. 异步操作
- 所有网络请求异步执行
- UI 线程不阻塞
- 显示加载进度

### 3. 按需加载
- 支持按组织过滤用户
- 减少不必要的数据传输
- 提高响应速度

### 4. 数据结构优化
- 使用 Dictionary 加速比对
- O(1) 查找复杂度
- 减少内存占用

## 已知限制

### 1. OAuth2 简化实现
- 当前使用简化的认证流程
- 某些 Casdoor 配置可能需要完整 OAuth2
- 未来版本将完善认证机制

### 2. 全量加载
- 当前一次加载所有数据
- 大数据量（10000+ 用户）可能较慢
- 未来考虑分页加载

### 3. 只读查看
- 不支持直接编辑数据
- 不支持在线同步操作
- 需要切换到"执行同步"页面

## 未来增强

### 短期计划
1. ✅ 添加组织树形视图
2. ✅ 支持多选导出
3. ✅ 添加数据详情面板
4. ✅ 支持列排序

### 中期计划
1. ✅ 分页加载大数据集
2. ✅ 高级搜索（多条件）
3. ✅ 数据变更历史记录
4. ✅ 导出 Excel 格式

### 长期计划
1. ✅ 数据可视化（图表统计）
2. ✅ 实时同步监控
3. ✅ 数据版本控制
4. ✅ 批量操作功能

## 测试建议

### 功能测试
- [ ] 加载 EKP 组织数据
- [ ] 加载 EKP 用户数据
- [ ] 加载 Casdoor 组织数据
- [ ] 加载 Casdoor 用户数据
- [ ] 比对组织数据
- [ ] 比对用户数据
- [ ] 搜索功能
- [ ] 筛选功能
- [ ] 导出功能
- [ ] 查看组织用户
- [ ] 刷新功能

### 性能测试
- [ ] 1000+ 组织加载时间
- [ ] 10000+ 用户加载时间
- [ ] 搜索响应时间
- [ ] 筛选响应时间
- [ ] 比对计算时间
- [ ] 内存占用情况

### 兼容性测试
- [ ] EKP 不同版本
- [ ] Casdoor 不同版本
- [ ] 不同网络环境
- [ ] 不同数据库版本

## 文档更新

新增文档：
- `数据查看使用说明.md`：完整的功能使用指南（4000+ 字）
  - 功能概述
  - 界面说明
  - 使用场景（6个）
  - 数据比对详解
  - 技术细节
  - 常见问题
  - 最佳实践

## 总结

数据查看模块为用户提供了：
- ✅ **透明性**：随时查看数据状态
- ✅ **可追溯性**：比对数据差异
- ✅ **便捷性**：无需登录多个平台
- ✅ **可审计性**：导出数据报告

这个模块大大提升了系统的可用性和可维护性，用户可以更自信地使用同步工具！

---

**🎉 数据查看模块开发完成！**
