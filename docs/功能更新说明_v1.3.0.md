# 功能更新说明 - v1.3.0

**更新日期**：2025-10-31

## 🎯 本次更新概览

本次更新修复了3个重要问题，并新增了OAuth2登录功能，提升了用户体验和数据准确性。

---

## ✅ 修复的问题

### 1. 清空Casdoor需要点击两次的问题

**问题现象**：
- 点击"清空Casdoor"按钮第一次，只清空了用户数据
- 需要再点击第二次，才能清空组织数据

**根本原因**：
删除操作后，Casdoor需要时间更新内部索引，立即执行第二步操作会因为索引未更新而部分失败。

**解决方案**：
在 `DataViewService.cs` 的 `ClearCasdoorDataAsync` 方法中添加等待机制：
- 删除用户后等待2秒，确保Casdoor完成索引更新
- 删除组织后再等待2秒，确保所有删除操作完成

**修改文件**：
- `SyncEkpToCasdoor.UI/Services/DataViewService.cs` (Lines 430-495)

**测试验证**：
✅ 清空操作现在一次点击即可完成，无需重复操作

---

### 2. 全量同步统计数量不准确的问题

**问题现象**：
- 执行全量同步后，数据实际已同步完成
- 但统计结果显示的用户和组织数量不正确

**根本原因**：
`SyncEngineService.cs` 中的 `ProcessOutputLine` 方法使用简单的关键字匹配来统计，不够精确：
```csharp
// 旧代码（不准确）
if (line.Contains("组织") && line.Contains("更新"))
{
    result.OrganizationCount++;
}
```

这种方式会错误地统计进度消息，而非最终结果。

**解决方案**：
使用正则表达式精确解析控制台程序的输出：
```csharp
// 新代码（精确匹配）
if (line.Contains("组织同步完成，共处理") && line.Contains("条记录"))
{
    var match = Regex.Match(line, @"共处理\s+(\d+)\s+条记录");
    if (match.Success && int.TryParse(match.Groups[1].Value, out int count))
    {
        result.OrganizationCount = count;
    }
}
```

**修改文件**：
- `SyncEkpToCasdoor.UI/Services/SyncEngineService.cs` (Lines 236-270)

**测试验证**：
✅ 统计数据现在准确显示实际同步的组织和用户数量

---

## 🆕 新增功能

### 3. OAuth2 登录页面

**功能说明**：
新增基于Casdoor的OAuth2认证机制，用户需要在浏览器中完成登录授权后才能使用同步工具。

**实现内容**：

#### 📄 新增文件

1. **LoginWindow.xaml** - 登录窗口界面
   - 现代化设计，渐变背景
   - 清晰的操作提示
   - 支持浏览器自动打开和手动授权码输入

2. **LoginWindow.xaml.cs** - 登录窗口代码后台
   - 处理窗口交互逻辑
   - 管理登录成功/失败状态

3. **LoginViewModel.cs** - 登录视图模型
   - OAuth2授权码流程完整实现
   - 自动选择最佳回调方式
   - HttpListener接收回调（如果支持）
   - 手动授权码输入备用方案
   - 访问令牌获取与保存

4. **UriSchemeRegistrar.cs** - URI Scheme 注册服务
   - 注册 `ekpsync://` 自定义协议
   - 解析回调 URI 参数
   - 支持注册/注销操作

#### ⚙️ 修改文件

- **App.xaml.cs**：添加启动时登录检查和回调处理
  - 检查是否需要登录（基于环境变量配置）
  - 处理 URI Scheme 启动参数（ekpsync://callback?code=xxx）
  - 显示登录窗口（模态对话框）
  - 保存访问令牌到应用程序属性

#### 🔐 OAuth2 流程

**支持三种回调方式**（按优先级）：

1. **自定义 URI Scheme**（推荐⭐⭐⭐⭐⭐）
   - 注册 `ekpsync://` 协议
   - 浏览器授权后自动唤起应用
   - 完全自动化，无需手动操作

2. **HttpListener 本地回调**
   - 监听 `http://localhost:9000/callback`
   - 浏览器重定向到本地地址
   - 可能需要权限或受防火墙影响

3. **手动输入授权码**（兜底方案）
   - 用户复制粘贴授权码
   - 100% 兼容性

**完整流程**：
```
1. 用户启动应用 
   ↓
2. 自动注册 URI Scheme（ekpsync://）
   ↓
3. 检查配置（CASDOOR_ENDPOINT, CASDOOR_CLIENT_ID）
   ↓
4. 显示登录窗口
   ↓
5. 用户点击"使用Casdoor登录"
   ↓
6. 浏览器打开授权页面（redirect_uri=ekpsync://callback）
   ↓
7. 用户在浏览器中登录并授权
   ↓
8. Casdoor 重定向到 ekpsync://callback?code=xxx
   ↓
9. [自动] Windows 唤起应用，传递授权码
   ↓
10. 应用解析授权码，换取访问令牌
   ↓
11. 保存令牌，关闭登录窗口，进入主界面
```

#### 🎨 界面特性

- ✅ 响应式布局，居中显示
- ✅ 实时状态提示（加载中、成功、失败）
- ✅ 错误信息友好展示
- ✅ 支持两种登录方式：
  - **自动回调**：浏览器授权后自动返回（推荐）
  - **手动输入**：复制授权码粘贴（备用方案）

#### ⚙️ 配置说明

**环境变量**（用于登录）：
```powershell
$env:CASDOOR_ENDPOINT = "http://sso.fzcsps.com"
$env:CASDOOR_CLIENT_ID = "aecd00a352e5c560ffe6"
$env:CASDOOR_CLIENT_SECRET = "your-secret"
```

**OAuth2 参数**：
- **授权URL**: `{CASDOOR_ENDPOINT}/login/oauth/authorize`
- **令牌URL**: `{CASDOOR_ENDPOINT}/api/login/oauth/access_token`
- **回调地址**: 
  - 优先：`ekpsync://callback` （自定义 URI Scheme）
  - 备用：`http://localhost:9000/callback` （HttpListener）
- **授权范围**: `read`
- **响应类型**: `code` (授权码模式)

#### 📝 使用说明

1. **首次启动**：
   - 应用启动时自动弹出登录窗口
   - 点击"使用Casdoor登录"按钮
   - 浏览器自动打开授权页面

2. **浏览器授权**：
   - 在Casdoor登录页面输入用户名和密码
   - 点击"授权"按钮
   - 授权成功后浏览器显示成功页面
   - 应用自动接收回调并完成登录

3. **手动输入（备用）**：
   - 如果浏览器未自动打开，点击"手动输入授权码"
   - 复制浏览器地址栏中的授权URL
   - 手动访问该URL并完成授权
   - 复制回调URL中的`code`参数值
   - 粘贴到应用中的"授权码"输入框
   - 点击"使用授权码登录"

#### 🔒 安全说明

- ✅ 访问令牌存储在应用程序内存中（`Application.Current.Properties`）
- ⚠️ 当前版本为简化实现，未持久化令牌
- 📋 TODO: 后续可改为存储到Windows凭据管理器或加密文件

#### 🚫 向后兼容

如果环境变量未配置完整（缺少 `CASDOOR_ENDPOINT` 或 `CASDOOR_CLIENT_ID`），将跳过登录流程，直接进入主界面，保持向后兼容性。

---

## 📊 测试结果

| 功能项 | 测试状态 | 说明 |
|--------|---------|------|
| 清空Casdoor一次完成 | ✅ 通过 | 添加等待机制后，单次操作即可完成 |
| 全量同步统计准确 | ✅ 通过 | 正则解析输出，数据准确 |
| OAuth2登录流程 | ✅ 编译通过 | 代码无错误，待实际环境测试 |
| 浏览器自动回调 | ⏳ 待测试 | 需要实际运行验证HttpListener |
| 手动授权码登录 | ⏳ 待测试 | 需要实际运行验证UI交互 |

---

## 📦 发布信息

**版本号**：v1.3.0  
**编译状态**：✅ 成功（Release模式，2警告）  
**警告内容**：
- `OrganizationTreeNode.cs(67,20)`: 可能的null引用赋值（不影响功能）
- `EkpViewSetupService.cs(104,21)`: 取消装箱可能为null（不影响功能）

---

## 🔄 升级指南

### 从 v1.2.x 升级到 v1.3.0

1. **更新程序文件**：
   ```powershell
   # 重新编译
   dotnet build SyncEkpToCasdoor.sln -c Release
   
   # 复制新版本
   copy SyncEkpToCasdoor.UI\bin\Release\net8.0-windows\* <目标目录>
   ```

2. **配置OAuth2（可选）**：
   ```powershell
   # 如果需要使用登录功能，配置系统环境变量
   [System.Environment]::SetEnvironmentVariable("CASDOOR_ENDPOINT", "http://sso.fzcsps.com", "Machine")
   [System.Environment]::SetEnvironmentVariable("CASDOOR_CLIENT_ID", "aecd00a352e5c560ffe6", "Machine")
   [System.Environment]::SetEnvironmentVariable("CASDOOR_CLIENT_SECRET", "your-secret", "Machine")
   ```

3. **重启应用**：
   - 如果配置了OAuth2环境变量，启动时会显示登录窗口
   - 否则直接进入主界面（保持兼容）

---

## 🐛 已知问题

1. **HttpListener权限**：
   - 在某些Windows系统上，HttpListener可能需要管理员权限
   - 解决方案：使用"手动输入授权码"方式

2. **防火墙阻止**：
   - 防火墙可能阻止localhost:9000端口
   - 解决方案：添加防火墙例外或使用手动输入

3. **令牌持久化**：
   - 当前版本令牌仅保存在内存中，应用重启需要重新登录
   - 计划：后续版本实现令牌持久化

---

## 📞 反馈与支持

如果遇到问题或有改进建议，请：
- 提交 [GitHub Issue](https://github.com/myzhangjing/ekp-casdoor-sync/issues)
- 查看 [项目文档](../../README.md)
- 查看 [监控指南](../monitoring/README.md)

---

## 📅 下一步计划

- [ ] 实际环境测试OAuth2登录功能
- [ ] 实现访问令牌持久化（Windows凭据管理器）
- [ ] 添加令牌刷新机制
- [ ] 添加"记住我"选项
- [ ] 优化清空操作进度提示
- [ ] 添加同步统计图表

---

**祝您使用愉快！** 🎉
