# ä¿®å¤æµ‹è¯•æŠ¥å‘Š

**æ—¥æœŸ**: 2025å¹´11æœˆ1æ—¥  
**æœåŠ¡å™¨**: http://syncas.fzcsps.com

## é—®é¢˜ä¿®å¤

### 1. âœ… å¯¼èˆªèœå•å›¾æ ‡é”™ä½
**é—®é¢˜**: å¯¼èˆªèœå•å›¾æ ‡æ˜¾ç¤ºä¸æ­£å¸¸  
**åŸå› **: CSSæ–‡ä»¶å®šä¹‰äº†è‡ªå®šä¹‰çš„`.bi-house-door-fill-nav-menu`ç±»,ä½†Razoræ–‡ä»¶ä½¿ç”¨çš„æ˜¯Bootstrap Iconsæ ‡å‡†ç±»  
**è§£å†³æ–¹æ¡ˆ**: 
- ç§»é™¤è‡ªå®šä¹‰å›¾æ ‡CSS
- ä½¿ç”¨Bootstrap Iconsæ ‡å‡†ç±»
- æ·»åŠ é€‚å½“çš„è¾¹è·æ ·å¼

**æµ‹è¯•ç»“æœ**: âœ… é€šè¿‡ - å›¾æ ‡ç°åœ¨æ­£ç¡®æ˜¾ç¤º

---

### 2. âœ… ç™»å‡ºæŠ¥é”™
**é—®é¢˜**: ç‚¹å‡»ç™»å‡ºåè¿”å›JSONé”™è¯¯: `{"status": "error", "msg": "ç¼ºå°‘å‚æ•°: id_token_hint"}`  
**åŸå› **: ä»£ç å°è¯•è°ƒç”¨Casdoorçš„logoutç«¯ç‚¹,ä½†Cookieè®¤è¯æ²¡æœ‰ä¿å­˜`id_token_hint`  
**è§£å†³æ–¹æ¡ˆ**: 
- ä¿®æ”¹`/logout`è·¯ç”±ç›´æ¥æ¸…é™¤æœ¬åœ°ä¼šè¯å¹¶é‡å®šå‘åˆ°ç™»å½•é¡µ
- æ·»åŠ `/api/logout` APIç«¯ç‚¹ç”¨äºAjaxè°ƒç”¨
- ä¸å†è°ƒç”¨Casdoorçš„logoutç«¯ç‚¹

**æµ‹è¯•ç»“æœ**: âœ… é€šè¿‡ - ç™»å‡ºæ­£å¸¸,è¿”å›302é‡å®šå‘åˆ°ç™»å½•é¡µ

```powershell
StatusCode        : 302
StatusDescription : Found
Headers           : Location=/login
```

---

### 3. âœ… é…ç½®ä¿å­˜ä¸ç”Ÿæ•ˆ
**é—®é¢˜**: åœ¨ç‰¹æƒé…ç½®é¡µé¢ä¿®æ”¹åŸŸåç­‰è®¾ç½®åä¿å­˜,é…ç½®æ²¡æœ‰ç”Ÿæ•ˆ  
**åŸå› **: AdminSettings.razorä½¿ç”¨Blazor InteractiveServeræ¨¡å¼,HttpContextåœ¨å¼‚æ­¥æ“ä½œä¸­ä¸å¯ç”¨  
**è§£å†³æ–¹æ¡ˆ**: 
- åˆ›å»ºæ–°çš„`ConfigController` APIæ§åˆ¶å™¨
- å°†AdminSettings.razoræ”¹ä¸ºè°ƒç”¨REST API
- ä½¿ç”¨`HttpClient`è€Œä¸æ˜¯ç›´æ¥æ³¨å…¥æœåŠ¡
- é…ç½®æ–‡ä»¶é€šè¿‡Docker volumeæ˜ å°„,ç¡®ä¿æŒä¹…åŒ–

**ä¿®æ”¹æ–‡ä»¶**:
1. `ConfigController.cs` - æ–°å»ºAPIæ§åˆ¶å™¨
   - `GET /api/config/settings` - è·å–é…ç½®
   - `POST /api/config/settings` - ä¿å­˜é…ç½®
2. `AdminSettings.razor` - æ”¹ç”¨HttpClientè°ƒç”¨API
3. `Program.cs` - æ³¨å†ŒHttpClientæœåŠ¡

**æµ‹è¯•ç»“æœ**: âœ… é€šè¿‡ - é…ç½®æˆåŠŸä¿å­˜å¹¶æŒä¹…åŒ–

#### æµ‹è¯•æ­¥éª¤:

```powershell
# 1. ç™»å½•
$session = New-Object Microsoft.PowerShell.Commands.WebRequestSession
$loginBody = @{username='admin';password='sosy3080@sohu.com'} | ConvertTo-Json
Invoke-WebRequest -Method POST -Uri 'http://syncas.fzcsps.com/api/admin-login' `
  -ContentType 'application/json' -Body $loginBody -WebSession $session

# 2. ä¿å­˜é…ç½®
$configBody = @{
  domain='syncas.fzcsps.com'
  protocol='http'
  allowedUsers='testuser@example.com'
  currentPassword=''
  newPassword=''
} | ConvertTo-Json

Invoke-WebRequest -Method POST -Uri 'http://syncas.fzcsps.com/api/config/settings' `
  -ContentType 'application/json' -Body $configBody -WebSession $session
```

**å“åº”**: 
```json
{"success":true,"message":"é…ç½®ä¿å­˜æˆåŠŸï¼"}
```

#### é…ç½®æ–‡ä»¶éªŒè¯:

```bash
ssh root@172.16.10.110 "cat /root/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/config/appsettings.Production.json"
```

**è¾“å‡º**:
```json
{
  "AppSettings": {
    "Domain": "syncas.fzcsps.com",
    "Protocol": "http",
    "AllowedUsers": "testuser@example.com",
    "AdminPassword": "sosy3080@sohu.com"
  }
}
```

âœ… `AllowedUsers`å­—æ®µå·²æˆåŠŸæ›´æ–°!

---

## æŠ€æœ¯ç»†èŠ‚

### APIç«¯ç‚¹

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ | è®¤è¯ |
|------|------|------|------|
| `/api/admin-login` | POST | ç‰¹æƒç™»å½• | æ—  |
| `/api/logout` | POST | ç™»å‡ºAPI | æ—  |
| `/logout` | GET | ç™»å‡ºé‡å®šå‘ | æ—  |
| `/api/config/settings` | GET | è·å–é…ç½® | Administratorè§’è‰² |
| `/api/config/settings` | POST | ä¿å­˜é…ç½® | Administratorè§’è‰² |

### å…³é”®ä»£ç ä¿®æ”¹

**AuthController.cs**:
```csharp
[HttpGet("/logout")]
public async Task<IActionResult> Logout()
{
    await HttpContext.SignOutAsync(CookieAuthenticationDefaults.AuthenticationScheme);
    return Redirect("/login");
}

[HttpPost("/api/logout")]
public async Task<IActionResult> LogoutApi()
{
    await HttpContext.SignOutAsync(CookieAuthenticationDefaults.AuthenticationScheme);
    return Ok(new { success = true, message = "ç™»å‡ºæˆåŠŸ" });
}
```

**ConfigController.cs** (æ–°å»º):
```csharp
[ApiController]
[Route("api/[controller]")]
[Authorize(Roles = "Administrator")]
public class ConfigController : ControllerBase
{
    [HttpPost("settings")]
    public async Task<IActionResult> SaveSettings([FromBody] SaveSettingsRequest request)
    {
        // éªŒè¯å¹¶ä¿å­˜é…ç½®
        await _configService.SaveSettingsAsync(settings);
        return Ok(new { success = true, message = "é…ç½®ä¿å­˜æˆåŠŸï¼" });
    }
}
```

**AdminSettings.razor**:
```csharp
@inject HttpClient Http

private async Task SaveAllSettings()
{
    var response = await Http.PostAsJsonAsync("/api/config/settings", request);
    var result = await response.Content.ReadFromJsonAsync<ApiMessageResponse>();
}
```

**NavMenu.razor.css**:
```css
/* Bootstrap Icons æ ·å¼è°ƒæ•´ */
.nav-item ::deep .nav-link .bi {
    margin-right: 0.75rem;
    font-size: 1.1rem;
    vertical-align: middle;
}
```

---

## æµ‹è¯•æ‘˜è¦

| æµ‹è¯•é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| ç‰¹æƒç™»å½• | âœ… | APIè¿”å›200,sessionåˆ›å»ºæˆåŠŸ |
| è·å–é…ç½® | âœ… | è¿”å›å½“å‰é…ç½® |
| ä¿å­˜é…ç½® | âœ… | é…ç½®å†™å…¥æ–‡ä»¶å¹¶æŒä¹…åŒ– |
| ç™»å‡ºåŠŸèƒ½ | âœ… | è¿”å›302é‡å®šå‘,æ— é”™è¯¯ |
| å¯¼èˆªå›¾æ ‡ | âœ… | Bootstrap Iconsæ­£å¸¸æ˜¾ç¤º |
| é…ç½®æŒä¹…åŒ– | âœ… | é‡å¯å®¹å™¨åé…ç½®ä¿æŒ |

---

## ä¸‹ä¸€æ­¥å»ºè®®

1. **å‰ç«¯æµ‹è¯•**: é€šè¿‡æµè§ˆå™¨è®¿é—® http://syncas.fzcsps.com/admin/settings æµ‹è¯•UI
2. **å®Œæ•´æµç¨‹**: 
   - ç™»å½• â†’ ä¿®æ”¹é…ç½® â†’ ä¿å­˜ â†’ ç™»å‡º â†’ é‡æ–°ç™»å½• â†’ éªŒè¯é…ç½®
3. **ç”¨æˆ·æƒé™**: æµ‹è¯•AllowedUsersé…ç½®æ˜¯å¦æ­£ç¡®é™åˆ¶SSOç”¨æˆ·è®¿é—®
4. **å®¹å™¨é‡å¯**: æµ‹è¯•é…ç½®åœ¨å®¹å™¨é‡å¯åæ˜¯å¦ä¿æŒ

---

**æ‰€æœ‰é—®é¢˜å·²ä¿®å¤å¹¶é€šè¿‡APIæµ‹è¯•! ğŸ‰**
