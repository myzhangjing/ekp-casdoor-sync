<Window x:Class="SyncEkpToCasdoor.UI.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
    xmlns:local="clr-namespace:SyncEkpToCasdoor.UI"
    xmlns:models="clr-namespace:SyncEkpToCasdoor.UI.Models"
        xmlns:vm="clr-namespace:SyncEkpToCasdoor.UI.ViewModels"
        mc:Ignorable="d"
        Title="EKP-Casdoor 同步工具" 
        Height="700" Width="1100"
        MinHeight="600" MinWidth="900"
        WindowStartupLocation="CenterScreen"
        TextElement.Foreground="{DynamicResource MaterialDesignBody}"
        Background="{DynamicResource MaterialDesignPaper}"
        TextElement.FontWeight="Medium"
        TextElement.FontSize="14"
        FontFamily="{materialDesign:MaterialDesignFont}">
    
    <Window.DataContext>
        <vm:MainViewModel/>
    </Window.DataContext>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- 主内容区 -->
        <TabControl Grid.Row="0" 
                    SelectedIndex="{Binding SelectedTabIndex}"
                    materialDesign:ColorZoneAssist.Mode="PrimaryMid"
                    Style="{StaticResource MaterialDesignFilledTabControl}">
            
            <!-- 1. 配置管理标签页 -->
            <TabItem Header="配置管理">
                <TabItem.HeaderTemplate>
                    <DataTemplate>
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="Cog" Margin="0,0,5,0" VerticalAlignment="Center"/>
                            <TextBlock Text="配置管理"/>
                        </StackPanel>
                    </DataTemplate>
                </TabItem.HeaderTemplate>
                
                <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="20">
                    <StackPanel>
                        <!-- EKP 数据库配置 -->
                        <materialDesign:Card Margin="0,0,0,15" Padding="20">
                            <StackPanel>
                                <TextBlock Text="EKP 数据库配置" Style="{StaticResource MaterialDesignHeadline6TextBlock}" Margin="0,0,0,15"/>
                                
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="2*"/>
                                        <ColumnDefinition Width="20"/>
                                        <ColumnDefinition Width="1*"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <TextBox Grid.Column="0"
                                             materialDesign:HintAssist.Hint="服务器地址"
                                             Text="{Binding Configuration.EkpServer, UpdateSourceTrigger=PropertyChanged}"
                                             Style="{StaticResource MaterialDesignOutlinedTextBox}"/>
                                    
                                    <TextBox Grid.Column="2"
                                             materialDesign:HintAssist.Hint="端口"
                                             Text="{Binding Configuration.EkpPort, UpdateSourceTrigger=PropertyChanged}"
                                             Style="{StaticResource MaterialDesignOutlinedTextBox}"/>
                                </Grid>
                                
                                <TextBox Margin="0,10,0,0"
                                         materialDesign:HintAssist.Hint="数据库名"
                                         Text="{Binding Configuration.EkpDatabase, UpdateSourceTrigger=PropertyChanged}"
                                         Style="{StaticResource MaterialDesignOutlinedTextBox}"/>
                                
                                <TextBox Margin="0,10,0,0"
                                         materialDesign:HintAssist.Hint="用户名"
                                         Text="{Binding Configuration.EkpUsername, UpdateSourceTrigger=PropertyChanged}"
                                         Style="{StaticResource MaterialDesignOutlinedTextBox}"/>
                                
                                <PasswordBox Margin="0,10,0,0"
                                             materialDesign:HintAssist.Hint="密码"
                                             x:Name="EkpPasswordBox"
                                             Style="{StaticResource MaterialDesignOutlinedPasswordBox}"/>
                                
                                <Button Margin="0,15,0,0" 
                                        Content="测试 EKP 连接"
                                        Command="{Binding TestEkpConnectionCommand}"
                                        IsEnabled="{Binding IsTesting, Converter={StaticResource InverseBooleanConverter}}"
                                        Style="{StaticResource MaterialDesignOutlinedButton}"/>
                            </StackPanel>
                        </materialDesign:Card>

                        <!-- Casdoor API 配置 -->
                        <materialDesign:Card Margin="0,0,0,15" Padding="20">
                            <StackPanel>
                                <TextBlock Text="Casdoor API 配置" Style="{StaticResource MaterialDesignHeadline6TextBlock}" Margin="0,0,0,15"/>
                                
                                <TextBox materialDesign:HintAssist.Hint="接口地址"
                                         Text="{Binding Configuration.CasdoorEndpoint, UpdateSourceTrigger=PropertyChanged}"
                                         Style="{StaticResource MaterialDesignOutlinedTextBox}"/>
                                
                                <TextBox Margin="0,10,0,0"
                                         materialDesign:HintAssist.Hint="Client ID"
                                         Text="{Binding Configuration.CasdoorClientId, UpdateSourceTrigger=PropertyChanged}"
                                         Style="{StaticResource MaterialDesignOutlinedTextBox}"/>
                                
                                <PasswordBox Margin="0,10,0,0"
                                             materialDesign:HintAssist.Hint="Client Secret"
                                             x:Name="CasdoorSecretBox"
                                             Style="{StaticResource MaterialDesignOutlinedPasswordBox}"/>
                                
                                <TextBox Margin="0,10,0,0"
                                         materialDesign:HintAssist.Hint="Owner"
                                         Text="{Binding Configuration.CasdoorOwner, UpdateSourceTrigger=PropertyChanged}"
                                         Style="{StaticResource MaterialDesignOutlinedTextBox}"/>
                                
                                <Button Margin="0,15,0,0" 
                                        Content="测试 Casdoor API"
                                        Command="{Binding TestCasdoorApiCommand}"
                                        IsEnabled="{Binding IsTesting, Converter={StaticResource InverseBooleanConverter}}"
                                        Style="{StaticResource MaterialDesignOutlinedButton}"/>
                            </StackPanel>
                        </materialDesign:Card>

                        <!-- Casdoor 数据库配置 -->
                        <materialDesign:Card Margin="0,0,0,15" Padding="20">
                            <StackPanel>
                                <TextBlock Text="Casdoor 数据库配置（可选，用于故障排查）" 
                                          Style="{StaticResource MaterialDesignHeadline6TextBlock}" 
                                          Margin="0,0,0,15"/>
                                
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="2*"/>
                                        <ColumnDefinition Width="20"/>
                                        <ColumnDefinition Width="1*"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <TextBox Grid.Column="0"
                                             materialDesign:HintAssist.Hint="MySQL 服务器地址"
                                             Text="{Binding Configuration.CasdoorDbHost, UpdateSourceTrigger=PropertyChanged}"
                                             Style="{StaticResource MaterialDesignOutlinedTextBox}"/>
                                    
                                    <TextBox Grid.Column="2"
                                             materialDesign:HintAssist.Hint="端口"
                                             Text="{Binding Configuration.CasdoorDbPort, UpdateSourceTrigger=PropertyChanged}"
                                             Style="{StaticResource MaterialDesignOutlinedTextBox}"/>
                                </Grid>
                                
                                <TextBox Margin="0,10,0,0"
                                         materialDesign:HintAssist.Hint="数据库名"
                                         Text="{Binding Configuration.CasdoorDbName, UpdateSourceTrigger=PropertyChanged}"
                                         Style="{StaticResource MaterialDesignOutlinedTextBox}"/>
                                
                                <TextBox Margin="0,10,0,0"
                                         materialDesign:HintAssist.Hint="用户名"
                                         Text="{Binding Configuration.CasdoorDbUser, UpdateSourceTrigger=PropertyChanged}"
                                         Style="{StaticResource MaterialDesignOutlinedTextBox}"/>
                                
                                <PasswordBox Margin="0,10,0,0"
                                             materialDesign:HintAssist.Hint="密码"
                                             x:Name="CasdoorDbPasswordBox"
                                             Style="{StaticResource MaterialDesignOutlinedPasswordBox}"/>
                                
                                <Button Margin="0,15,0,0" 
                                        Content="测试 Casdoor 数据库"
                                        Command="{Binding TestCasdoorDbCommand}"
                                        IsEnabled="{Binding IsTesting, Converter={StaticResource InverseBooleanConverter}}"
                                        Style="{StaticResource MaterialDesignOutlinedButton}"/>
                            </StackPanel>
                        </materialDesign:Card>

                        <!-- 操作按钮 -->
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,10,0,0">
                            <Button Content="验证配置" 
                                    Command="{Binding ValidateConfigurationCommand}"
                                    Margin="0,0,10,0"
                                    Style="{StaticResource MaterialDesignOutlinedButton}"/>
                            <Button Content="测试所有连接" 
                                    Command="{Binding TestAllConnectionsCommand}"
                                    IsEnabled="{Binding IsTesting, Converter={StaticResource InverseBooleanConverter}}"
                                    Margin="0,0,10,0"
                                    Style="{StaticResource MaterialDesignOutlinedButton}"/>
                            <Button Content="保存配置" 
                                    Command="{Binding SaveConfigurationCommand}"
                                    Style="{StaticResource MaterialDesignRaisedButton}"/>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- 2. 同步规则标签页 -->
            <TabItem Header="同步规则">
                <TabItem.HeaderTemplate>
                    <DataTemplate>
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="Sync" Margin="0,0,5,0" VerticalAlignment="Center"/>
                            <TextBlock Text="同步规则"/>
                        </StackPanel>
                    </DataTemplate>
                </TabItem.HeaderTemplate>
                
                <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="20">
                    <StackPanel>
                        <materialDesign:Card Padding="20">
                            <StackPanel>
                                <TextBlock Text="同步选项" Style="{StaticResource MaterialDesignHeadline6TextBlock}" Margin="0,0,0,15"/>
                                
                                <CheckBox Content="同步组织架构" 
                                         IsChecked="{Binding Configuration.SyncOrganizations}"
                                         Margin="0,0,0,10"/>
                                <CheckBox Content="同步用户信息" 
                                         IsChecked="{Binding Configuration.SyncUsers}"
                                         Margin="0,0,0,10"/>
                                <CheckBox Content="同步用户密码 (MD5)" 
                                         IsChecked="{Binding Configuration.SyncPasswords}"/>
                                
                                <Separator Margin="0,20"/>
                                
                                <TextBlock Text="组织类型过滤" 
                                          Style="{StaticResource MaterialDesignSubtitle1TextBlock}" 
                                          Margin="0,0,0,10"/>
                                <TextBox materialDesign:HintAssist.Hint="组织类型 (逗号分隔, 如: 1,2 表示公司和部门)"
                                        Text="{Binding Configuration.OrgTypeFilter, UpdateSourceTrigger=PropertyChanged}"
                                        Style="{StaticResource MaterialDesignOutlinedTextBox}"/>
                                
                                <TextBlock Text="提示: 1=公司, 2=部门, 3=岗位, 4=小组" 
                                          Foreground="Gray" 
                                          FontSize="12" 
                                          Margin="0,5,0,0"/>
                            </StackPanel>
                        </materialDesign:Card>

                        <!-- 定时调度 -->
                        <materialDesign:Card Margin="0,15,0,0" Padding="20">
                            <StackPanel>
                                <StackPanel Orientation="Horizontal">
                                    <CheckBox Content="启用定时同步" 
                                             IsChecked="{Binding Configuration.EnableSchedule}"
                                             VerticalAlignment="Center"
                                             Margin="0,0,20,0"/>
                                    <TextBlock Text="(需要管理员权限创建任务计划)" 
                                              Foreground="Gray" 
                                              FontSize="12"
                                              VerticalAlignment="Center"/>
                                </StackPanel>
                                
                                <StackPanel Margin="0,15,0,0" IsEnabled="{Binding Configuration.EnableSchedule}">
                                    <TextBlock Text="调度模式" 
                                              Style="{StaticResource MaterialDesignSubtitle1TextBlock}" 
                                              Margin="0,0,0,10"/>
                                    
                                    <ComboBox SelectedIndex="0" Style="{StaticResource MaterialDesignOutlinedComboBox}">
                                        <ComboBoxItem Content="每日定时执行"/>
                                        <ComboBoxItem Content="间隔时间执行"/>
                                        <ComboBoxItem Content="仅手动执行"/>
                                    </ComboBox>
                                    
                                    <TextBlock Text="执行时间" 
                                              Style="{StaticResource MaterialDesignSubtitle1TextBlock}" 
                                              Margin="0,15,0,10"/>
                                    <TextBox materialDesign:HintAssist.Hint="HH:mm (如: 02:00)"
                                            Text="02:00"
                                            Style="{StaticResource MaterialDesignOutlinedTextBox}"/>
                                </StackPanel>
                            </StackPanel>
                        </materialDesign:Card>

                        <!-- EKP视图设置 -->
                        <materialDesign:Card Margin="0,15,0,0" Padding="20">
                            <StackPanel>
                                <TextBlock Text="EKP 视图设置" 
                                          Style="{StaticResource MaterialDesignHeadline6TextBlock}" 
                                          Margin="0,0,0,15"/>
                                
                                <TextBlock TextWrapping="Wrap" Foreground="Gray" Margin="0,0,0,15">
                                    同步工具需要在 EKP 数据库中创建特定视图才能正常工作。点击下面的按钮可以自动检测并创建所需视图。
                                </TextBlock>
                                
                                <StackPanel Orientation="Horizontal">
                                    <Button Content="自动创建视图" 
                                            Command="{Binding SetupEkpViewsCommand}"
                                            IsEnabled="{Binding IsTesting, Converter={StaticResource InverseBooleanConverter}}"
                                            Style="{StaticResource MaterialDesignRaisedButton}"
                                            Margin="0,0,10,0"
                                            ToolTip="自动在 EKP 数据库中检测并创建所需视图"/>
                                    <Button Content="导出SQL脚本" 
                                            Command="{Binding ExportViewScriptCommand}"
                                            Style="{StaticResource MaterialDesignOutlinedButton}"
                                            ToolTip="导出视图创建脚本，可手动在数据库中执行"/>
                                </StackPanel>
                            </StackPanel>
                        </materialDesign:Card>

                        <!-- 操作按钮 -->
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,20,0,0">
                            <Button Content="获取数据预览" 
                                    Command="{Binding GetDataPreviewCommand}"
                                    IsEnabled="{Binding IsTesting, Converter={StaticResource InverseBooleanConverter}}"
                                    Margin="0,0,10,0"
                                    Style="{StaticResource MaterialDesignOutlinedButton}"/>
                            <Button Content="保存规则" 
                                    Command="{Binding SaveConfigurationCommand}"
                                    Style="{StaticResource MaterialDesignRaisedButton}"/>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- 3. 执行同步标签页 -->
            <TabItem Header="执行同步">
                <TabItem.HeaderTemplate>
                    <DataTemplate>
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="PlayCircle" Margin="0,0,5,0" VerticalAlignment="Center"/>
                            <TextBlock Text="执行同步"/>
                        </StackPanel>
                    </DataTemplate>
                </TabItem.HeaderTemplate>
                
                <Grid Margin="20">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- 控制面板 -->
                    <materialDesign:Card Grid.Row="0" Margin="0,0,0,15">
                        <StackPanel Margin="20">
                            <TextBlock Text="同步控制" 
                                       Style="{StaticResource MaterialDesignHeadline6TextBlock}"
                                       Margin="0,0,0,15"/>

                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                <Button Content="增量同步"
                                        Command="{Binding SyncExecutionViewModel.StartIncrementalSyncCommand}"
                                        IsEnabled="{Binding SyncExecutionViewModel.IsSyncing, Converter={StaticResource InverseBooleanConverter}}"
                                        Style="{StaticResource MaterialDesignRaisedButton}"
                                        Width="120" Height="40" Margin="5"
                                        ToolTip="同步自上次以来发生变化的数据"/>

                                <Button Content="全量同步"
                                        Command="{Binding SyncExecutionViewModel.StartFullSyncCommand}"
                                        IsEnabled="{Binding SyncExecutionViewModel.IsSyncing, Converter={StaticResource InverseBooleanConverter}}"
                                        Style="{StaticResource MaterialDesignRaisedButton}"
                                        Background="#FF9800" BorderBrush="#FF9800"
                                        Width="120" Height="40" Margin="5"
                                        ToolTip="重新同步所有数据（耗时较长）"/>

                                <Button Content="取消"
                                        Command="{Binding SyncExecutionViewModel.CancelSyncCommand}"
                                        IsEnabled="{Binding SyncExecutionViewModel.IsSyncing}"
                                        Style="{StaticResource MaterialDesignRaisedButton}"
                                        Background="#F44336" BorderBrush="#F44336"
                                        Width="120" Height="40" Margin="5"/>

                                <Button Content="清除日志"
                                        Command="{Binding SyncExecutionViewModel.ClearLogsCommand}"
                                        Style="{StaticResource MaterialDesignOutlinedButton}"
                                        Width="120" Height="40" Margin="5"/>
                            </StackPanel>

                            <!-- 进度条 -->
                            <Grid Margin="0,20,0,0">
                                <ProgressBar Height="8"
                                             Value="{Binding SyncExecutionViewModel.ProgressPercentage}"
                                             IsIndeterminate="{Binding SyncExecutionViewModel.IsSyncing}"
                                             Visibility="{Binding SyncExecutionViewModel.IsSyncing, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                <ProgressBar Height="8"
                                             Value="{Binding SyncExecutionViewModel.ProgressPercentage}"
                                             Visibility="{Binding SyncExecutionViewModel.IsSyncing, Converter={StaticResource InverseBooleanConverter}}"/>
                            </Grid>

                            <Grid Margin="0,10,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" 
                                           Text="{Binding SyncExecutionViewModel.StatusMessage}"
                                           VerticalAlignment="Center"/>
                                <TextBlock Grid.Column="1" 
                                           Text="{Binding SyncExecutionViewModel.ProgressMessage}"
                                           VerticalAlignment="Center"
                                           Foreground="Gray"/>
                            </Grid>
                        </StackPanel>
                    </materialDesign:Card>

                    <!-- 统计信息 -->
                    <materialDesign:Card Grid.Row="1" Margin="0,0,0,15">
                        <Grid Margin="20">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0" Margin="5">
                                <TextBlock Text="组织数" Foreground="Gray" FontSize="12"/>
                                <TextBlock Text="{Binding SyncExecutionViewModel.OrganizationCount}" 
                                           FontSize="24" FontWeight="Bold"/>
                            </StackPanel>

                            <StackPanel Grid.Column="1" Margin="5">
                                <TextBlock Text="用户数" Foreground="Gray" FontSize="12"/>
                                <TextBlock Text="{Binding SyncExecutionViewModel.UserCount}" 
                                           FontSize="24" FontWeight="Bold"/>
                            </StackPanel>

                            <StackPanel Grid.Column="2" Margin="5">
                                <TextBlock Text="成功" Foreground="Green" FontSize="12"/>
                                <TextBlock Text="{Binding SyncExecutionViewModel.SuccessCount}" 
                                           FontSize="24" FontWeight="Bold" Foreground="Green"/>
                            </StackPanel>

                            <StackPanel Grid.Column="3" Margin="5">
                                <TextBlock Text="失败" Foreground="Red" FontSize="12"/>
                                <TextBlock Text="{Binding SyncExecutionViewModel.ErrorCount}" 
                                           FontSize="24" FontWeight="Bold" Foreground="Red"/>
                            </StackPanel>

                            <StackPanel Grid.Column="4" Margin="5">
                                <TextBlock Text="耗时" Foreground="Gray" FontSize="12"/>
                                <TextBlock FontSize="24" FontWeight="Bold">
                                    <TextBlock.Text>
                                        <MultiBinding StringFormat="{}{0:mm}:{0:ss}">
                                            <Binding Path="SyncExecutionViewModel.SyncDuration"/>
                                        </MultiBinding>
                                    </TextBlock.Text>
                                </TextBlock>
                            </StackPanel>

                            <StackPanel Grid.Column="5" Margin="5">
                                <TextBlock Text="上次同步" Foreground="Gray" FontSize="12"/>
                                <TextBlock Text="{Binding SyncExecutionViewModel.LastSyncResult}" 
                                           FontSize="14" TextWrapping="Wrap"/>
                            </StackPanel>
                        </Grid>
                    </materialDesign:Card>

                    <!-- 实时日志 -->
                    <materialDesign:Card Grid.Row="2">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <Border Grid.Row="0" Background="{DynamicResource MaterialDesignPaper}" 
                                    BorderBrush="{DynamicResource MaterialDesignDivider}" 
                                    BorderThickness="0,0,0,1">
                                <TextBlock Text="实时日志" 
                                           Style="{StaticResource MaterialDesignHeadline6TextBlock}"
                                           Margin="20,15"/>
                            </Border>

                            <ListBox Grid.Row="1" 
                                     ItemsSource="{Binding SyncExecutionViewModel.RealtimeLogs}"
                                     FontFamily="Consolas"
                                     FontSize="12"
                                     Margin="10"
                                     ScrollViewer.HorizontalScrollBarVisibility="Auto"
                                     ScrollViewer.VerticalScrollBarVisibility="Auto"/>
                        </Grid>
                    </materialDesign:Card>
                </Grid>
            </TabItem>

            <!-- 4. 数据查看标签页 -->
            <TabItem Header="数据查看">
                <TabItem.HeaderTemplate>
                    <DataTemplate>
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="Database" Margin="0,0,5,0" VerticalAlignment="Center"/>
                            <TextBlock Text="数据查看"/>
                        </StackPanel>
                    </DataTemplate>
                </TabItem.HeaderTemplate>

                <Grid Margin="20">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- 工具栏 -->
                    <materialDesign:Card Grid.Row="0" Margin="0,0,0,15">
                        <StackPanel Margin="15">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <!-- 数据源选择 -->
                                <StackPanel Grid.Column="0" Orientation="Horizontal" Margin="0,0,20,0">
                                    <TextBlock Text="数据源:" VerticalAlignment="Center" Margin="0,0,10,0"/>
                                    <ComboBox ItemsSource="{Binding DataViewViewModel.DataSources}"
                                             SelectedItem="{Binding DataViewViewModel.SelectedDataSource}"
                                             Width="120"
                                             materialDesign:HintAssist.Hint="选择数据源"/>
                                </StackPanel>

                                <!-- 视图类型 -->
                                <StackPanel Grid.Column="1" Orientation="Horizontal" Margin="0,0,20,0">
                                    <TextBlock Text="查看:" VerticalAlignment="Center" Margin="0,0,10,0"/>
                                    <ComboBox ItemsSource="{Binding DataViewViewModel.ViewTypes}"
                                             SelectedItem="{Binding DataViewViewModel.SelectedView}"
                                             Width="100"
                                             materialDesign:HintAssist.Hint="选择视图"/>
                                </StackPanel>

                                <!-- 搜索框 -->
                                <TextBox Grid.Column="2" 
                                        Text="{Binding DataViewViewModel.SearchText, UpdateSourceTrigger=PropertyChanged}"
                                        materialDesign:HintAssist.Hint="搜索..."
                                        Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                        Margin="0,0,10,0">
                                    <TextBox.InputBindings>
                                        <KeyBinding Key="Enter" Command="{Binding DataViewViewModel.SearchCommand}"/>
                                    </TextBox.InputBindings>
                                </TextBox>

                                <!-- 操作按钮 -->
                    <StackPanel Grid.Column="3" Orientation="Horizontal">
                                    <Button Content="加载"
                                           Command="{Binding DataViewViewModel.LoadDataCommand}"
                                           IsEnabled="{Binding DataViewViewModel.IsLoading, Converter={StaticResource InverseBooleanConverter}}"
                                           Style="{StaticResource MaterialDesignRaisedButton}"
                                           Margin="0,0,5,0"/>
                                    <Button Content="刷新"
                                           Command="{Binding DataViewViewModel.RefreshCommand}"
                                           IsEnabled="{Binding DataViewViewModel.IsLoading, Converter={StaticResource InverseBooleanConverter}}"
                                           Style="{StaticResource MaterialDesignOutlinedButton}"
                                           Margin="0,0,5,0"/>
                                    <Button Content="清空Casdoor"
                                            Command="{Binding DataViewViewModel.ClearCasdoorDataCommand}"
                                            IsEnabled="{Binding DataViewViewModel.IsLoading, Converter={StaticResource InverseBooleanConverter}}"
                                            Style="{StaticResource MaterialDesignOutlinedButton}"
                                            Background="#FFEB3B"
                                            ToolTip="清空 Casdoor 所有组织和用户数据（仅测试环境）"
                                            Margin="0,0,5,0"/>
                                    <Button Content="导出"
                                           Command="{Binding DataViewViewModel.ExportDataCommand}"
                                           Style="{StaticResource MaterialDesignOutlinedButton}"/>
                                </StackPanel>
                            </Grid>

                            <!-- 统计信息和过滤 -->
                            <Grid Margin="0,10,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <!-- 统计 -->
                                <StackPanel Grid.Column="0" Orientation="Horizontal">
                                    <TextBlock Text="{Binding DataViewViewModel.StatusMessage}" 
                                              VerticalAlignment="Center" 
                                              Margin="0,0,20,0"/>
                                    
                                    <StackPanel Orientation="Horizontal" 
                                               Visibility="{Binding DataViewViewModel.SelectedDataSource, Converter={StaticResource StringEqualsToVisibility}, ConverterParameter=比对}">
                                        <TextBlock Text="已同步(两边都有):" Foreground="Green" Margin="0,0,5,0" VerticalAlignment="Center"/>
                                        <TextBlock Text="{Binding DataViewViewModel.SyncedCount}" 
                                                  Foreground="Green" FontWeight="Bold" Margin="0,0,15,0" VerticalAlignment="Center"/>
                                        
                                        <TextBlock Text="仅在EKP(待同步):" Foreground="Orange" Margin="0,0,5,0" VerticalAlignment="Center"/>
                                        <TextBlock Text="{Binding DataViewViewModel.EkpOnlyCount}" 
                                                  Foreground="Orange" FontWeight="Bold" Margin="0,0,15,0" VerticalAlignment="Center"/>
                                        
                                        <TextBlock Text="仅在Casdoor(EKP无):" Foreground="Red" Margin="0,0,5,0" VerticalAlignment="Center"/>
                                        <TextBlock Text="{Binding DataViewViewModel.CasdoorOnlyCount}" 
                                                  Foreground="Red" FontWeight="Bold" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </StackPanel>

                                <!-- 过滤 -->
                                <StackPanel Grid.Column="2" Orientation="Horizontal">
                                    <TextBlock Text="筛选:" VerticalAlignment="Center" Margin="0,0,10,0"/>
                                    <ComboBox ItemsSource="{Binding DataViewViewModel.FilterStatuses}"
                                             SelectedItem="{Binding DataViewViewModel.FilterStatus}"
                                             Width="120"/>
                                </StackPanel>
                            </Grid>
                        </StackPanel>
                    </materialDesign:Card>

                    <!-- 数据展示区域：组织树 或 用户表格 -->
                    <materialDesign:Card Grid.Row="1">
                        <Grid>
                            <!-- 组织树视图 -->
                            <TreeView ItemsSource="{Binding DataViewViewModel.OrganizationTree}"
                                      Visibility="{Binding DataViewViewModel.SelectedView, Converter={StaticResource StringEqualsToVisibility}, ConverterParameter=组织}">
                                <TreeView.Resources>
                                    <HierarchicalDataTemplate DataType="{x:Type models:OrganizationTreeNode}" ItemsSource="{Binding Children}">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="{Binding DisplayName}"/>
                                            <TextBlock Text=" (" Foreground="Gray"/>
                                            <TextBlock Text="{Binding MemberCount}" Foreground="Gray"/>
                                            <TextBlock Text=")" Foreground="Gray"/>
                                        </StackPanel>
                                    </HierarchicalDataTemplate>
                                </TreeView.Resources>
                            </TreeView>

                            <!-- 用户视图 -->
                            <DataGrid ItemsSource="{Binding DataViewViewModel.Users}"
                                     SelectedItem="{Binding DataViewViewModel.SelectedUser}"
                                     AutoGenerateColumns="False"
                                     IsReadOnly="True"
                                     CanUserAddRows="False"
                                     CanUserDeleteRows="False"
                                     SelectionMode="Single"
                                     Visibility="{Binding DataViewViewModel.SelectedView, Converter={StaticResource StringEqualsToVisibility}, ConverterParameter=用户}">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="ID" Binding="{Binding Id}" Width="120"/>
                                    <DataGridTextColumn Header="用户名" Binding="{Binding Name}" Width="150"/>
                                    <DataGridTextColumn Header="显示名称" Binding="{Binding DisplayName}" Width="150"/>
                                    <DataGridTextColumn Header="邮箱" Binding="{Binding Email}" Width="200"/>
                                    <DataGridTextColumn Header="手机" Binding="{Binding Phone}" Width="120"/>
                                    <DataGridTextColumn Header="组织" Binding="{Binding OrganizationName}" Width="150"/>
                                    <DataGridCheckBoxColumn Header="启用" Binding="{Binding IsEnabled}" Width="60"/>
                                    <DataGridTextColumn Header="数据来源" Binding="{Binding Source}" Width="100"/>
                                    <DataGridTextColumn Header="同步状态" Binding="{Binding SyncStatus}" Width="120"/>
                                </DataGrid.Columns>
                            </DataGrid>

                            <!-- 加载指示器 -->
                            <Grid Visibility="{Binding DataViewViewModel.IsLoading, 
                                             Converter={StaticResource BooleanToVisibilityConverter}}"
                                 Background="#80FFFFFF">
                                <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                                    <ProgressBar Style="{StaticResource MaterialDesignCircularProgressBar}"
                                                Value="0"
                                                IsIndeterminate="True"
                                                Width="50" Height="50"/>
                                    <TextBlock Text="{Binding DataViewViewModel.StatusMessage}"
                                              Margin="0,10,0,0"
                                              HorizontalAlignment="Center"/>
                                </StackPanel>
                            </Grid>
                        </Grid>
                    </materialDesign:Card>
                </Grid>
            </TabItem>

            <!-- 5. 日志查看标签页 -->
            <TabItem Header="日志">
                <TabItem.HeaderTemplate>
                    <DataTemplate>
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="TextBox" Margin="0,0,5,0" VerticalAlignment="Center"/>
                            <TextBlock Text="日志"/>
                        </StackPanel>
                    </DataTemplate>
                </TabItem.HeaderTemplate>
                
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    
                    <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="10" HorizontalAlignment="Right">
                        <Button Content="清除日志" 
                                Command="{Binding ClearLogsCommand}"
                                Style="{StaticResource MaterialDesignOutlinedButton}"/>
                    </StackPanel>
                    
                    <ListBox Grid.Row="1" 
                            ItemsSource="{Binding LogMessages}"
                            Margin="10"
                            FontFamily="Consolas"
                            FontSize="12"/>
                </Grid>
            </TabItem>
        </TabControl>

        <!-- 状态栏 -->
        <materialDesign:ColorZone Grid.Row="1" Mode="PrimaryMid" Padding="10">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <materialDesign:PackIcon Grid.Column="0" 
                                        Kind="Information" 
                                        VerticalAlignment="Center"
                                        Margin="0,0,10,0"/>
                
                <TextBlock Grid.Column="1" 
                          Text="{Binding StatusMessage}" 
                          VerticalAlignment="Center"/>
                
                <ProgressBar Grid.Column="2" 
                            IsIndeterminate="True" 
                            Width="100"
                            Visibility="{Binding IsTesting, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                
                <!-- 当前登录用户 -->
                <StackPanel Grid.Column="3" 
                           Orientation="Horizontal" 
                           Margin="20,0,0,0"
                           x:Name="UserInfoPanel">
                    <materialDesign:PackIcon Kind="Account" 
                                            VerticalAlignment="Center"
                                            Margin="0,0,5,0"/>
                    <TextBlock x:Name="UserDisplayNameText"
                              VerticalAlignment="Center"
                              FontWeight="Bold"/>
                </StackPanel>
            </Grid>
        </materialDesign:ColorZone>
    </Grid>
</Window>
