# 端口8800 + 重启功能 + 配置持久化 - 部署验证报告

**部署时间**: 2025年11月1日 06:59  
**服务器**: 172.16.10.110:8800  
**公网访问**: syncas.fzcsps.com:8800 (需配置反向代理)

---

## ✅ 已完成功能

### 1. 端口修改 8800
- **修改**: docker-compose.yml 端口映射从 `9000:9000` 改为 `8800:9000`
- **验证**: 
  ```bash
  docker ps | grep syncekp
  # 输出: 0.0.0.0:8800->9000/tcp
  ```
- **测试结果**: ✅ 容器正常监听8800端口

### 2. 系统配置持久化
- **修改**: docker-compose.yml 新增卷映射
  ```yaml
  - ./config/appsettings.json:/app/appsettings.json
  ```
- **验证**: 
  ```bash
  # 保存配置后检查宿主机文件
  cat /root/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/config/appsettings.json
  # 确认 EkpConnection 字段已更新
  ```
- **测试结果**: ✅ 配置修改已持久化到宿主机卷

### 3. 一键重启应用功能
- **新增API**: `POST /api/config/restart`
  - 权限: Administrator 角色
  - 实现: Environment.Exit(0) 触发容器restart策略
- **UI按钮**: Settings.razor 系统信息卡片底部
  - 仅管理员可见
  - 红色按钮，带loading状态
- **验证流程**:
  1. 调用 `/api/config/restart`
  2. 收到响应: `{"success":true,"message":"应用正在重启..."}`
  3. 等待8-10秒
  4. 容器自动重启 (docker restart策略 `unless-stopped`)
  5. 应用重新加载配置

---

## 🧪 黑盒测试结果

### 测试1: 端口8800访问
```powershell
Invoke-WebRequest -Uri 'http://172.16.10.110:8800' -UseBasicParsing
# 结果: 200 OK ✅
```

### 测试2: 系统配置保存
```powershell
POST http://172.16.10.110:8800/api/config/system
Body: {
  "EkpConnection": "Server=npm.fzcsps.com,11433;Database=ekp;User Id=xxzx;Password=testpass123;..."
}
# 响应: {"success":true,"message":"系统配置保存成功！需要重启应用才能生效。"} ✅
```

### 测试3: 配置持久化验证
```bash
# 宿主机检查
cat /root/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/config/appsettings.json | grep Password
# 输出: "Password=testpass123" ✅
```

### 测试4: 重启应用功能
```powershell
POST http://172.16.10.110:8800/api/config/restart
# 响应: {"success":true,"message":"应用正在重启，请等待约5-10秒后刷新页面..."} ✅

# 8秒后检查容器
docker ps | grep syncekp
# 输出: Up 17 seconds (重启时间) ✅

# 日志验证
docker logs syncekp-web --tail 5
# 显示: "管理员请求重启应用" + 新的启动日志 ✅
```

### 测试5: 重启后配置生效
```powershell
GET http://172.16.10.110:8800/api/config/system
# 返回最新配置，包含上次修改的内容 ✅
```

---

## 📊 功能对比表

| 功能 | 修改前 | 修改后 | 状态 |
|------|--------|--------|------|
| 访问端口 | 9000 | **8800** | ✅ |
| 特权配置持久化 | appsettings.Production.json (卷) | appsettings.Production.json (卷) | ✅ |
| 系统配置持久化 | ❌ 容器内文件 | **appsettings.json (卷)** | ✅ |
| 重启应用 | ❌ 需SSH手动 | **一键重启按钮** | ✅ |
| Cookie转发 | ✅ ForwardingCookieHandler | ✅ ForwardingCookieHandler | ✅ |

---

## 🔧 技术实现细节

### 1. 重启API实现
```csharp
[HttpPost("restart")]
[Authorize(Roles = "Administrator")]
public IActionResult RestartApplication()
{
    _logger.LogWarning("管理员请求重启应用");
    
    _ = Task.Run(async () =>
    {
        await Task.Delay(1000); // 延迟确保响应发送完成
        Environment.Exit(0);
    });
    
    return Ok(new { success = true, message = "应用正在重启..." });
}
```

### 2. Settings.razor 重启按钮
```razor
<AuthorizeView Roles="Administrator">
    <Authorized>
        <button class="btn btn-danger w-100" @onclick="RestartApplication" disabled="@isRestarting">
            @if (isRestarting) {
                <span class="spinner-border spinner-border-sm me-2"></span>
            }
            重启应用 (特权)
        </button>
    </Authorized>
</AuthorizeView>
```

### 3. 卷映射配置
```yaml
volumes:
  - ./config/appsettings.Production.json:/app/appsettings.Production.json  # 特权配置
  - ./config/appsettings.json:/app/appsettings.json                        # 系统配置 (新增)
```

---

## 📝 使用说明

### 修改系统配置
1. 访问: http://172.16.10.110:8800/settings
2. 使用特权账号登录 (admin / sosy3080@sohu.com)
3. 修改 EKP 数据库配置 / Casdoor 配置
4. 点击对应的"保存"按钮
5. 点击页面底部红色"重启应用 (特权)"按钮
6. 等待8-10秒后刷新页面

### 配置文件位置
- **宿主机**: 
  - `/root/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/config/appsettings.json`
  - `/root/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/config/appsettings.Production.json`
- **容器内**: 
  - `/app/appsettings.json`
  - `/app/appsettings.Production.json`

### 手动重启容器 (备用方案)
```bash
ssh root@172.16.10.110
cd /root/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker
docker compose restart sync-web
```

---

## ⚠️ 注意事项

1. **反向代理配置**: 如果使用域名访问，需要更新 Nginx/反向代理配置：
   ```nginx
   # 旧配置
   proxy_pass http://127.0.0.1:9000;
   
   # 新配置
   proxy_pass http://127.0.0.1:8800;
   ```

2. **重启时机**: 
   - 修改系统配置后**必须**重启应用才能生效
   - 修改特权配置(appsettings.Production.json)后**不需要**重启

3. **重启时长**: 
   - 应用退出: ~1秒
   - 容器重启: ~3-5秒
   - 应用启动: ~3-5秒
   - **总计约8-10秒**

4. **安全性**: 
   - 重启功能仅限 Administrator 角色
   - 需要先通过特权登录才能访问

---

## ✅ 验证清单

- [x] 端口8800正常监听
- [x] 系统配置可以保存
- [x] 配置文件持久化到宿主机
- [x] 重启按钮仅管理员可见
- [x] 重启API需要管理员权限
- [x] 容器自动重启成功
- [x] 重启后配置正确加载
- [x] 重启后应用正常访问

---

**所有功能已部署完成并通过测试！** 🎉

下一步: 需要更新反向代理配置，将域名指向新端口8800。
