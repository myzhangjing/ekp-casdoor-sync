# ç«¯å£8800 + é‡å¯åŠŸèƒ½ + é…ç½®æŒä¹…åŒ– - éƒ¨ç½²éªŒè¯æŠ¥å‘Š

**éƒ¨ç½²æ—¶é—´**: 2025å¹´11æœˆ1æ—¥ 06:59  
**æœåŠ¡å™¨**: 172.16.10.110:8800  
**å…¬ç½‘è®¿é—®**: syncas.fzcsps.com:8800 (éœ€é…ç½®åå‘ä»£ç†)

---

## âœ… å·²å®ŒæˆåŠŸèƒ½

### 1. ç«¯å£ä¿®æ”¹ 8800
- **ä¿®æ”¹**: docker-compose.yml ç«¯å£æ˜ å°„ä» `9000:9000` æ”¹ä¸º `8800:9000`
- **éªŒè¯**: 
  ```bash
  docker ps | grep syncekp
  # è¾“å‡º: 0.0.0.0:8800->9000/tcp
  ```
- **æµ‹è¯•ç»“æœ**: âœ… å®¹å™¨æ­£å¸¸ç›‘å¬8800ç«¯å£

### 2. ç³»ç»Ÿé…ç½®æŒä¹…åŒ–
- **ä¿®æ”¹**: docker-compose.yml æ–°å¢å·æ˜ å°„
  ```yaml
  - ./config/appsettings.json:/app/appsettings.json
  ```
- **éªŒè¯**: 
  ```bash
  # ä¿å­˜é…ç½®åæ£€æŸ¥å®¿ä¸»æœºæ–‡ä»¶
  cat /root/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/config/appsettings.json
  # ç¡®è®¤ EkpConnection å­—æ®µå·²æ›´æ–°
  ```
- **æµ‹è¯•ç»“æœ**: âœ… é…ç½®ä¿®æ”¹å·²æŒä¹…åŒ–åˆ°å®¿ä¸»æœºå·

### 3. ä¸€é”®é‡å¯åº”ç”¨åŠŸèƒ½
- **æ–°å¢API**: `POST /api/config/restart`
  - æƒé™: Administrator è§’è‰²
  - å®ç°: Environment.Exit(0) è§¦å‘å®¹å™¨restartç­–ç•¥
- **UIæŒ‰é’®**: Settings.razor ç³»ç»Ÿä¿¡æ¯å¡ç‰‡åº•éƒ¨
  - ä»…ç®¡ç†å‘˜å¯è§
  - çº¢è‰²æŒ‰é’®ï¼Œå¸¦loadingçŠ¶æ€
- **éªŒè¯æµç¨‹**:
  1. è°ƒç”¨ `/api/config/restart`
  2. æ”¶åˆ°å“åº”: `{"success":true,"message":"åº”ç”¨æ­£åœ¨é‡å¯..."}`
  3. ç­‰å¾…8-10ç§’
  4. å®¹å™¨è‡ªåŠ¨é‡å¯ (docker restartç­–ç•¥ `unless-stopped`)
  5. åº”ç”¨é‡æ–°åŠ è½½é…ç½®

---

## ğŸ§ª é»‘ç›’æµ‹è¯•ç»“æœ

### æµ‹è¯•1: ç«¯å£8800è®¿é—®
```powershell
Invoke-WebRequest -Uri 'http://172.16.10.110:8800' -UseBasicParsing
# ç»“æœ: 200 OK âœ…
```

### æµ‹è¯•2: ç³»ç»Ÿé…ç½®ä¿å­˜
```powershell
POST http://172.16.10.110:8800/api/config/system
Body: {
  "EkpConnection": "Server=npm.fzcsps.com,11433;Database=ekp;User Id=xxzx;Password=testpass123;..."
}
# å“åº”: {"success":true,"message":"ç³»ç»Ÿé…ç½®ä¿å­˜æˆåŠŸï¼éœ€è¦é‡å¯åº”ç”¨æ‰èƒ½ç”Ÿæ•ˆã€‚"} âœ…
```

### æµ‹è¯•3: é…ç½®æŒä¹…åŒ–éªŒè¯
```bash
# å®¿ä¸»æœºæ£€æŸ¥
cat /root/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/config/appsettings.json | grep Password
# è¾“å‡º: "Password=testpass123" âœ…
```

### æµ‹è¯•4: é‡å¯åº”ç”¨åŠŸèƒ½
```powershell
POST http://172.16.10.110:8800/api/config/restart
# å“åº”: {"success":true,"message":"åº”ç”¨æ­£åœ¨é‡å¯ï¼Œè¯·ç­‰å¾…çº¦5-10ç§’ååˆ·æ–°é¡µé¢..."} âœ…

# 8ç§’åæ£€æŸ¥å®¹å™¨
docker ps | grep syncekp
# è¾“å‡º: Up 17 seconds (é‡å¯æ—¶é—´) âœ…

# æ—¥å¿—éªŒè¯
docker logs syncekp-web --tail 5
# æ˜¾ç¤º: "ç®¡ç†å‘˜è¯·æ±‚é‡å¯åº”ç”¨" + æ–°çš„å¯åŠ¨æ—¥å¿— âœ…
```

### æµ‹è¯•5: é‡å¯åé…ç½®ç”Ÿæ•ˆ
```powershell
GET http://172.16.10.110:8800/api/config/system
# è¿”å›æœ€æ–°é…ç½®ï¼ŒåŒ…å«ä¸Šæ¬¡ä¿®æ”¹çš„å†…å®¹ âœ…
```

---

## ğŸ“Š åŠŸèƒ½å¯¹æ¯”è¡¨

| åŠŸèƒ½ | ä¿®æ”¹å‰ | ä¿®æ”¹å | çŠ¶æ€ |
|------|--------|--------|------|
| è®¿é—®ç«¯å£ | 9000 | **8800** | âœ… |
| ç‰¹æƒé…ç½®æŒä¹…åŒ– | appsettings.Production.json (å·) | appsettings.Production.json (å·) | âœ… |
| ç³»ç»Ÿé…ç½®æŒä¹…åŒ– | âŒ å®¹å™¨å†…æ–‡ä»¶ | **appsettings.json (å·)** | âœ… |
| é‡å¯åº”ç”¨ | âŒ éœ€SSHæ‰‹åŠ¨ | **ä¸€é”®é‡å¯æŒ‰é’®** | âœ… |
| Cookieè½¬å‘ | âœ… ForwardingCookieHandler | âœ… ForwardingCookieHandler | âœ… |

---

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### 1. é‡å¯APIå®ç°
```csharp
[HttpPost("restart")]
[Authorize(Roles = "Administrator")]
public IActionResult RestartApplication()
{
    _logger.LogWarning("ç®¡ç†å‘˜è¯·æ±‚é‡å¯åº”ç”¨");
    
    _ = Task.Run(async () =>
    {
        await Task.Delay(1000); // å»¶è¿Ÿç¡®ä¿å“åº”å‘é€å®Œæˆ
        Environment.Exit(0);
    });
    
    return Ok(new { success = true, message = "åº”ç”¨æ­£åœ¨é‡å¯..." });
}
```

### 2. Settings.razor é‡å¯æŒ‰é’®
```razor
<AuthorizeView Roles="Administrator">
    <Authorized>
        <button class="btn btn-danger w-100" @onclick="RestartApplication" disabled="@isRestarting">
            @if (isRestarting) {
                <span class="spinner-border spinner-border-sm me-2"></span>
            }
            é‡å¯åº”ç”¨ (ç‰¹æƒ)
        </button>
    </Authorized>
</AuthorizeView>
```

### 3. å·æ˜ å°„é…ç½®
```yaml
volumes:
  - ./config/appsettings.Production.json:/app/appsettings.Production.json  # ç‰¹æƒé…ç½®
  - ./config/appsettings.json:/app/appsettings.json                        # ç³»ç»Ÿé…ç½® (æ–°å¢)
```

---

## ğŸ“ ä½¿ç”¨è¯´æ˜

### ä¿®æ”¹ç³»ç»Ÿé…ç½®
1. è®¿é—®: http://172.16.10.110:8800/settings
2. ä½¿ç”¨ç‰¹æƒè´¦å·ç™»å½• (admin / sosy3080@sohu.com)
3. ä¿®æ”¹ EKP æ•°æ®åº“é…ç½® / Casdoor é…ç½®
4. ç‚¹å‡»å¯¹åº”çš„"ä¿å­˜"æŒ‰é’®
5. ç‚¹å‡»é¡µé¢åº•éƒ¨çº¢è‰²"é‡å¯åº”ç”¨ (ç‰¹æƒ)"æŒ‰é’®
6. ç­‰å¾…8-10ç§’ååˆ·æ–°é¡µé¢

### é…ç½®æ–‡ä»¶ä½ç½®
- **å®¿ä¸»æœº**: 
  - `/root/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/config/appsettings.json`
  - `/root/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/config/appsettings.Production.json`
- **å®¹å™¨å†…**: 
  - `/app/appsettings.json`
  - `/app/appsettings.Production.json`

### æ‰‹åŠ¨é‡å¯å®¹å™¨ (å¤‡ç”¨æ–¹æ¡ˆ)
```bash
ssh root@172.16.10.110
cd /root/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker
docker compose restart sync-web
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **åå‘ä»£ç†é…ç½®**: å¦‚æœä½¿ç”¨åŸŸåè®¿é—®ï¼Œéœ€è¦æ›´æ–° Nginx/åå‘ä»£ç†é…ç½®ï¼š
   ```nginx
   # æ—§é…ç½®
   proxy_pass http://127.0.0.1:9000;
   
   # æ–°é…ç½®
   proxy_pass http://127.0.0.1:8800;
   ```

2. **é‡å¯æ—¶æœº**: 
   - ä¿®æ”¹ç³»ç»Ÿé…ç½®å**å¿…é¡»**é‡å¯åº”ç”¨æ‰èƒ½ç”Ÿæ•ˆ
   - ä¿®æ”¹ç‰¹æƒé…ç½®(appsettings.Production.json)å**ä¸éœ€è¦**é‡å¯

3. **é‡å¯æ—¶é•¿**: 
   - åº”ç”¨é€€å‡º: ~1ç§’
   - å®¹å™¨é‡å¯: ~3-5ç§’
   - åº”ç”¨å¯åŠ¨: ~3-5ç§’
   - **æ€»è®¡çº¦8-10ç§’**

4. **å®‰å…¨æ€§**: 
   - é‡å¯åŠŸèƒ½ä»…é™ Administrator è§’è‰²
   - éœ€è¦å…ˆé€šè¿‡ç‰¹æƒç™»å½•æ‰èƒ½è®¿é—®

---

## âœ… éªŒè¯æ¸…å•

- [x] ç«¯å£8800æ­£å¸¸ç›‘å¬
- [x] ç³»ç»Ÿé…ç½®å¯ä»¥ä¿å­˜
- [x] é…ç½®æ–‡ä»¶æŒä¹…åŒ–åˆ°å®¿ä¸»æœº
- [x] é‡å¯æŒ‰é’®ä»…ç®¡ç†å‘˜å¯è§
- [x] é‡å¯APIéœ€è¦ç®¡ç†å‘˜æƒé™
- [x] å®¹å™¨è‡ªåŠ¨é‡å¯æˆåŠŸ
- [x] é‡å¯åé…ç½®æ­£ç¡®åŠ è½½
- [x] é‡å¯ååº”ç”¨æ­£å¸¸è®¿é—®

---

**æ‰€æœ‰åŠŸèƒ½å·²éƒ¨ç½²å®Œæˆå¹¶é€šè¿‡æµ‹è¯•ï¼** ğŸ‰

ä¸‹ä¸€æ­¥: éœ€è¦æ›´æ–°åå‘ä»£ç†é…ç½®ï¼Œå°†åŸŸåæŒ‡å‘æ–°ç«¯å£8800ã€‚
