# å®šæ—¶ä»»åŠ¡æ—¥å¿—ç³»ç»Ÿ - éƒ¨ç½²è¯´æ˜

## ğŸ“‹ æ–°å¢åŠŸèƒ½

### 1. ä¸“é—¨çš„åŒæ­¥æ—¥å¿—è®°å½•ç³»ç»Ÿ
- **æ—¥å¿—æ¨¡å‹** - å®Œæ•´è®°å½•æ¯æ¬¡åŒæ­¥çš„è¯¦ç»†ä¿¡æ¯
- **æ—¥å¿—æœåŠ¡** - è‡ªåŠ¨è®°å½•åŒæ­¥è¿‡ç¨‹ä¸­çš„æ‰€æœ‰æ­¥éª¤
- **æ—¥å¿—API** - RESTfulæ¥å£æŸ¥è¯¢åŒæ­¥å†å²
- **æ—¥å¿—é¡µé¢** - Web UIæŸ¥çœ‹åŒæ­¥æ—¥å¿—å’Œç»Ÿè®¡

### 2. åŠŸèƒ½ç‰¹æ€§
- âœ… **è‡ªåŠ¨è®°å½•** - å®šæ—¶ä»»åŠ¡å’Œæ‰‹åŠ¨åŒæ­¥è‡ªåŠ¨ç”Ÿæˆæ—¥å¿—
- âœ… **è¯¦ç»†è¿½è¸ª** - è®°å½•æ¯ä¸ªå…¬å¸ã€æ¯ä¸ªæ­¥éª¤çš„æ‰§è¡Œæƒ…å†µ
- âœ… **ç»Ÿè®¡åˆ†æ** - æˆåŠŸç‡ã€è€—æ—¶ã€ç”¨æˆ·æ•°ç­‰ç»Ÿè®¡æŒ‡æ ‡
- âœ… **é”™è¯¯å®šä½** - è¯¦ç»†è®°å½•é”™è¯¯ä¿¡æ¯å’Œå †æ ˆè·Ÿè¸ª
- âœ… **æŒä¹…åŒ–** - JSONæ–‡ä»¶å­˜å‚¨ï¼Œæ”¯æŒå†å²æŸ¥è¯¢
- âœ… **è‡ªåŠ¨æ¸…ç†** - å®šæœŸæ¸…ç†è¶…è¿‡30å¤©çš„æ—§æ—¥å¿—

---

## ğŸ“ æ–°å¢æ–‡ä»¶

### 1. æ¨¡å‹æ–‡ä»¶
```
SyncEkpToCasdoor.Web/Models/SyncLog.cs
- SyncLog: åŒæ­¥æ—¥å¿—ä¸»æ¨¡å‹
- SyncStatistics: åŒæ­¥ç»Ÿè®¡ä¿¡æ¯
- SyncLogEntry: æ—¥å¿—æ¡ç›®ï¼ˆè¯¦ç»†æ­¥éª¤ï¼‰
```

### 2. æœåŠ¡æ–‡ä»¶
```
SyncEkpToCasdoor.Web/Services/SyncLogService.cs
- ISyncLogService: æ—¥å¿—æœåŠ¡æ¥å£
- SyncLogService: æ—¥å¿—æœåŠ¡å®ç°
- SyncLogSummary: æ—¥å¿—æ‘˜è¦æ¨¡å‹
```

### 3. æ§åˆ¶å™¨
```
SyncEkpToCasdoor.Web/Controllers/SyncLogsController.cs
API ç«¯ç‚¹:
- GET /api/synclogs - è·å–æœ€è¿‘æ—¥å¿—åˆ—è¡¨
- GET /api/synclogs/{id} - è·å–æ—¥å¿—è¯¦æƒ…
- GET /api/synclogs/summary - è·å–ç»Ÿè®¡æ‘˜è¦
- POST /api/synclogs/cleanup - æ¸…ç†æ—§æ—¥å¿—ï¼ˆç®¡ç†å‘˜ï¼‰
```

### 4. é¡µé¢ç»„ä»¶
```
SyncEkpToCasdoor.Web/Components/Pages/SyncLogs.razor
- åŒæ­¥æ—¥å¿—åˆ—è¡¨å±•ç¤º
- ç»Ÿè®¡å¡ç‰‡ï¼ˆæ€»æ¬¡æ•°ã€æˆåŠŸç‡ã€å¹³å‡è€—æ—¶ï¼‰
- æ—¥å¿—è¯¦æƒ…æ¨¡æ€æ¡†ï¼ˆæ­¥éª¤è¿½è¸ªã€é”™è¯¯ä¿¡æ¯ï¼‰
```

---

## ğŸ› ï¸ ä¿®æ”¹çš„æ–‡ä»¶

### 1. Program.cs
```csharp
// æ–°å¢ï¼šæ³¨å†ŒåŒæ­¥æ—¥å¿—æœåŠ¡
builder.Services.AddSingleton<ISyncLogService, SyncLogService>();
```

### 2. ScheduledSyncService.cs
- é›†æˆ ISyncLogService
- è‡ªåŠ¨åˆ›å»ºåŒæ­¥æ—¥å¿—
- è®°å½•æ¯ä¸ªå…¬å¸çš„åŒæ­¥æ­¥éª¤
- è®°å½•æˆåŠŸ/å¤±è´¥ç»Ÿè®¡ä¿¡æ¯
- è¯¦ç»†è®°å½•é”™è¯¯å †æ ˆ

### 3. NavMenu.razor
```razor
<!-- æ–°å¢ï¼šåŒæ­¥æ—¥å¿—å¯¼èˆªé“¾æ¥ -->
<NavLink href="sync-logs">
    <span class="bi bi-journal-text"></span> åŒæ­¥æ—¥å¿—
</NavLink>
```

### 4. docker-compose.yml
```yaml
volumes:
  # æ–°å¢ï¼šæŒä¹…åŒ–åŒæ­¥æ—¥å¿—
  - ./sync_logs:/app/sync_logs
```

---

## ğŸ“¦ éƒ¨ç½²æ­¥éª¤

### 1. ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨
```powershell
# ä»æœ¬åœ°ä¸Šä¼ æ–°æ–‡ä»¶
scp -r Models/SyncLog.cs root@172.16.10.110:/root/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/SyncEkpToCasdoor.Web/Models/
scp Services/SyncLogService.cs root@172.16.10.110:/root/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/SyncEkpToCasdoor.Web/Services/
scp Controllers/SyncLogsController.cs root@172.16.10.110:/root/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/SyncEkpToCasdoor.Web/Controllers/
scp Components/Pages/SyncLogs.razor root@172.16.10.110:/root/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/SyncEkpToCasdoor.Web/Components/Pages/

# ä¸Šä¼ ä¿®æ”¹çš„æ–‡ä»¶
scp Program.cs root@172.16.10.110:/root/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/SyncEkpToCasdoor.Web/
scp Services/ScheduledSyncService.cs root@172.16.10.110:/root/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/SyncEkpToCasdoor.Web/Services/
scp Components/Layout/NavMenu.razor root@172.16.10.110:/root/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/SyncEkpToCasdoor.Web/Components/Layout/
scp docker-compose.yml root@172.16.10.110:/root/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/
```

### 2. åˆ›å»ºæ—¥å¿—ç›®å½•
```bash
ssh root@172.16.10.110
cd /root/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker
mkdir -p sync_logs
chmod 777 sync_logs
```

### 3. é‡æ–°æ„å»ºå¹¶å¯åŠ¨å®¹å™¨
```bash
docker compose down
docker compose build sync-web
docker compose up -d sync-web
```

### 4. éªŒè¯éƒ¨ç½²
```bash
# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker ps | grep syncekp

# æ£€æŸ¥æ—¥å¿—ç›®å½•
ls -la sync_logs/

# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
docker logs syncekp-web --tail 50
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### 1. è®¿é—®æ—¥å¿—é¡µé¢
```
http://172.16.10.110:8800/sync-logs
```

### 2. æµ‹è¯•APIç«¯ç‚¹
```powershell
# è·å–æ—¥å¿—åˆ—è¡¨
Invoke-WebRequest -Uri 'http://172.16.10.110:8800/api/synclogs' -UseBasicParsing

# è·å–ç»Ÿè®¡æ‘˜è¦
Invoke-WebRequest -Uri 'http://172.16.10.110:8800/api/synclogs/summary' -UseBasicParsing
```

### 3. è§¦å‘å®šæ—¶ä»»åŠ¡ï¼ˆæµ‹è¯•æ—¥å¿—è®°å½•ï¼‰
```bash
# ä¿®æ”¹é…ç½®å¯ç”¨å®šæ—¶åŒæ­¥ï¼ˆé—´éš”æ”¹ä¸º60ç§’æµ‹è¯•ï¼‰
vim /root/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/config/appsettings.json

# ä¿®æ”¹ä»¥ä¸‹éƒ¨åˆ†:
"ScheduledSync": {
  "Enabled": true,
  "IntervalSeconds": 60
}

# é‡å¯åº”ç”¨
docker restart syncekp-web

# ç­‰å¾…60ç§’åæ£€æŸ¥æ—¥å¿—æ–‡ä»¶
cat sync_logs/sync_history.json
```

### 4. éªŒè¯æ—¥å¿—æŒä¹…åŒ–
```bash
# æ£€æŸ¥æ—¥å¿—æ–‡ä»¶æ˜¯å¦ç”Ÿæˆ
ls -lh /root/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/sync_logs/

# æŸ¥çœ‹æ—¥å¿—å†…å®¹
cat sync_logs/sync_history.json | jq '.[0]' # éœ€è¦å®‰è£…jqå·¥å…·

# æˆ–ç›´æ¥æŸ¥çœ‹
head -50 sync_logs/sync_history.json
```

---

## ğŸ“Š æ—¥å¿—æ•°æ®ç»“æ„

### åŒæ­¥æ—¥å¿—ç¤ºä¾‹
```json
{
  "id": "20251101120000_a1b2c3d4",
  "startTime": "2025-11-01T12:00:00",
  "endTime": "2025-11-01T12:05:30",
  "durationMs": 330000,
  "syncType": "Scheduled",
  "status": "Success",
  "companyIds": ["1", "2", "3"],
  "statistics": {
    "totalCompanies": 3,
    "successfulCompanies": 3,
    "failedCompanies": 0,
    "totalDepartments": 45,
    "totalUsers": 523,
    "newOrganizations": 2,
    "updatedOrganizations": 43,
    "newUsers": 15,
    "updatedUsers": 508
  },
  "triggeredBy": "System",
  "entries": [
    {
      "timestamp": "2025-11-01T12:00:00",
      "level": "Info",
      "step": "Start",
      "message": "å¼€å§‹ScheduledåŒæ­¥ï¼Œç›®æ ‡å…¬å¸æ•°: 3"
    },
    {
      "timestamp": "2025-11-01T12:00:05",
      "level": "Info",
      "step": "SyncCompany",
      "companyId": "1",
      "message": "å¼€å§‹åŒæ­¥å…¬å¸"
    },
    {
      "timestamp": "2025-11-01T12:02:30",
      "level": "Info",
      "step": "SyncCompany",
      "companyId": "1",
      "message": "å…¬å¸åŒæ­¥å®Œæˆ"
    }
  ]
}
```

---

## ğŸ” è¿ç»´ä½¿ç”¨æŒ‡å—

### 1. æŸ¥çœ‹æœ€è¿‘åŒæ­¥è®°å½•
è®¿é—®: http://172.16.10.110:8800/sync-logs

### 2. åˆ†æåŒæ­¥å¤±è´¥åŸå› 
1. åœ¨æ—¥å¿—åˆ—è¡¨ä¸­æ‰¾åˆ°å¤±è´¥çš„è®°å½•ï¼ˆçº¢è‰²æ ‡è®°ï¼‰
2. ç‚¹å‡»"è¯¦æƒ…"æŒ‰é’®æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
3. åœ¨"è¯¦ç»†æ—¥å¿—"åŒºåŸŸæŸ¥æ‰¾ Error çº§åˆ«çš„æ¡ç›®
4. å±•å¼€"æŸ¥çœ‹è¯¦æƒ…"æŸ¥çœ‹å®Œæ•´é”™è¯¯å †æ ˆ

### 3. ç›‘æ§åŒæ­¥æ€§èƒ½
- æŸ¥çœ‹ç»Ÿè®¡å¡ç‰‡ä¸­çš„"å¹³å‡è€—æ—¶"
- å¯¹æ¯”ä¸åŒæ—¶é—´æ®µçš„åŒæ­¥è€—æ—¶
- è¯†åˆ«æ€§èƒ½ç“¶é¢ˆ

### 4. æ¸…ç†æ—§æ—¥å¿—
```bash
# æ–¹å¼1: é€šè¿‡APIï¼ˆéœ€ç®¡ç†å‘˜ç™»å½•ï¼‰
POST http://172.16.10.110:8800/api/synclogs/cleanup?retentionDays=30

# æ–¹å¼2: æ‰‹åŠ¨åˆ é™¤æ–‡ä»¶
rm /root/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/sync_logs/sync_history.json
```

### 5. å¯¼å‡ºæ—¥å¿—åˆ†æ
```bash
# ä¸‹è½½æ—¥å¿—æ–‡ä»¶è¿›è¡Œç¦»çº¿åˆ†æ
scp root@172.16.10.110:/root/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/sync_logs/sync_history.json ./

# ä½¿ç”¨jqå·¥å…·åˆ†æï¼ˆéœ€è¦å®‰è£…jqï¼‰
cat sync_history.json | jq '.[] | select(.status=="Failed")'
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥ä¼˜åŒ–å»ºè®®

1. **æ—¥å¿—åˆ†çº§å­˜å‚¨** - å°†æ—¥å¿—æŒ‰æ—¥æœŸåˆ†æ–‡ä»¶å­˜å‚¨ï¼Œé¿å…å•æ–‡ä»¶è¿‡å¤§
2. **æ•°æ®åº“å­˜å‚¨** - ä½¿ç”¨SQLiteæˆ–å…¶ä»–æ•°æ®åº“æ›¿ä»£JSONæ–‡ä»¶
3. **æ—¥å¿—æœç´¢** - æ·»åŠ æ—¥æœŸèŒƒå›´ã€çŠ¶æ€ã€å…¬å¸IDç­‰ç­›é€‰æ¡ä»¶
4. **å›¾è¡¨å±•ç¤º** - æ·»åŠ åŒæ­¥è¶‹åŠ¿å›¾è¡¨ã€æˆåŠŸç‡æ›²çº¿
5. **å‘Šè­¦é€šçŸ¥** - åŒæ­¥å¤±è´¥æ—¶å‘é€é‚®ä»¶/é’‰é’‰é€šçŸ¥
6. **æ—¥å¿—å½’æ¡£** - è‡ªåŠ¨å‹ç¼©å’Œå½’æ¡£è¶…è¿‡90å¤©çš„æ—¥å¿—

---

## âœ… éªŒè¯æ¸…å•

- [ ] æ—¥å¿—æ–‡ä»¶ç›®å½•åˆ›å»ºæˆåŠŸ
- [ ] å®¹å™¨æŒ‚è½½ sync_logs å·
- [ ] å®šæ—¶ä»»åŠ¡è§¦å‘åç”Ÿæˆæ—¥å¿—æ–‡ä»¶
- [ ] Webé¡µé¢èƒ½æ­£å¸¸è®¿é—®æ—¥å¿—åˆ—è¡¨
- [ ] æ—¥å¿—è¯¦æƒ…èƒ½æ­£å¸¸å±•å¼€æŸ¥çœ‹
- [ ] ç»Ÿè®¡å¡ç‰‡æ˜¾ç¤ºæ­£ç¡®æ•°æ®
- [ ] æ—¥å¿—åœ¨å®¹å™¨é‡å¯åä¾ç„¶å­˜åœ¨
- [ ] æ‰‹åŠ¨åŒæ­¥ä¹Ÿèƒ½è®°å½•æ—¥å¿—ï¼ˆå¾…å®ç°ï¼‰

---

**éƒ¨ç½²æ—¶é—´**: 2025å¹´11æœˆ1æ—¥  
**ç‰ˆæœ¬**: v2.1.0  
**æ–°å¢åŠŸèƒ½**: å®šæ—¶ä»»åŠ¡ä¸“é—¨æ—¥å¿—è®°å½•ç³»ç»Ÿ
