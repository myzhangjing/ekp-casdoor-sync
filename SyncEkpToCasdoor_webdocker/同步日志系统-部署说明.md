# 定时任务日志系统 - 部署说明

## 📋 新增功能

### 1. 专门的同步日志记录系统
- **日志模型** - 完整记录每次同步的详细信息
- **日志服务** - 自动记录同步过程中的所有步骤
- **日志API** - RESTful接口查询同步历史
- **日志页面** - Web UI查看同步日志和统计

### 2. 功能特性
- ✅ **自动记录** - 定时任务和手动同步自动生成日志
- ✅ **详细追踪** - 记录每个公司、每个步骤的执行情况
- ✅ **统计分析** - 成功率、耗时、用户数等统计指标
- ✅ **错误定位** - 详细记录错误信息和堆栈跟踪
- ✅ **持久化** - JSON文件存储，支持历史查询
- ✅ **自动清理** - 定期清理超过30天的旧日志

---

## 📁 新增文件

### 1. 模型文件
```
SyncEkpToCasdoor.Web/Models/SyncLog.cs
- SyncLog: 同步日志主模型
- SyncStatistics: 同步统计信息
- SyncLogEntry: 日志条目（详细步骤）
```

### 2. 服务文件
```
SyncEkpToCasdoor.Web/Services/SyncLogService.cs
- ISyncLogService: 日志服务接口
- SyncLogService: 日志服务实现
- SyncLogSummary: 日志摘要模型
```

### 3. 控制器
```
SyncEkpToCasdoor.Web/Controllers/SyncLogsController.cs
API 端点:
- GET /api/synclogs - 获取最近日志列表
- GET /api/synclogs/{id} - 获取日志详情
- GET /api/synclogs/summary - 获取统计摘要
- POST /api/synclogs/cleanup - 清理旧日志（管理员）
```

### 4. 页面组件
```
SyncEkpToCasdoor.Web/Components/Pages/SyncLogs.razor
- 同步日志列表展示
- 统计卡片（总次数、成功率、平均耗时）
- 日志详情模态框（步骤追踪、错误信息）
```

---

## 🛠️ 修改的文件

### 1. Program.cs
```csharp
// 新增：注册同步日志服务
builder.Services.AddSingleton<ISyncLogService, SyncLogService>();
```

### 2. ScheduledSyncService.cs
- 集成 ISyncLogService
- 自动创建同步日志
- 记录每个公司的同步步骤
- 记录成功/失败统计信息
- 详细记录错误堆栈

### 3. NavMenu.razor
```razor
<!-- 新增：同步日志导航链接 -->
<NavLink href="sync-logs">
    <span class="bi bi-journal-text"></span> 同步日志
</NavLink>
```

### 4. docker-compose.yml
```yaml
volumes:
  # 新增：持久化同步日志
  - ./sync_logs:/app/sync_logs
```

---

## 📦 部署步骤

### 1. 上传文件到服务器
```powershell
# 从本地上传新文件
scp -r Models/SyncLog.cs root@172.16.10.110:/root/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/SyncEkpToCasdoor.Web/Models/
scp Services/SyncLogService.cs root@172.16.10.110:/root/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/SyncEkpToCasdoor.Web/Services/
scp Controllers/SyncLogsController.cs root@172.16.10.110:/root/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/SyncEkpToCasdoor.Web/Controllers/
scp Components/Pages/SyncLogs.razor root@172.16.10.110:/root/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/SyncEkpToCasdoor.Web/Components/Pages/

# 上传修改的文件
scp Program.cs root@172.16.10.110:/root/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/SyncEkpToCasdoor.Web/
scp Services/ScheduledSyncService.cs root@172.16.10.110:/root/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/SyncEkpToCasdoor.Web/Services/
scp Components/Layout/NavMenu.razor root@172.16.10.110:/root/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/SyncEkpToCasdoor.Web/Components/Layout/
scp docker-compose.yml root@172.16.10.110:/root/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/
```

### 2. 创建日志目录
```bash
ssh root@172.16.10.110
cd /root/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker
mkdir -p sync_logs
chmod 777 sync_logs
```

### 3. 重新构建并启动容器
```bash
docker compose down
docker compose build sync-web
docker compose up -d sync-web
```

### 4. 验证部署
```bash
# 检查容器状态
docker ps | grep syncekp

# 检查日志目录
ls -la sync_logs/

# 查看应用日志
docker logs syncekp-web --tail 50
```

---

## 🧪 测试验证

### 1. 访问日志页面
```
http://172.16.10.110:8800/sync-logs
```

### 2. 测试API端点
```powershell
# 获取日志列表
Invoke-WebRequest -Uri 'http://172.16.10.110:8800/api/synclogs' -UseBasicParsing

# 获取统计摘要
Invoke-WebRequest -Uri 'http://172.16.10.110:8800/api/synclogs/summary' -UseBasicParsing
```

### 3. 触发定时任务（测试日志记录）
```bash
# 修改配置启用定时同步（间隔改为60秒测试）
vim /root/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/config/appsettings.json

# 修改以下部分:
"ScheduledSync": {
  "Enabled": true,
  "IntervalSeconds": 60
}

# 重启应用
docker restart syncekp-web

# 等待60秒后检查日志文件
cat sync_logs/sync_history.json
```

### 4. 验证日志持久化
```bash
# 检查日志文件是否生成
ls -lh /root/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/sync_logs/

# 查看日志内容
cat sync_logs/sync_history.json | jq '.[0]' # 需要安装jq工具

# 或直接查看
head -50 sync_logs/sync_history.json
```

---

## 📊 日志数据结构

### 同步日志示例
```json
{
  "id": "20251101120000_a1b2c3d4",
  "startTime": "2025-11-01T12:00:00",
  "endTime": "2025-11-01T12:05:30",
  "durationMs": 330000,
  "syncType": "Scheduled",
  "status": "Success",
  "companyIds": ["1", "2", "3"],
  "statistics": {
    "totalCompanies": 3,
    "successfulCompanies": 3,
    "failedCompanies": 0,
    "totalDepartments": 45,
    "totalUsers": 523,
    "newOrganizations": 2,
    "updatedOrganizations": 43,
    "newUsers": 15,
    "updatedUsers": 508
  },
  "triggeredBy": "System",
  "entries": [
    {
      "timestamp": "2025-11-01T12:00:00",
      "level": "Info",
      "step": "Start",
      "message": "开始Scheduled同步，目标公司数: 3"
    },
    {
      "timestamp": "2025-11-01T12:00:05",
      "level": "Info",
      "step": "SyncCompany",
      "companyId": "1",
      "message": "开始同步公司"
    },
    {
      "timestamp": "2025-11-01T12:02:30",
      "level": "Info",
      "step": "SyncCompany",
      "companyId": "1",
      "message": "公司同步完成"
    }
  ]
}
```

---

## 🔍 运维使用指南

### 1. 查看最近同步记录
访问: http://172.16.10.110:8800/sync-logs

### 2. 分析同步失败原因
1. 在日志列表中找到失败的记录（红色标记）
2. 点击"详情"按钮查看详细日志
3. 在"详细日志"区域查找 Error 级别的条目
4. 展开"查看详情"查看完整错误堆栈

### 3. 监控同步性能
- 查看统计卡片中的"平均耗时"
- 对比不同时间段的同步耗时
- 识别性能瓶颈

### 4. 清理旧日志
```bash
# 方式1: 通过API（需管理员登录）
POST http://172.16.10.110:8800/api/synclogs/cleanup?retentionDays=30

# 方式2: 手动删除文件
rm /root/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/sync_logs/sync_history.json
```

### 5. 导出日志分析
```bash
# 下载日志文件进行离线分析
scp root@172.16.10.110:/root/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/sync_logs/sync_history.json ./

# 使用jq工具分析（需要安装jq）
cat sync_history.json | jq '.[] | select(.status=="Failed")'
```

---

## 🎯 下一步优化建议

1. **日志分级存储** - 将日志按日期分文件存储，避免单文件过大
2. **数据库存储** - 使用SQLite或其他数据库替代JSON文件
3. **日志搜索** - 添加日期范围、状态、公司ID等筛选条件
4. **图表展示** - 添加同步趋势图表、成功率曲线
5. **告警通知** - 同步失败时发送邮件/钉钉通知
6. **日志归档** - 自动压缩和归档超过90天的日志

---

## ✅ 验证清单

- [ ] 日志文件目录创建成功
- [ ] 容器挂载 sync_logs 卷
- [ ] 定时任务触发后生成日志文件
- [ ] Web页面能正常访问日志列表
- [ ] 日志详情能正常展开查看
- [ ] 统计卡片显示正确数据
- [ ] 日志在容器重启后依然存在
- [ ] 手动同步也能记录日志（待实现）

---

**部署时间**: 2025年11月1日  
**版本**: v2.1.0  
**新增功能**: 定时任务专门日志记录系统
