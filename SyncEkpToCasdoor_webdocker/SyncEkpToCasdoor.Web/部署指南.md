# 🚀 SyncEkpToCasdoor.Web 部署说明

## 📦 部署包已创建
- 文件: `deploy_20251031_165043.zip`
- 位置: `C:\Users\ThinkPad\Desktop\VSCOD\SyncEkpToCasdoor_webdocker\SyncEkpToCasdoor.Web\`

## 🔐 服务器信息
- IP: 172.16.10.110
- 用户: root
- 密码: fwater@163.com
- 部署路径: /opt/syncekp-web
- 端口: 9000

## ⚡ 快速部署（3步完成）

### 步骤1: 上传文件
在当前 PowerShell 窗口中，SCP 命令正在等待你输入密码。

**请在终端中输入**: `fwater@163.com` 然后按回车

（密码输入时不会显示，这是正常的）

### 步骤2: 连接服务器并部署
文件上传成功后，执行以下命令：

```powershell
ssh -o StrictHostKeyChecking=no root@172.16.10.110
```

再次输入密码: `fwater@163.com`

### 步骤3: 在服务器上执行部署
连接成功后，复制粘贴以下所有命令（一次性执行）：

```bash
cd /opt
mkdir -p syncekp-web
cd syncekp-web

echo "==> 解压文件..."
unzip -o /tmp/deploy_20251031_165043.zip
rm /tmp/deploy_20251031_165043.zip

echo "==> 停止旧容器..."
docker stop syncekp-casdoor-web 2>/dev/null || true
docker rm syncekp-casdoor-web 2>/dev/null || true

echo "==> 构建 Docker 镜像..."
docker-compose build

echo "==> 启动新容器..."
docker-compose up -d

echo "==> 等待启动..."
sleep 5

echo "==> 检查容器状态..."
docker ps | grep syncekp

echo "==> 查看日志（最后20行）..."
docker logs --tail 20 syncekp-casdoor-web

echo ""
echo "========================================"
echo "部署完成！"
echo "========================================"
echo "内网访问: http://172.16.10.110:9000"
echo "外网访问: http://syn-ekp.fzcsps.com:9000"
echo ""
echo "查看实时日志: docker logs -f syncekp-casdoor-web"
echo "========================================"
```

## ✅ 验证部署

在浏览器中访问：
- http://172.16.10.110:9000
- http://syn-ekp.fzcsps.com:9000

应该看到登录页面。

## 📋 常用命令

```bash
# 查看容器状态
docker ps | grep syncekp

# 查看实时日志
docker logs -f syncekp-casdoor-web

# 重启容器
docker restart syncekp-casdoor-web

# 停止容器
docker stop syncekp-casdoor-web

# 启动容器
docker start syncekp-casdoor-web

# 查看容器详细信息
docker inspect syncekp-casdoor-web

# 进入容器
docker exec -it syncekp-casdoor-web /bin/bash
```

## 🔧 故障排查

### 问题1: 端口已被占用
```bash
# 查看端口占用
netstat -tulpn | grep 9000
# 或
lsof -i:9000

# 停止占用端口的进程
kill -9 <PID>
```

### 问题2: 容器启动失败
```bash
# 查看详细错误
docker logs syncekp-casdoor-web

# 查看容器状态
docker ps -a | grep syncekp

# 删除容器重新启动
docker rm -f syncekp-casdoor-web
docker-compose up -d
```

### 问题3: 镜像构建失败
```bash
# 清理缓存重新构建
docker-compose build --no-cache

# 查看 Docker 磁盘空间
df -h
docker system df

# 清理无用的镜像和容器
docker system prune -a
```

### 问题4: 无法访问9000端口
```bash
# CentOS/RHEL 开放端口
firewall-cmd --permanent --add-port=9000/tcp
firewall-cmd --reload

# Ubuntu/Debian 开放端口
ufw allow 9000/tcp
ufw reload

# 检查防火墙状态
firewall-cmd --list-ports  # CentOS
ufw status                  # Ubuntu
```

### 问题5: Docker 服务未启动
```bash
# 启动 Docker
systemctl start docker
systemctl enable docker

# 检查 Docker 状态
systemctl status docker
```

## 📊 Docker Compose 配置

`docker-compose.yml` 内容：
- **容器名**: syncekp-casdoor-web
- **端口映射**: 9000:9000
- **环境**: Production
- **重启策略**: unless-stopped
- **日志目录**: ./logs (挂载到容器)
- **状态文件**: ./sync_state.json (挂载到容器)

## 🔄 更新部署

后续更新时，重复以下步骤：
1. 在本地创建新的部署包
2. 上传到服务器 /tmp/
3. 解压并重启容器

或者使用快速更新命令：
```bash
cd /opt/syncekp-web
docker-compose down
unzip -o /tmp/deploy_新时间戳.zip
docker-compose build
docker-compose up -d
```

## 📞 需要帮助？

如果遇到问题，请检查：
1. **容器日志**: `docker logs syncekp-casdoor-web`
2. **容器状态**: `docker ps -a`
3. **端口占用**: `netstat -tulpn | grep 9000`
4. **防火墙**: `firewall-cmd --list-ports`
5. **磁盘空间**: `df -h`

---

**提示**: 
- 密码输入时不会显示任何字符，这是正常的安全行为
- 如果SSH连接超时，请检查服务器IP和网络连接
- 首次部署预计需要5-10分钟（下载 .NET 9 镜像）
