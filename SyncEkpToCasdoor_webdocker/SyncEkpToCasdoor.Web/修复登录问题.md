# 快速修复登录按钮问题

## 问题原因
控制器路由 (`/challenge`, `/logout`, `/callback`) 被 Blazor 路由覆盖了，导致点击登录按钮没有反应。

## 解决方案

在服务器SSH终端中执行以下命令：

### 方法1：直接修改服务器上的文件（推荐）

```bash
# 1. 停止容器
cd /opt/syncekp-web
docker stop syncekp-casdoor-web
docker rm syncekp-casdoor-web

# 2. 修改 Program.cs（调整路由顺序）
sed -i '/app.UseAntiforgery();/a\\n// 映射控制器路由（必须在 Blazor 路由之前）\napp.MapControllers();' Program.cs
sed -i '/\/\/ 映射控制器路由$/,/app.MapControllers();$/d' Program.cs

# 或者手动编辑
vi Program.cs

# 找到这几行：
#   app.UseAntiforgery();
#
#   app.MapStaticAssets();
#   app.MapRazorComponents<App>()
#       .AddInteractiveServerRenderMode();
#
#   // 映射控制器路由
#   app.MapControllers();

# 改成：
#   app.UseAntiforgery();
#
#   // 映射控制器路由（必须在 Blazor 路由之前）
#   app.MapControllers();
#
#   app.MapStaticAssets();
#   app.MapRazorComponents<App>()
#       .AddInteractiveServerRenderMode();

# 3. 重新构建并启动
docker compose build
docker compose up -d

# 4. 检查状态
sleep 5
docker ps | grep syncekp
docker logs --tail 30 syncekp-casdoor-web
```

### 方法2：使用修复包（如果文件已上传）

```bash
cd /opt/syncekp-web

# 停止容器
docker stop syncekp-casdoor-web
docker rm syncekp-casdoor-web

# 解压修复包
unzip -o /tmp/deploy_fix_20251031_170947.zip

# 重新构建
docker compose build

# 启动
docker compose up -d

# 检查
sleep 5
docker ps | grep syncekp
docker logs --tail 30 syncekp-casdoor-web
```

## 验证修复

### 1. 测试 /challenge 端点
```bash
curl -I http://localhost:9000/challenge
```

应该看到：
```
HTTP/1.1 302 Found
Location: http://sso.fzcsps.com/login/oauth/authorize?...
```

### 2. 测试登录功能
1. 打开浏览器访问 http://172.16.10.110:9000
2. 点击"通过 Casdoor 登录"按钮
3. 应该自动跳转到 http://sso.fzcsps.com 的登录页面

## 为什么会出现这个问题？

在 ASP.NET Core 中，路由的注册顺序很重要：
- Blazor 使用 `app.MapRazorComponents()` 注册路由
- 控制器使用 `app.MapControllers()` 注册路由
- 如果控制器路由在 Blazor 之后注册，Blazor 会尝试处理 `/challenge` 等路径
- 因为 Blazor 找不到对应的页面，所以返回默认页面

**解决方法**：把 `app.MapControllers()` 移到 `app.MapRazorComponents()` 之前。

---

**现在请在SSH终端执行上述命令完成修复！**
