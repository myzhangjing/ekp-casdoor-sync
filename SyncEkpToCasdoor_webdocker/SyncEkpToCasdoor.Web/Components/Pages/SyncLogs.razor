@page "/sync-logs"
@inject IHttpClientFactory HttpFactory
@inject NavigationManager Navigation

<PageTitle>åŒæ­¥æ—¥å¿—</PageTitle>

<h1>ğŸ“ åŒæ­¥æ—¥å¿—</h1>

@if (isLoading)
{
    <div class="text-center my-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">åŠ è½½ä¸­...</span>
        </div>
        <p class="mt-2">æ­£åœ¨åŠ è½½æ—¥å¿—...</p>
    </div>
}
else
{
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    @if (summary != null)
    {
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-muted">æ€»åŒæ­¥æ¬¡æ•°</h5>
                        <h2 class="text-primary">@summary.TotalSyncs</h2>
                        <small class="text-muted">æœ€è¿‘24å°æ—¶</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-muted">æˆåŠŸ</h5>
                        <h2 class="text-success">@summary.SuccessfulSyncs</h2>
                        <small class="text-muted">@GetSuccessRate(summary)%</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-muted">å¤±è´¥</h5>
                        <h2 class="text-danger">@summary.FailedSyncs</h2>
                        <small class="text-muted">éƒ¨åˆ†æˆåŠŸ: @summary.PartialSuccessSyncs</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-muted">å¹³å‡è€—æ—¶</h5>
                        <h2 class="text-info">@FormatDuration(summary.AverageDurationMs)</h2>
                        <small class="text-muted">@(summary.LastSyncTime?.ToString("MM-dd HH:mm") ?? "æ— ")</small>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- æ—¥å¿—åˆ—è¡¨ -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">ğŸ•’ åŒæ­¥å†å²</h5>
            <div>
                <button class="btn btn-sm btn-outline-secondary me-2" @onclick="RefreshLogs">
                    <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°
                </button>
                <select class="form-select form-select-sm d-inline-block w-auto" @onchange="OnPageSizeChange">
                    <option value="20" selected>æ˜¾ç¤º 20 æ¡</option>
                    <option value="50">æ˜¾ç¤º 50 æ¡</option>
                    <option value="100">æ˜¾ç¤º 100 æ¡</option>
                </select>
            </div>
        </div>
        <div class="card-body p-0">
            @if (logs == null || !logs.Any())
            {
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                    <p class="mt-3">æš‚æ— åŒæ­¥æ—¥å¿—</p>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>æ—¶é—´</th>
                                <th>ç±»å‹</th>
                                <th>çŠ¶æ€</th>
                                <th>å…¬å¸æ•°</th>
                                <th>ç”¨æˆ·/éƒ¨é—¨</th>
                                <th>è€—æ—¶</th>
                                <th>è§¦å‘è€…</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var log in logs)
                            {
                                <tr>
                                    <td>
                                        <small>@log.StartTime.ToString("yyyy-MM-dd")</small><br>
                                        <strong>@log.StartTime.ToString("HH:mm:ss")</strong>
                                    </td>
                                    <td>
                                        <span class="badge bg-@GetSyncTypeBadge(log.SyncType)">
                                            @GetSyncTypeText(log.SyncType)
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-@GetStatusBadge(log.Status)">
                                            @GetStatusIcon(log.Status) @GetStatusText(log.Status)
                                        </span>
                                    </td>
                                    <td>
                                        <strong>@log.Statistics.SuccessfulCompanies</strong> / @log.Statistics.TotalCompanies
                                        @if (log.Statistics.FailedCompanies > 0)
                                        {
                                            <small class="text-danger">(å¤±è´¥: @log.Statistics.FailedCompanies)</small>
                                        }
                                    </td>
                                    <td>
                                        <small>
                                            ç”¨æˆ·: @log.Statistics.TotalUsers<br>
                                            éƒ¨é—¨: @log.Statistics.TotalDepartments
                                        </small>
                                    </td>
                                    <td>@FormatDuration(log.DurationMs)</td>
                                    <td>@log.TriggeredBy</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" @onclick="() => ViewDetails(log.Id)">
                                            <i class="bi bi-eye"></i> è¯¦æƒ…
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
}

<!-- æ—¥å¿—è¯¦æƒ…æ¨¡æ€æ¡† -->
@if (selectedLog != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        ğŸ“‹ åŒæ­¥æ—¥å¿—è¯¦æƒ… - @selectedLog.Id
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseDetails"></button>
                </div>
                <div class="modal-body">
                    <!-- åŸºæœ¬ä¿¡æ¯ -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6>åŸºæœ¬ä¿¡æ¯</h6>
                            <table class="table table-sm table-bordered">
                                <tr>
                                    <th width="120">æ—¥å¿—ID</th>
                                    <td><code>@selectedLog.Id</code></td>
                                </tr>
                                <tr>
                                    <th>åŒæ­¥ç±»å‹</th>
                                    <td>
                                        <span class="badge bg-@GetSyncTypeBadge(selectedLog.SyncType)">
                                            @GetSyncTypeText(selectedLog.SyncType)
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <th>å¼€å§‹æ—¶é—´</th>
                                    <td>@selectedLog.StartTime.ToString("yyyy-MM-dd HH:mm:ss")</td>
                                </tr>
                                <tr>
                                    <th>ç»“æŸæ—¶é—´</th>
                                    <td>@(selectedLog.EndTime?.ToString("yyyy-MM-dd HH:mm:ss") ?? "è¿›è¡Œä¸­")</td>
                                </tr>
                                <tr>
                                    <th>è€—æ—¶</th>
                                    <td><strong>@FormatDuration(selectedLog.DurationMs)</strong></td>
                                </tr>
                                <tr>
                                    <th>è§¦å‘è€…</th>
                                    <td>@selectedLog.TriggeredBy</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>åŒæ­¥ç»Ÿè®¡</h6>
                            <table class="table table-sm table-bordered">
                                <tr>
                                    <th width="120">ç›®æ ‡å…¬å¸</th>
                                    <td>@selectedLog.Statistics.TotalCompanies ä¸ª</td>
                                </tr>
                                <tr>
                                    <th>æˆåŠŸ/å¤±è´¥</th>
                                    <td>
                                        <span class="text-success">âœ“ @selectedLog.Statistics.SuccessfulCompanies</span> /
                                        <span class="text-danger">âœ— @selectedLog.Statistics.FailedCompanies</span>
                                    </td>
                                </tr>
                                <tr>
                                    <th>åŒæ­¥éƒ¨é—¨</th>
                                    <td>@selectedLog.Statistics.TotalDepartments ä¸ª</td>
                                </tr>
                                <tr>
                                    <th>åŒæ­¥ç”¨æˆ·</th>
                                    <td>@selectedLog.Statistics.TotalUsers ä¸ª</td>
                                </tr>
                                <tr>
                                    <th>æ–°å¢/æ›´æ–°ç»„ç»‡</th>
                                    <td>
                                        <span class="text-success">+@selectedLog.Statistics.NewOrganizations</span> /
                                        <span class="text-primary">~@selectedLog.Statistics.UpdatedOrganizations</span>
                                    </td>
                                </tr>
                                <tr>
                                    <th>æ–°å¢/æ›´æ–°ç”¨æˆ·</th>
                                    <td>
                                        <span class="text-success">+@selectedLog.Statistics.NewUsers</span> /
                                        <span class="text-primary">~@selectedLog.Statistics.UpdatedUsers</span>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(selectedLog.ErrorMessage))
                    {
                        <div class="alert alert-danger">
                            <strong>é”™è¯¯ä¿¡æ¯ï¼š</strong> @selectedLog.ErrorMessage
                        </div>
                    }

                    <!-- ç›®æ ‡å…¬å¸åˆ—è¡¨ -->
                    @if (selectedLog.CompanyIds.Any())
                    {
                        <h6>ç›®æ ‡å…¬å¸åˆ—è¡¨</h6>
                        <div class="mb-3">
                            @foreach (var companyId in selectedLog.CompanyIds)
                            {
                                <span class="badge bg-secondary me-1">@companyId</span>
                            }
                        </div>
                    }

                    <!-- è¯¦ç»†æ—¥å¿— -->
                    <h6>è¯¦ç»†æ—¥å¿— (@selectedLog.Entries.Count æ¡)</h6>
                    <div class="log-entries" style="max-height: 400px; overflow-y: auto; font-family: 'Consolas', monospace; font-size: 0.85rem;">
                        @foreach (var entry in selectedLog.Entries)
                        {
                            <div class="log-entry mb-2 p-2 border-start border-@GetLevelColor(entry.Level) border-3" style="background-color: #f8f9fa;">
                                <div class="d-flex justify-content-between">
                                    <span>
                                        <span class="badge bg-@GetLevelColor(entry.Level)">@entry.Level</span>
                                        <strong>[@entry.Step]</strong>
                                        @if (!string.IsNullOrEmpty(entry.CompanyId))
                                        {
                                            <span class="text-muted">(å…¬å¸: @entry.CompanyId)</span>
                                        }
                                    </span>
                                    <small class="text-muted">@entry.Timestamp.ToString("HH:mm:ss.fff")</small>
                                </div>
                                <div class="mt-1">@entry.Message</div>
                                @if (!string.IsNullOrEmpty(entry.Details))
                                {
                                    <details class="mt-1">
                                        <summary class="text-muted" style="cursor: pointer;">æŸ¥çœ‹è¯¦æƒ…</summary>
                                        <pre class="mt-2 p-2 bg-white border rounded" style="font-size: 0.75rem;">@entry.Details</pre>
                                    </details>
                                }
                            </div>
                        }
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseDetails">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool isLoading = true;
    private List<SyncLog>? logs;
    private SyncLogSummary? summary;
    private SyncLog? selectedLog;
    private int pageSize = 20;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        try
        {
            var client = HttpFactory.CreateClient("WithCookies");

            // åŠ è½½æ‘˜è¦
            var summaryResponse = await client.GetFromJsonAsync<ApiResponse<SyncLogSummary>>("/api/synclogs/summary");
            if (summaryResponse?.Success == true)
            {
                summary = summaryResponse.Data;
            }

            // åŠ è½½æ—¥å¿—åˆ—è¡¨
            var logsResponse = await client.GetFromJsonAsync<ApiResponse<List<SyncLog>>>($"/api/synclogs?count={pageSize}");
            if (logsResponse?.Success == true)
            {
                logs = logsResponse.Data;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"åŠ è½½æ—¥å¿—å¤±è´¥: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task RefreshLogs()
    {
        await LoadData();
    }

    private async Task OnPageSizeChange(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var newSize))
        {
            pageSize = newSize;
            await LoadData();
        }
    }

    private async Task ViewDetails(string logId)
    {
        try
        {
            var client = HttpFactory.CreateClient("WithCookies");
            var response = await client.GetFromJsonAsync<ApiResponse<SyncLog>>($"/api/synclogs/{logId}");
            if (response?.Success == true)
            {
                selectedLog = response.Data;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"åŠ è½½æ—¥å¿—è¯¦æƒ…å¤±è´¥: {ex.Message}");
        }
    }

    private void CloseDetails()
    {
        selectedLog = null;
    }

    private string GetSyncTypeBadge(string type) => type switch
    {
        "Scheduled" => "primary",
        "Manual" => "info",
        "OnDemand" => "warning",
        _ => "secondary"
    };

    private string GetSyncTypeText(string type) => type switch
    {
        "Scheduled" => "â° å®šæ—¶",
        "Manual" => "ğŸ‘¤ æ‰‹åŠ¨",
        "OnDemand" => "âš¡ æŒ‰éœ€",
        _ => type
    };

    private string GetStatusBadge(string status) => status switch
    {
        "Success" => "success",
        "Failed" => "danger",
        "PartialSuccess" => "warning",
        "Running" => "info",
        _ => "secondary"
    };

    private string GetStatusIcon(string status) => status switch
    {
        "Success" => "âœ“",
        "Failed" => "âœ—",
        "PartialSuccess" => "âš ",
        "Running" => "âŸ³",
        _ => "?"
    };

    private string GetStatusText(string status) => status switch
    {
        "Success" => "æˆåŠŸ",
        "Failed" => "å¤±è´¥",
        "PartialSuccess" => "éƒ¨åˆ†æˆåŠŸ",
        "Running" => "è¿è¡Œä¸­",
        _ => status
    };

    private string GetLevelColor(string level) => level switch
    {
        "Error" => "danger",
        "Warning" => "warning",
        "Info" => "primary",
        _ => "secondary"
    };

    private string FormatDuration(long ms)
    {
        if (ms < 1000) return $"{ms}ms";
        if (ms < 60000) return $"{ms / 1000.0:F1}s";
        return $"{ms / 60000.0:F1}min";
    }

    private int GetSuccessRate(SyncLogSummary summary)
    {
        if (summary.TotalSyncs == 0) return 0;
        return (int)((double)summary.SuccessfulSyncs / summary.TotalSyncs * 100);
    }

    private class ApiResponse<T>
    {
        public bool Success { get; set; }
        public T? Data { get; set; }
    }

    private class SyncLog
    {
        public string Id { get; set; } = "";
        public DateTime StartTime { get; set; }
        public DateTime? EndTime { get; set; }
        public long DurationMs { get; set; }
        public string SyncType { get; set; } = "";
        public string Status { get; set; } = "";
        public List<string> CompanyIds { get; set; } = new();
        public SyncStatistics Statistics { get; set; } = new();
        public string? ErrorMessage { get; set; }
        public List<SyncLogEntry> Entries { get; set; } = new();
        public string TriggeredBy { get; set; } = "";
    }

    private class SyncStatistics
    {
        public int TotalCompanies { get; set; }
        public int SuccessfulCompanies { get; set; }
        public int FailedCompanies { get; set; }
        public int TotalDepartments { get; set; }
        public int TotalUsers { get; set; }
        public int NewOrganizations { get; set; }
        public int UpdatedOrganizations { get; set; }
        public int NewUsers { get; set; }
        public int UpdatedUsers { get; set; }
        public int SkippedRecords { get; set; }
    }

    private class SyncLogEntry
    {
        public DateTime Timestamp { get; set; }
        public string Level { get; set; } = "";
        public string? CompanyId { get; set; }
        public string Step { get; set; } = "";
        public string Message { get; set; } = "";
        public string? Details { get; set; }
    }

    private class SyncLogSummary
    {
        public int TotalSyncs { get; set; }
        public int SuccessfulSyncs { get; set; }
        public int FailedSyncs { get; set; }
        public int PartialSuccessSyncs { get; set; }
        public int TotalUsers { get; set; }
        public int TotalDepartments { get; set; }
        public DateTime? LastSyncTime { get; set; }
        public long AverageDurationMs { get; set; }
    }
}
