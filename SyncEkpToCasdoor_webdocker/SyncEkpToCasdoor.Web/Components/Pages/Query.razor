@page "/query"
@using SyncEkpToCasdoor.Web.Services
@using SyncEkpToCasdoor.Web.Components.Pages
@inject ISyncService SyncService
@rendermode InteractiveServer

<h3>æ•°æ®æŸ¥è¯¢</h3>

<h1>ğŸ” æ•°æ®æŸ¥è¯¢</h1>

<div class="row mt-4">
    <!-- ç”¨æˆ·æŸ¥è¯¢ -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">ğŸ‘¤ ç”¨æˆ·æŸ¥è¯¢</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">æŸ¥è¯¢æ–¹å¼</label>
                    <select class="form-select" @bind="userQueryMode">
                        <option value="single">å•ä¸ªæŸ¥è¯¢</option>
                        <option value="batch">æ‰¹é‡æŸ¥è¯¢</option>
                        <option value="list">åˆ—è¡¨æŸ¥è¯¢</option>
                    </select>
                </div>
                
                @if (userQueryMode == "single")
                {
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" placeholder="è¾“å…¥ç”¨æˆ·åæˆ–å§“å" @bind="singleUserQuery">
                        <button class="btn btn-primary" @onclick="SearchSingleUser">
                            ğŸ” æŸ¥è¯¢
                        </button>
                    </div>
                }
                else if (userQueryMode == "batch")
                {
                    <div class="mb-3">
                        <label class="form-label">æ‰¹é‡æŸ¥è¯¢ï¼ˆæ¯è¡Œä¸€ä¸ªç”¨æˆ·åï¼‰</label>
                        <textarea class="form-control" rows="5" @bind="batchUserQuery" 
                                  placeholder="user1&#10;user2&#10;user3"></textarea>
                    </div>
                    <button class="btn btn-primary w-100" @onclick="SearchBatchUsers" disabled="@isQueryingUsers">
                        @if (isQueryingUsers)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        ğŸ” æ‰¹é‡æŸ¥è¯¢
                    </button>
                }
                else if (userQueryMode == "list")
                {
                    <div class="mb-3">
                        <label class="form-label">æŸ¥è¯¢æ¡ä»¶</label>
                        <div class="row">
                            <div class="col-6">
                                <input type="text" class="form-control mb-2" placeholder="å…¬å¸åç§°" @bind="userCompanyFilter">
                            </div>
                            <div class="col-6">
                                <input type="text" class="form-control mb-2" placeholder="éƒ¨é—¨åç§°" @bind="userDeptFilter">
                            </div>
                        </div>
                        <input type="number" class="form-control mb-2" placeholder="æœ€å¤šè¿”å›æ¡æ•°ï¼ˆé»˜è®¤100ï¼‰" @bind="userListLimit" min="1" max="1000">
                    </div>
                    <button class="btn btn-primary w-100" @onclick="SearchUserList" disabled="@isQueryingUsers">
                        @if (isQueryingUsers)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        ğŸ” æŸ¥è¯¢åˆ—è¡¨
                    </button>
                }
                
                @if (searchedUsers.Any())
                {
                    <hr />
                    <div style="max-height: 500px; overflow-y: auto;">
                        <h6>æŸ¥è¯¢ç»“æœ (@searchedUsers.Count ä¸ªç”¨æˆ·)</h6>
                        @foreach (var user in searchedUsers)
                        {
                            <div class="card mb-2">
                                <div class="card-body p-3">
                                    <div class="row">
                                        <div class="col-6">
                                            <small class="text-muted">ç”¨æˆ·å:</small><br />
                                            <strong>@user.Username</strong>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">æ˜¾ç¤ºå:</small><br />
                                            <strong>@user.DisplayName</strong>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-6">
                                            <small class="text-muted">å…¬å¸:</small><br />
                                            @user.CompanyName
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">éƒ¨é—¨:</small><br />
                                            @user.Affiliation
                                        </div>
                                    </div>
                                    @if (!string.IsNullOrEmpty(user.Owner))
                                    {
                                        <div class="mt-2">
                                            <small class="text-muted">ç»„ç»‡:</small>
                                            <span class="badge bg-secondary">@user.Owner</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                    
                    <button class="btn btn-sm btn-outline-secondary mt-2" @onclick="ExportUsers">
                        ğŸ“¥ å¯¼å‡ºä¸ºCSV
                    </button>
                }
                else if (userQueryPerformed)
                {
                    <div class="alert alert-warning mt-3">
                        æœªæ‰¾åˆ°åŒ¹é…çš„ç”¨æˆ·
                    </div>
                }
            </div>
        </div>
    </div>
    
    <!-- ç»„ç»‡æŸ¥è¯¢ -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">ğŸ¢ ç»„ç»‡æŸ¥è¯¢</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">æŸ¥è¯¢æ–¹å¼</label>
                    <select class="form-select" @bind="orgQueryMode">
                        <option value="tree">å®Œæ•´æ ‘å½¢ç»“æ„</option>
                        <option value="search">æœç´¢ç»„ç»‡</option>
                        <option value="path">è·¯å¾„æŸ¥è¯¢</option>
                    </select>
                </div>
                
                @if (orgQueryMode == "search")
                {
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" placeholder="è¾“å…¥ç»„ç»‡åç§°å…³é”®å­—" @bind="orgSearchKeyword">
                        <button class="btn btn-success" @onclick="SearchOrganizations">
                            ğŸ” æœç´¢
                        </button>
                    </div>
                }
                else if (orgQueryMode == "path")
                {
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" placeholder="è¾“å…¥ç»„ç»‡ID" @bind="orgPathId">
                        <button class="btn btn-success" @onclick="GetOrganizationPath">
                            ğŸ” æŸ¥è¯¢è·¯å¾„
                        </button>
                    </div>
                }
                else
                {
                    <button class="btn btn-success w-100 mb-3" @onclick="LoadOrganizationTree" disabled="@isLoadingOrgs">
                        @if (isLoadingOrgs)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        ğŸŒ³ åŠ è½½ç»„ç»‡æ ‘
                    </button>
                }
                
                @if (organizationTree.Any())
                {
                    <hr />
                    <div style="max-height: 600px; overflow-y: auto;">
                        <h6>ç»„ç»‡ç»“æ„ (@TotalOrgCount ä¸ªç»„ç»‡)</h6>
                        @foreach (var org in organizationTree)
                        {
                            <OrgTreeNode Organization="@org" Level="0" />
                        }
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-sm btn-outline-secondary me-2" @onclick="ExpandAllOrgs">
                            â• å…¨éƒ¨å±•å¼€
                        </button>
                        <button class="btn btn-sm btn-outline-secondary me-2" @onclick="CollapseAllOrgs">
                            â– å…¨éƒ¨æ”¶èµ·
                        </button>
                        <button class="btn btn-sm btn-outline-primary" @onclick="ExportOrganizations">
                            ğŸ“¥ å¯¼å‡ºç»“æ„
                        </button>
                    </div>
                }
                else if (orgQueryPerformed)
                {
                    <div class="alert alert-warning">
                        æœªæ‰¾åˆ°ç»„ç»‡æ•°æ®
                    </div>
                }
                
                @if (currentOrgPath.Any())
                {
                    <hr />
                    <h6>ç»„ç»‡è·¯å¾„</h6>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            @foreach (var (org, index) in currentOrgPath.Select((o, i) => (o, i)))
                            {
                                <li class="breadcrumb-item @(index == currentOrgPath.Count - 1 ? "active" : "")">
                                    @org.Name
                                    @if (org.UserCount > 0)
                                    {
                                        <span class="badge bg-primary ms-1">@(org.UserCount)äºº</span>
                                    }
                                </li>
                            }
                        </ol>
                    </nav>
                }
            </div>
        </div>
    </div>
</div>

@if (!string.IsNullOrEmpty(exportMessage))
{
    <div class="row mt-4">
        <div class="col-12">
            <div class="alert alert-success alert-dismissible fade show">
                @exportMessage
                <button type="button" class="btn-close" @onclick="() => exportMessage = string.Empty"></button>
            </div>
        </div>
    </div>
}

@code {
    // ç”¨æˆ·æŸ¥è¯¢
    private string userQueryMode = "single";
    private string singleUserQuery = "";
    private string batchUserQuery = "";
    private string userCompanyFilter = "";
    private string userDeptFilter = "";
    private int userListLimit = 100;
    private List<UserInfo> searchedUsers = new();
    private bool isQueryingUsers = false;
    private bool userQueryPerformed = false;
    
    // ç»„ç»‡æŸ¥è¯¢
    private string orgQueryMode = "tree";
    private string orgSearchKeyword = "";
    private string orgPathId = "";
    private List<OrgTreeNode.OrganizationNode> organizationTree = new();
    private List<OrgTreeNode.OrganizationNode> currentOrgPath = new();
    private bool isLoadingOrgs = false;
    private bool orgQueryPerformed = false;
    
    private string exportMessage = "";
    
    private int TotalOrgCount => CountOrgs(organizationTree);
    
    private int CountOrgs(List<OrgTreeNode.OrganizationNode> nodes)
    {
        int count = nodes.Count;
        foreach (var node in nodes)
        {
            count += CountOrgs(node.Children);
        }
        return count;
    }
    
    // ç”¨æˆ·æŸ¥è¯¢æ–¹æ³•
    private async Task SearchSingleUser()
    {
        userQueryPerformed = true;
        searchedUsers.Clear();
        
        var user = await SyncService.PeekUserAsync(singleUserQuery);
        if (user != null)
        {
            searchedUsers.Add(user);
        }
        
        StateHasChanged();
    }
    
    private async Task SearchBatchUsers()
    {
        userQueryPerformed = true;
        isQueryingUsers = true;
        searchedUsers.Clear();
        
        try
        {
            var usernames = batchUserQuery.Split('\n', StringSplitOptions.RemoveEmptyEntries)
                                          .Select(u => u.Trim())
                                          .Where(u => !string.IsNullOrEmpty(u))
                                          .ToList();
            
            foreach (var username in usernames)
            {
                var user = await SyncService.PeekUserAsync(username);
                if (user != null)
                {
                    searchedUsers.Add(user);
                }
            }
        }
        finally
        {
            isQueryingUsers = false;
            StateHasChanged();
        }
    }
    
    private async Task SearchUserList()
    {
        userQueryPerformed = true;
        isQueryingUsers = true;
        searchedUsers.Clear();
        
        try
        {
            // TODO: å®ç°åˆ—è¡¨æŸ¥è¯¢API
            await Task.Delay(500); // æ¨¡æ‹ŸæŸ¥è¯¢
            
            // ç¤ºä¾‹æ•°æ®
            searchedUsers = new List<UserInfo>
            {
                new UserInfo
                {
                    Username = "zhangsan",
                    DisplayName = "å¼ ä¸‰",
                    CompanyName = "ç¦å·åŸå¸‚å»ºè®¾æŠ•èµ„é›†å›¢",
                    Affiliation = "æŠ€æœ¯éƒ¨",
                    Owner = "fzswjtOrganization"
                }
            };
        }
        finally
        {
            isQueryingUsers = false;
            StateHasChanged();
        }
    }
    
    private async Task ExportUsers()
    {
        // TODO: å®ç°å¯¼å‡ºåŠŸèƒ½
        await Task.Delay(200);
        exportMessage = $"âœ“ å·²å¯¼å‡º {searchedUsers.Count} ä¸ªç”¨æˆ·åˆ°: exports/users_{DateTime.Now:yyyyMMdd_HHmmss}.csv";
        StateHasChanged();
    }
    
    // ç»„ç»‡æŸ¥è¯¢æ–¹æ³•
    private async Task LoadOrganizationTree()
    {
        orgQueryPerformed = true;
        isLoadingOrgs = true;
        organizationTree.Clear();
        
        try
        {
            // TODO: ä»æœåŠ¡è·å–ç»„ç»‡æ ‘
            await Task.Delay(1000);
            
            // ç¤ºä¾‹æ•°æ® - æ„å»ºæ ‘å½¢ç»“æ„
            organizationTree = new List<OrgTreeNode.OrganizationNode>
            {
                new OrgTreeNode.OrganizationNode
                {
                    Id = "1",
                    Name = "ç¦å·åŸå¸‚å»ºè®¾æŠ•èµ„é›†å›¢",
                    ParentId = null,
                    UserCount = 50,
                    IsExpanded = true,
                    Children = new List<OrgTreeNode.OrganizationNode>
                    {
                        new OrgTreeNode.OrganizationNode
                        {
                            Id = "1-1",
                            Name = "æ€»ç»åŠ",
                            ParentId = "1",
                            UserCount = 10,
                            Children = new List<OrgTreeNode.OrganizationNode>()
                        },
                        new OrgTreeNode.OrganizationNode
                        {
                            Id = "1-2",
                            Name = "æŠ€æœ¯éƒ¨",
                            ParentId = "1",
                            UserCount = 25,
                            Children = new List<OrgTreeNode.OrganizationNode>
                            {
                                new OrgTreeNode.OrganizationNode
                                {
                                    Id = "1-2-1",
                                    Name = "å¼€å‘ç»„",
                                    ParentId = "1-2",
                                    UserCount = 15,
                                    Children = new List<OrgTreeNode.OrganizationNode>()
                                },
                                new OrgTreeNode.OrganizationNode
                                {
                                    Id = "1-2-2",
                                    Name = "æµ‹è¯•ç»„",
                                    ParentId = "1-2",
                                    UserCount = 10,
                                    Children = new List<OrgTreeNode.OrganizationNode>()
                                }
                            }
                        },
                        new OrgTreeNode.OrganizationNode
                        {
                            Id = "1-3",
                            Name = "è´¢åŠ¡éƒ¨",
                            ParentId = "1",
                            UserCount = 15,
                            Children = new List<OrgTreeNode.OrganizationNode>()
                        }
                    }
                }
            };
        }
        finally
        {
            isLoadingOrgs = false;
            StateHasChanged();
        }
    }
    
    private async Task SearchOrganizations()
    {
        orgQueryPerformed = true;
        // TODO: å®ç°ç»„ç»‡æœç´¢
        await LoadOrganizationTree();
        
        // è¿‡æ»¤ç»“æœ
        if (!string.IsNullOrEmpty(orgSearchKeyword))
        {
            FilterOrganizations(organizationTree, orgSearchKeyword);
        }
    }
    
    private bool FilterOrganizations(List<OrgTreeNode.OrganizationNode> nodes, string keyword)
    {
        bool hasMatch = false;
        foreach (var node in nodes.ToList())
        {
            bool childMatch = FilterOrganizations(node.Children, keyword);
            bool selfMatch = node.Name.Contains(keyword, StringComparison.OrdinalIgnoreCase);
            
            if (!selfMatch && !childMatch)
            {
                nodes.Remove(node);
            }
            else
            {
                hasMatch = true;
                node.IsExpanded = true;
            }
        }
        return hasMatch;
    }
    
    private async Task GetOrganizationPath()
    {
        currentOrgPath.Clear();
        
        // TODO: ä»æœåŠ¡è·å–ç»„ç»‡è·¯å¾„
        await Task.Delay(200);
        
        // ç¤ºä¾‹è·¯å¾„
        currentOrgPath = new List<OrgTreeNode.OrganizationNode>
        {
            new OrgTreeNode.OrganizationNode { Id = "1", Name = "ç¦å·åŸå¸‚å»ºè®¾æŠ•èµ„é›†å›¢", UserCount = 50 },
            new OrgTreeNode.OrganizationNode { Id = "1-2", Name = "æŠ€æœ¯éƒ¨", UserCount = 25 },
            new OrgTreeNode.OrganizationNode { Id = "1-2-1", Name = "å¼€å‘ç»„", UserCount = 15 }
        };
        
        StateHasChanged();
    }
    
    private void ExpandAllOrgs()
    {
        SetExpanded(organizationTree, true);
        StateHasChanged();
    }
    
    private void CollapseAllOrgs()
    {
        SetExpanded(organizationTree, false);
        StateHasChanged();
    }
    
    private void SetExpanded(List<OrgTreeNode.OrganizationNode> nodes, bool expanded)
    {
        foreach (var node in nodes)
        {
            node.IsExpanded = expanded;
            SetExpanded(node.Children, expanded);
        }
    }
    
    private async Task ExportOrganizations()
    {
        var filePath = await SyncService.ExportOrganizationHierarchyAsync();
        exportMessage = $"âœ“ ç»„ç»‡ç»“æ„å·²å¯¼å‡ºåˆ°: {filePath}";
        StateHasChanged();
    }
}
