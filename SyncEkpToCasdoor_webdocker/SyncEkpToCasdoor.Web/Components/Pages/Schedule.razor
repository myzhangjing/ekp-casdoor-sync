@page "/schedule"
@using SyncEkpToCasdoor.Web.Services
@inject ISyncService SyncService
@rendermode InteractiveServer

<PageTitle>å®šæ—¶ä»»åŠ¡</PageTitle>

<h1>â° å®šæ—¶åŒæ­¥ä»»åŠ¡</h1>

<div class="row mt-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">ğŸ“… ä»»åŠ¡åˆ—è¡¨</h5>
            </div>
            <div class="card-body">
                @if (tasks.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ä»»åŠ¡åç§°</th>
                                    <th>ä»»åŠ¡ç±»å‹</th>
                                    <th>æ‰§è¡Œæ—¶é—´</th>
                                    <th>çŠ¶æ€</th>
                                    <th class="text-center">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var task in tasks)
                                {
                                    <tr>
                                        <td>
                                            <strong>@task.Name</strong>
                                            @if (!string.IsNullOrEmpty(task.Description))
                                            {
                                                <br />
                                                <small class="text-muted">@task.Description</small>
                                            }
                                        </td>
                                        <td>
                                            <span class="badge @(task.SyncType == "full" ? "bg-primary" : "bg-secondary")">
                                                @(task.SyncType == "full" ? "å…¨é‡åŒæ­¥" : "å¢é‡åŒæ­¥")
                                            </span>
                                            @if (!string.IsNullOrEmpty(task.CompanyId))
                                            {
                                                <br />
                                                <small class="text-muted">å…¬å¸: @task.CompanyId</small>
                                            }
                                        </td>
                                        <td>
                                            @if (task.ScheduleType == "cron")
                                            {
                                                <span class="badge bg-info">Cron</span>
                                                <br />
                                                <code class="small">@task.CronExpression</code>
                                            }
                                            else if (task.ScheduleType == "interval")
                                            {
                                                <span class="badge bg-warning">é—´éš”</span>
                                                <br />
                                                <small>æ¯ @task.IntervalMinutes åˆ†é’Ÿ</small>
                                            }
                                            else if (task.ScheduleType == "daily")
                                            {
                                                <span class="badge bg-success">æ¯æ—¥</span>
                                                <br />
                                                <small>@task.DailyTime</small>
                                            }
                                        </td>
                                        <td>
                                            @if (task.Enabled)
                                            {
                                                <span class="badge bg-success">å¯ç”¨</span>
                                                @if (task.LastRunTime.HasValue)
                                                {
                                                    <br />
                                                    <small class="text-muted">
                                                        ä¸Šæ¬¡: @task.LastRunTime.Value.ToString("MM-dd HH:mm")
                                                    </small>
                                                }
                                                @if (task.NextRunTime.HasValue)
                                                {
                                                    <br />
                                                    <small class="text-success">
                                                        ä¸‹æ¬¡: @task.NextRunTime.Value.ToString("MM-dd HH:mm")
                                                    </small>
                                                }
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">ç¦ç”¨</span>
                                            }
                                        </td>
                                        <td class="text-center">
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-primary" 
                                                        @onclick="() => EditTask(task)"
                                                        title="ç¼–è¾‘">
                                                    âœï¸
                                                </button>
                                                <button class="btn @(task.Enabled ? "btn-outline-warning" : "btn-outline-success")" 
                                                        @onclick="() => ToggleTask(task.Id)"
                                                        title="@(task.Enabled ? "ç¦ç”¨" : "å¯ç”¨")">
                                                    @(task.Enabled ? "â¸ï¸" : "â–¶ï¸")
                                                </button>
                                                <button class="btn btn-outline-info" 
                                                        @onclick="() => RunTaskNow(task.Id)"
                                                        disabled="@isRunning"
                                                        title="ç«‹å³æ‰§è¡Œ">
                                                    âš¡
                                                </button>
                                                <button class="btn btn-outline-danger" 
                                                        @onclick="() => DeleteTask(task.Id)"
                                                        title="åˆ é™¤">
                                                    ğŸ—‘ï¸
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="alert alert-info">
                        <strong>â„¹ï¸</strong> æš‚æ— å®šæ—¶ä»»åŠ¡ï¼Œè¯·ç‚¹å‡»å³ä¾§"æ·»åŠ ä»»åŠ¡"æŒ‰é’®åˆ›å»ºã€‚
                    </div>
                }
            </div>
        </div>
        
        @if (executionResult != null)
        {
            <div class="alert @(executionResult.Success ? "alert-success" : "alert-danger") mt-4">
                <h6>@executionResult.TaskName - æ‰§è¡Œç»“æœ</h6>
                <p class="mb-0">@executionResult.Message</p>
                @if (executionResult.Details.Any())
                {
                    <hr />
                    <ul class="mb-0">
                        @foreach (var detail in executionResult.Details)
                        {
                            <li>@detail</li>
                        }
                    </ul>
                }
            </div>
        }
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header @(editingTask == null ? "bg-success" : "bg-warning") text-white">
                <h5 class="mb-0">@(editingTask == null ? "â• æ·»åŠ ä»»åŠ¡" : "âœï¸ ç¼–è¾‘ä»»åŠ¡")</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">ä»»åŠ¡åç§° <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" @bind="taskName" placeholder="ä¾‹å¦‚ï¼šæ¯æ—¥å‡Œæ™¨å…¨é‡åŒæ­¥">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">ä»»åŠ¡æè¿°</label>
                    <textarea class="form-control" @bind="taskDescription" rows="2" placeholder="å¯é€‰"></textarea>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">åŒæ­¥ç±»å‹ <span class="text-danger">*</span></label>
                    <select class="form-select" @bind="syncType">
                        <option value="full">å…¨é‡åŒæ­¥</option>
                        <option value="incremental">å¢é‡åŒæ­¥</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">åŒæ­¥èŒƒå›´</label>
                    <select class="form-select" @bind="syncScope" @bind:after="OnSyncScopeChanged">
                        <option value="all">å…¨éƒ¨å…¬å¸</option>
                        <option value="company">æŒ‡å®šå…¬å¸</option>
                    </select>
                </div>
                
                @if (syncScope == "company")
                {
                    <div class="mb-3">
                        <label class="form-label">é€‰æ‹©å…¬å¸</label>
                        <select class="form-select" @bind="selectedCompanyId">
                            <option value="">-- è¯·é€‰æ‹© --</option>
                            @foreach (var company in companies)
                            {
                                <option value="@company.Id">@company.Name</option>
                            }
                        </select>
                    </div>
                }
                
                <div class="mb-3">
                    <label class="form-label">è°ƒåº¦ç±»å‹ <span class="text-danger">*</span></label>
                    <select class="form-select" @bind="scheduleType">
                        <option value="daily">æ¯æ—¥å®šæ—¶</option>
                        <option value="interval">å›ºå®šé—´éš”</option>
                        <option value="cron">Cronè¡¨è¾¾å¼</option>
                    </select>
                </div>
                
                @if (scheduleType == "daily")
                {
                    <div class="mb-3">
                        <label class="form-label">æ‰§è¡Œæ—¶é—´</label>
                        <input type="text" class="form-control" @bind="dailyTimeStr" placeholder="HH:mm (ä¾‹å¦‚: 02:00)">
                        <small class="form-text text-muted">æ¯å¤©åœ¨æŒ‡å®šæ—¶é—´æ‰§è¡Œï¼Œæ ¼å¼: HH:mm</small>
                    </div>
                }
                else if (scheduleType == "interval")
                {
                    <div class="mb-3">
                        <label class="form-label">é—´éš”æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰</label>
                        <input type="number" class="form-control" @bind="intervalMinutes" min="5" max="1440">
                        <small class="form-text text-muted">æœ€å°5åˆ†é’Ÿï¼Œæœ€å¤§24å°æ—¶</small>
                    </div>
                }
                else if (scheduleType == "cron")
                {
                    <div class="mb-3">
                        <label class="form-label">Cronè¡¨è¾¾å¼</label>
                        <input type="text" class="form-control" @bind="cronExpression" placeholder="0 0 2 * * ?">
                        <small class="form-text text-muted">
                            ç¤ºä¾‹ï¼š<br />
                            0 0 2 * * ? - æ¯å¤©å‡Œæ™¨2ç‚¹<br />
                            0 0 */6 * * ? - æ¯6å°æ—¶<br />
                            0 30 8 * * 1-5 - å·¥ä½œæ—¥æ—©ä¸Š8:30
                        </small>
                    </div>
                }
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" @bind="taskEnabled" id="taskEnabled">
                    <label class="form-check-label" for="taskEnabled">
                        åˆ›å»ºåç«‹å³å¯ç”¨
                    </label>
                </div>
                
                <div class="d-grid gap-2">
                    <button class="btn @(editingTask == null ? "btn-success" : "btn-warning")" 
                            @onclick="SaveTask"
                            disabled="@(!CanSaveTask)">
                        ğŸ’¾ @(editingTask == null ? "æ·»åŠ ä»»åŠ¡" : "ä¿å­˜ä¿®æ”¹")
                    </button>
                    @if (editingTask != null)
                    {
                        <button class="btn btn-secondary" @onclick="CancelEdit">
                            å–æ¶ˆç¼–è¾‘
                        </button>
                    }
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">ğŸ’¡ ä½¿ç”¨æç¤º</h6>
            </div>
            <div class="card-body">
                <small>
                    <ul class="mb-0">
                        <li>å®šæ—¶ä»»åŠ¡åœ¨åº”ç”¨é‡å¯åä¼šè‡ªåŠ¨æ¢å¤</li>
                        <li>å»ºè®®å¢é‡åŒæ­¥é—´éš”çŸ­ï¼Œå…¨é‡åŒæ­¥é¢‘ç‡ä½</li>
                        <li>é¿å…åœ¨ä¸šåŠ¡é«˜å³°æœŸæ‰§è¡ŒåŒæ­¥</li>
                        <li>å¯ä»¥ç¦ç”¨ä»»åŠ¡è€Œä¸åˆ é™¤é…ç½®</li>
                        <li>ç«‹å³æ‰§è¡Œä¸å½±å“å®šæ—¶è®¡åˆ’</li>
                    </ul>
                </small>
            </div>
        </div>
    </div>
</div>

@code {
    private List<ScheduledTask> tasks = new();
    private List<CompanyInfo> companies = new();
    
    // è¡¨å•å­—æ®µ
    private ScheduledTask? editingTask;
    private string taskName = "";
    private string taskDescription = "";
    private string syncType = "full";
    private string syncScope = "all";
    private string selectedCompanyId = "";
    private string scheduleType = "daily";
    private string dailyTime = "02:00";
    private string dailyTimeStr = "02:00";  // input type="time"ç»‘å®šç”¨
    private int intervalMinutes = 60;
    private string cronExpression = "0 0 2 * * ?";
    private bool taskEnabled = true;
    
    private bool isRunning = false;
    private TaskExecutionResult? executionResult;
    
    private bool CanSaveTask => !string.IsNullOrWhiteSpace(taskName) && 
                                (syncScope != "company" || !string.IsNullOrEmpty(selectedCompanyId));
    
    protected override async Task OnInitializedAsync()
    {
        await LoadTasks();
        await LoadCompanies();
    }
    
    private async Task LoadTasks()
    {
        // TODO: ä»æ•°æ®åº“æˆ–é…ç½®åŠ è½½ä»»åŠ¡
        await Task.CompletedTask;
        
        // ç¤ºä¾‹æ•°æ®
        tasks = new List<ScheduledTask>
        {
            new ScheduledTask
            {
                Id = "1",
                Name = "æ¯æ—¥å‡Œæ™¨å…¨é‡åŒæ­¥",
                Description = "æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œå…¨é‡åŒæ­¥",
                SyncType = "full",
                ScheduleType = "daily",
                DailyTime = "02:00",
                Enabled = true,
                LastRunTime = DateTime.Now.AddHours(-20),
                NextRunTime = DateTime.Now.Date.AddDays(1).AddHours(2)
            },
            new ScheduledTask
            {
                Id = "2",
                Name = "æ¯å°æ—¶å¢é‡åŒæ­¥",
                Description = "æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡å¢é‡åŒæ­¥",
                SyncType = "incremental",
                ScheduleType = "interval",
                IntervalMinutes = 60,
                Enabled = true,
                LastRunTime = DateTime.Now.AddMinutes(-15),
                NextRunTime = DateTime.Now.AddMinutes(45)
            }
        };
    }
    
    private async Task LoadCompanies()
    {
        try
        {
            companies = await SyncService.GetCompaniesAsync();
        }
        catch
        {
            companies = new List<CompanyInfo>();
        }
    }
    
    private void OnSyncScopeChanged()
    {
        if (syncScope == "all")
        {
            selectedCompanyId = "";
        }
    }
    
    private void EditTask(ScheduledTask task)
    {
        editingTask = task;
        taskName = task.Name;
        taskDescription = task.Description;
        syncType = task.SyncType;
        syncScope = string.IsNullOrEmpty(task.CompanyId) ? "all" : "company";
        selectedCompanyId = task.CompanyId ?? "";
        scheduleType = task.ScheduleType;
        dailyTime = task.DailyTime ?? "02:00";
        dailyTimeStr = task.DailyTime ?? "02:00";
        intervalMinutes = task.IntervalMinutes;
        cronExpression = task.CronExpression ?? "";
        taskEnabled = task.Enabled;
    }
    
    private void CancelEdit()
    {
        editingTask = null;
        ResetForm();
    }
    
    private async Task SaveTask()
    {
        var task = editingTask ?? new ScheduledTask { Id = Guid.NewGuid().ToString() };
        
        task.Name = taskName;
        task.Description = taskDescription;
        task.SyncType = syncType;
        task.CompanyId = syncScope == "company" ? selectedCompanyId : null;
        task.ScheduleType = scheduleType;
        task.DailyTime = scheduleType == "daily" ? dailyTimeStr : null;
        task.IntervalMinutes = scheduleType == "interval" ? intervalMinutes : 0;
        task.CronExpression = scheduleType == "cron" ? cronExpression : null;
        task.Enabled = taskEnabled;
        
        // è®¡ç®—ä¸‹æ¬¡è¿è¡Œæ—¶é—´
        task.NextRunTime = CalculateNextRunTime(task);
        
        if (editingTask == null)
        {
            tasks.Add(task);
        }
        
        // TODO: ä¿å­˜åˆ°æ•°æ®åº“æˆ–é…ç½®
        await Task.CompletedTask;
        
        ResetForm();
        editingTask = null;
        StateHasChanged();
    }
    
    private DateTime? CalculateNextRunTime(ScheduledTask task)
    {
        var now = DateTime.Now;
        
        if (task.ScheduleType == "daily")
        {
            var time = TimeSpan.Parse(task.DailyTime ?? "02:00");
            var next = now.Date.Add(time);
            if (next <= now)
                next = next.AddDays(1);
            return next;
        }
        else if (task.ScheduleType == "interval")
        {
            return now.AddMinutes(task.IntervalMinutes);
        }
        else if (task.ScheduleType == "cron")
        {
            // TODO: è§£æCronè¡¨è¾¾å¼
            return now.AddHours(1);
        }
        
        return null;
    }
    
    private void ResetForm()
    {
        taskName = "";
        taskDescription = "";
        syncType = "full";
        syncScope = "all";
        selectedCompanyId = "";
        scheduleType = "daily";
        dailyTime = "02:00";
        dailyTimeStr = "02:00";
        intervalMinutes = 60;
        cronExpression = "";
        taskEnabled = true;
    }
    
    private async Task ToggleTask(string taskId)
    {
        var task = tasks.FirstOrDefault(t => t.Id == taskId);
        if (task != null)
        {
            task.Enabled = !task.Enabled;
            // TODO: ä¿å­˜åˆ°æ•°æ®åº“
            await Task.CompletedTask;
            StateHasChanged();
        }
    }
    
    private async Task DeleteTask(string taskId)
    {
        tasks.RemoveAll(t => t.Id == taskId);
        // TODO: ä»æ•°æ®åº“åˆ é™¤
        await Task.CompletedTask;
        StateHasChanged();
    }
    
    private async Task RunTaskNow(string taskId)
    {
        var task = tasks.FirstOrDefault(t => t.Id == taskId);
        if (task == null) return;
        
        isRunning = true;
        executionResult = null;
        StateHasChanged();
        
        try
        {
            SyncResult result;
            if (string.IsNullOrEmpty(task.CompanyId))
            {
                result = task.SyncType == "full" 
                    ? await SyncService.SyncAllAsync()
                    : await SyncService.SyncIncrementalAsync();
            }
            else
            {
                result = await SyncService.SyncByCompanyAsync(task.CompanyId, task.SyncType == "incremental");
            }
            
            task.LastRunTime = DateTime.Now;
            task.NextRunTime = CalculateNextRunTime(task);
            
            executionResult = new TaskExecutionResult
            {
                TaskName = task.Name,
                Success = result.Success,
                Message = result.Message,
                Details = new List<string>
                {
                    $"å¤„ç†ç”¨æˆ·: {result.UsersProcessed}",
                    $"å¤„ç†ç»„ç»‡: {result.OrganizationsProcessed}",
                    $"è€—æ—¶: {(result.EndTime - result.StartTime).TotalSeconds:F2}ç§’"
                }
            };
        }
        catch (Exception ex)
        {
            executionResult = new TaskExecutionResult
            {
                TaskName = task.Name,
                Success = false,
                Message = $"æ‰§è¡Œå¤±è´¥: {ex.Message}",
                Details = new List<string>()
            };
        }
        finally
        {
            isRunning = false;
            StateHasChanged();
        }
    }
    
    // DTO ç±»
    private class ScheduledTask
    {
        public string Id { get; set; } = "";
        public string Name { get; set; } = "";
        public string Description { get; set; } = "";
        public string SyncType { get; set; } = "full"; // full or incremental
        public string? CompanyId { get; set; }
        public string ScheduleType { get; set; } = "daily"; // daily, interval, cron
        public string? DailyTime { get; set; }
        public int IntervalMinutes { get; set; }
        public string? CronExpression { get; set; }
        public bool Enabled { get; set; }
        public DateTime? LastRunTime { get; set; }
        public DateTime? NextRunTime { get; set; }
    }
    
    private class TaskExecutionResult
    {
        public string TaskName { get; set; } = "";
        public bool Success { get; set; }
        public string Message { get; set; } = "";
        public List<string> Details { get; set; } = new();
    }
}
