@page "/settings"
@using Microsoft.AspNetCore.Components.Authorization
@inject IHttpClientFactory HttpFactory

<PageTitle>ç³»ç»Ÿé…ç½®</PageTitle>

<h1>âš™ï¸ ç³»ç»Ÿé…ç½®</h1>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">ğŸ“Š EKP æ•°æ®åº“é…ç½®</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">æœåŠ¡å™¨åœ°å€</label>
                    <input type="text" class="form-control" @bind="ekpServer" placeholder="npm.fzcsps.com:11433">
                </div>
                <div class="mb-3">
                    <label class="form-label">æ•°æ®åº“å</label>
                    <input type="text" class="form-control" @bind="ekpDatabase" placeholder="ecology">
                </div>
                <div class="mb-3">
                    <label class="form-label">ç”¨æˆ·å</label>
                    <input type="text" class="form-control" @bind="ekpUsername" placeholder="ecology">
                </div>
                <div class="mb-3">
                    <label class="form-label">å¯†ç </label>
                    <input type="password" class="form-control" @bind="ekpPassword">
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" @bind="ekpTrustCertificate" id="ekpTrust">
                    <label class="form-check-label" for="ekpTrust">
                        ä¿¡ä»»æœåŠ¡å™¨è¯ä¹¦
                    </label>
                </div>
                <button class="btn btn-primary" @onclick="SaveEkpConfig" disabled="@isSaving">
                    @if (isSaving)
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                    }
                    ğŸ’¾ ä¿å­˜ EKP é…ç½®
                </button>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">ğŸ” Casdoor API é…ç½®</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">API ç«¯ç‚¹</label>
                    <input type="text" class="form-control" @bind="casdoorEndpoint" placeholder="http://172.16.10.110:8000">
                </div>
                <div class="mb-3">
                    <label class="form-label">ç»„ç»‡ (Owner)</label>
                    <input type="text" class="form-control" @bind="casdoorOwner" placeholder="fzswjtOrganization">
                </div>
                <div class="mb-3">
                    <label class="form-label">Client ID</label>
                    <input type="text" class="form-control" @bind="casdoorClientId">
                </div>
                <div class="mb-3">
                    <label class="form-label">Client Secret</label>
                    <input type="password" class="form-control" @bind="casdoorClientSecret">
                </div>
                <div class="mb-3">
                    <label class="form-label">åº”ç”¨åç§°</label>
                    <input type="text" class="form-control" @bind="casdoorApplicationName" placeholder="ekp-sync-app">
                </div>
                <button class="btn btn-success" @onclick="SaveCasdoorConfig" disabled="@isSaving">
                    @if (isSaving)
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                    }
                    ğŸ’¾ ä¿å­˜ Casdoor é…ç½®
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-warning">
                <h5 class="mb-0">âš¡ åŒæ­¥é…ç½®</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">æ‰¹å¤„ç†å¤§å°</label>
                    <input type="number" class="form-control" @bind="batchSize" min="1" max="1000">
                    <small class="form-text text-muted">æ¯æ‰¹æ¬¡å¤„ç†çš„ç”¨æˆ·/ç»„ç»‡æ•°é‡</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">é‡è¯•æ¬¡æ•°</label>
                    <input type="number" class="form-control" @bind="retryCount" min="0" max="10">
                    <small class="form-text text-muted">å¤±è´¥æ—¶çš„é‡è¯•æ¬¡æ•°</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">è¶…æ—¶æ—¶é—´ (ç§’)</label>
                    <input type="number" class="form-control" @bind="timeoutSeconds" min="10" max="600">
                    <small class="form-text text-muted">å•æ¬¡APIè°ƒç”¨è¶…æ—¶æ—¶é—´</small>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" @bind="enableProgressLog" id="progressLog">
                    <label class="form-check-label" for="progressLog">
                        å¯ç”¨è¯¦ç»†è¿›åº¦æ—¥å¿—
                    </label>
                </div>
                <button class="btn btn-warning" @onclick="SaveSyncConfig" disabled="@isSaving">
                    @if (isSaving)
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                    }
                    ğŸ’¾ ä¿å­˜åŒæ­¥é…ç½®
                </button>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">â„¹ï¸ ç³»ç»Ÿä¿¡æ¯</h5>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-6">é…ç½®æ–‡ä»¶è·¯å¾„:</dt>
                    <dd class="col-sm-6"><code>appsettings.json</code></dd>
                    
                    <dt class="col-sm-6">æ—¥å¿—çº§åˆ«:</dt>
                    <dd class="col-sm-6">@logLevel</dd>
                    
                    <dt class="col-sm-6">åº”ç”¨ç‰ˆæœ¬:</dt>
                    <dd class="col-sm-6">@appVersion</dd>
                    
                    <dt class="col-sm-6">è¿è¡Œç¯å¢ƒ:</dt>
                    <dd class="col-sm-6">@environment</dd>
                </dl>
                <hr>
                <div class="alert alert-info mb-3">
                    <small>
                        <strong>æç¤º:</strong> ä¿®æ”¹é…ç½®åéœ€è¦é‡å¯åº”ç”¨æ‰èƒ½ç”Ÿæ•ˆã€‚
                        å»ºè®®åœ¨éç”Ÿäº§ç¯å¢ƒå…ˆæµ‹è¯•é…ç½®çš„æœ‰æ•ˆæ€§ã€‚
                    </small>
                </div>
                <AuthorizeView>
                    <Authorized>
                        <button class="btn btn-danger w-100" @onclick="RestartApplication" disabled="@isRestarting">
                            @if (isRestarting)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            else
                            {
                                <i class="bi bi-arrow-repeat"></i>
                            }
                            é‡å¯åº”ç”¨ (ç‰¹æƒ)
                        </button>
                    </Authorized>
                    <NotAuthorized>
                        <a href="/admin-login" class="btn btn-secondary w-100">
                            <i class="bi bi-lock"></i> ç™»å½•åå¯é‡å¯åº”ç”¨
                        </a>
                    </NotAuthorized>
                </AuthorizeView>
            </div>
        </div>
    </div>
</div>

@if (!string.IsNullOrEmpty(saveMessage))
{
    <div class="row mt-4">
        <div class="col-12">
            <div class="alert @(saveSuccess ? "alert-success" : "alert-danger") alert-dismissible fade show">
                @saveMessage
                <button type="button" class="btn-close" @onclick="ClearMessage"></button>
            </div>
        </div>
    </div>
}

@code {
    // EKP é…ç½®
    private string ekpServer = "npm.fzcsps.com:11433";
    private string ekpDatabase = "ecology";
    private string ekpUsername = "ecology";
    private string ekpPassword = "";
    private bool ekpTrustCertificate = true;
    
    // Casdoor é…ç½®
    private string casdoorEndpoint = "http://172.16.10.110:8000";
    private string casdoorOwner = "fzswjtOrganization";
    private string casdoorClientId = "";
    private string casdoorClientSecret = "";
    private string casdoorApplicationName = "ekp-sync-app";
    
    // åŒæ­¥é…ç½®
    private int batchSize = 100;
    private int retryCount = 3;
    private int timeoutSeconds = 30;
    private bool enableProgressLog = true;
    
    // ç³»ç»Ÿä¿¡æ¯
    private string logLevel = "Information";
    private string appVersion = "2.0.0";
    private string environment = "Development";
    
    // UI çŠ¶æ€
    private bool isSaving = false;
    private string saveMessage = "";
    private bool saveSuccess = false;
    
    protected override async Task OnInitializedAsync()
    {
        await LoadCurrentConfig();
    }
    
    private async Task LoadCurrentConfig()
    {
        try
        {
            var client = HttpFactory.CreateClient("WithCookies");
            var response = await client.GetFromJsonAsync<ApiResponse>("/api/config/system");
            if (response?.Success == true && response.Data != null)
            {
                ekpServer = ParseConnectionString(response.Data.EkpConnection, "Server");
                ekpDatabase = ParseConnectionString(response.Data.EkpConnection, "Database");
                ekpUsername = ParseConnectionString(response.Data.EkpConnection, "User Id");
                ekpPassword = ParseConnectionString(response.Data.EkpConnection, "Password");
                ekpTrustCertificate = ParseConnectionString(response.Data.EkpConnection, "TrustServerCertificate") == "True";
                
                casdoorEndpoint = response.Data.CasdoorEndpoint;
                casdoorOwner = response.Data.CasdoorOwner;
                casdoorClientId = response.Data.CasdoorClientId;
                casdoorApplicationName = response.Data.CasdoorApplicationName;
            }
        }
        catch (Exception ex)
        {
            saveMessage = $"åŠ è½½é…ç½®å¤±è´¥: {ex.Message}";
            saveSuccess = false;
        }
    }
    
    private string ParseConnectionString(string connStr, string key)
    {
        if (string.IsNullOrEmpty(connStr)) return "";
        var parts = connStr.Split(';');
        var part = parts.FirstOrDefault(p => p.Trim().StartsWith(key, StringComparison.OrdinalIgnoreCase));
        if (part == null) return "";
        var idx = part.IndexOf('=');
        return idx > 0 ? part.Substring(idx + 1).Trim() : "";
    }
    
    private async Task SaveEkpConfig()
    {
        isSaving = true;
        saveMessage = "";
        try
        {
            var connStr = $"Server={ekpServer};Database={ekpDatabase};User Id={ekpUsername};Password={ekpPassword};TrustServerCertificate={ekpTrustCertificate};Encrypt=False;";
            
            var request = new
            {
                EkpConnection = connStr,
                CasdoorEndpoint = casdoorEndpoint,
                CasdoorOwner = casdoorOwner,
                CasdoorClientId = casdoorClientId,
                CasdoorClientSecret = casdoorClientSecret,
                TargetCompanyIds = "",
                ScheduledSyncEnabled = false,
                ScheduledSyncInterval = 3600
            };
            
            var client = HttpFactory.CreateClient("WithCookies");
            var response = await client.PostAsJsonAsync("/api/config/system", request);
            var result = await response.Content.ReadFromJsonAsync<ApiMessageResponse>();
            
            if (response.IsSuccessStatusCode && result?.Success == true)
            {
                saveMessage = result.Message;
                saveSuccess = true;
            }
            else
            {
                saveMessage = result?.Message ?? "ä¿å­˜å¤±è´¥";
                saveSuccess = false;
            }
        }
        catch (Exception ex)
        {
            saveMessage = $"âœ— ä¿å­˜å¤±è´¥: {ex.Message}";
            saveSuccess = false;
        }
        finally
        {
            isSaving = false;
        }
    }
    
    private async Task SaveCasdoorConfig()
    {
        isSaving = true;
        saveMessage = "";
        try
        {
            var connStr = $"Server={ekpServer};Database={ekpDatabase};User Id={ekpUsername};Password={ekpPassword};TrustServerCertificate={ekpTrustCertificate};Encrypt=False;";
            
            var request = new
            {
                EkpConnection = connStr,
                CasdoorEndpoint = casdoorEndpoint,
                CasdoorOwner = casdoorOwner,
                CasdoorClientId = casdoorClientId,
                CasdoorClientSecret = casdoorClientSecret,
                TargetCompanyIds = "",
                ScheduledSyncEnabled = false,
                ScheduledSyncInterval = 3600
            };
            
            var client = HttpFactory.CreateClient("WithCookies");
            var response = await client.PostAsJsonAsync("/api/config/system", request);
            var result = await response.Content.ReadFromJsonAsync<ApiMessageResponse>();
            
            if (response.IsSuccessStatusCode && result?.Success == true)
            {
                saveMessage = result.Message;
                saveSuccess = true;
            }
            else
            {
                saveMessage = result?.Message ?? "ä¿å­˜å¤±è´¥";
                saveSuccess = false;
            }
        }
        catch (Exception ex)
        {
            saveMessage = $"âœ— ä¿å­˜å¤±è´¥: {ex.Message}";
            saveSuccess = false;
        }
        finally
        {
            isSaving = false;
        }
    }
    
    private async Task SaveSyncConfig()
    {
        isSaving = true;
        saveMessage = "";
        try
        {
            saveMessage = "âœ“ åŒæ­¥é…ç½®å·²ä¿å­˜æˆåŠŸï¼(æ­¤é…ç½®æš‚ä¸æ”¯æŒä¿®æ”¹)";
            saveSuccess = true;
        }
        catch (Exception ex)
        {
            saveMessage = $"âœ— ä¿å­˜å¤±è´¥: {ex.Message}";
            saveSuccess = false;
        }
        finally
        {
            isSaving = false;
        }
    }
    
    private void ClearMessage()
    {
        saveMessage = "";
    }

    private bool isRestarting = false;

    private async Task RestartApplication()
    {
        if (!await ConfirmRestart())
            return;

        isRestarting = true;
        saveMessage = "";

        try
        {
            var client = HttpFactory.CreateClient("WithCookies");
            var response = await client.PostAsync("/api/config/restart", null);
            var result = await response.Content.ReadFromJsonAsync<ApiMessageResponse>();

            if (response.IsSuccessStatusCode && result?.Success == true)
            {
                saveMessage = result.Message;
                saveSuccess = true;
            }
            else
            {
                saveMessage = result?.Message ?? "é‡å¯è¯·æ±‚å¤±è´¥";
                saveSuccess = false;
                isRestarting = false;
            }
        }
        catch (Exception ex)
        {
            saveMessage = $"é‡å¯å¤±è´¥: {ex.Message}";
            saveSuccess = false;
            isRestarting = false;
        }
    }

    private async Task<bool> ConfirmRestart()
    {
        // ç®€å•ç¡®è®¤ï¼Œå®é™…åº”ç”¨ä¸­å¯ä»¥ç”¨æ›´å¥½çš„UIç»„ä»¶
        return await Task.FromResult(true); // é»˜è®¤ç¡®è®¤ï¼Œå¯ä»¥æ”¹ä¸ºJS confirm
    }
    
    private class ApiResponse
    {
        public bool Success { get; set; }
        public ConfigData? Data { get; set; }
    }
    
    private class ConfigData
    {
        public string EkpConnection { get; set; } = "";
        public string CasdoorEndpoint { get; set; } = "";
        public string CasdoorOwner { get; set; } = "";
        public string CasdoorClientId { get; set; } = "";
        public string CasdoorApplicationName { get; set; } = "";
    }
    
    private class ApiMessageResponse
    {
        public bool Success { get; set; }
        public string Message { get; set; } = "";
    }
}
