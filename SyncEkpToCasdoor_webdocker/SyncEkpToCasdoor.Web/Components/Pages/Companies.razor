@page "/companies"
@using SyncEkpToCasdoor.Web.Services
@inject ISyncService SyncService
@rendermode InteractiveServer

<PageTitle>å…¬å¸åŒæ­¥</PageTitle>

<h1>ğŸ¢ æŒ‰å…¬å¸åŒæ­¥</h1>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">é€‰æ‹©å…¬å¸è¿›è¡ŒåŒæ­¥</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="æœç´¢å…¬å¸åç§°..." @bind="searchText" @bind:event="oninput">
                            <button class="btn btn-outline-secondary" @onclick="LoadCompanies">
                                ğŸ” æœç´¢
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-info" @onclick="LoadCompanies" disabled="@isLoading">
                            @if (isLoading)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            ğŸ”„ åˆ·æ–°å…¬å¸åˆ—è¡¨
                        </button>
                    </div>
                </div>
                
                @if (isLoading)
                {
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">åŠ è½½ä¸­...</span>
                        </div>
                        <p class="mt-2 text-muted">æ­£åœ¨åŠ è½½å…¬å¸åˆ—è¡¨...</p>
                    </div>
                }
                else if (companies.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>å…¬å¸åç§°</th>
                                    <th class="text-center">ç”¨æˆ·æ•°</th>
                                    <th class="text-center">éƒ¨é—¨æ•°</th>
                                    <th class="text-center">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var company in FilteredCompanies)
                                {
                                    <tr>
                                        <td>
                                            <strong>@company.Name</strong>
                                            <br />
                                            <small class="text-muted">ID: @company.Id</small>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-primary">@company.UserCount</span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-secondary">@company.DeptCount</span>
                                        </td>
                                        <td class="text-center">
                                            <button class="btn btn-sm btn-success me-2" 
                                                    @onclick="() => SyncCompany(company.Id, false)"
                                                    disabled="@(isSyncing || currentSyncCompanyId == company.Id)">
                                                @if (currentSyncCompanyId == company.Id)
                                                {
                                                    <span class="spinner-border spinner-border-sm me-1"></span>
                                                }
                                                â–¶ï¸ å…¨é‡åŒæ­¥
                                            </button>
                                            <button class="btn btn-sm btn-warning" 
                                                    @onclick="() => SyncCompany(company.Id, true)"
                                                    disabled="@(isSyncing || currentSyncCompanyId == company.Id)">
                                                â© å¢é‡åŒæ­¥
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-3 text-muted">
                        <small>
                            æ˜¾ç¤º @FilteredCompanies.Count() / @companies.Count ä¸ªå…¬å¸
                        </small>
                    </div>
                }
                else
                {
                    <div class="alert alert-info">
                        <strong>â„¹ï¸</strong> æœªæ‰¾åˆ°å…¬å¸æ•°æ®ã€‚è¯·ç‚¹å‡»"åˆ·æ–°å…¬å¸åˆ—è¡¨"åŠ è½½æ•°æ®ã€‚
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@if (syncResult != null)
{
    <div class="row mt-4">
        <div class="col-12">
            <div class="alert @(syncResult.Success ? "alert-success" : "alert-danger") alert-dismissible fade show">
                <h5 class="alert-heading">
                    @(syncResult.Success ? "âœ“" : "âœ—") @syncResult.Message
                </h5>
                <hr>
                <dl class="row mb-0">
                    <dt class="col-sm-3">å…¬å¸:</dt>
                    <dd class="col-sm-9">@currentCompanyName</dd>
                    
                    <dt class="col-sm-3">å¼€å§‹æ—¶é—´:</dt>
                    <dd class="col-sm-9">@syncResult.StartTime.ToString("yyyy-MM-dd HH:mm:ss")</dd>
                    
                    <dt class="col-sm-3">ç»“æŸæ—¶é—´:</dt>
                    <dd class="col-sm-9">@syncResult.EndTime.ToString("yyyy-MM-dd HH:mm:ss")</dd>
                    
                    <dt class="col-sm-3">è€—æ—¶:</dt>
                    <dd class="col-sm-9">@((syncResult.EndTime - syncResult.StartTime).TotalSeconds.ToString("F2")) ç§’</dd>
                    
                    @if (syncResult.UsersProcessed > 0)
                    {
                        <dt class="col-sm-3">å¤„ç†ç”¨æˆ·:</dt>
                        <dd class="col-sm-9">@syncResult.UsersProcessed</dd>
                    }
                    
                    @if (syncResult.OrganizationsProcessed > 0)
                    {
                        <dt class="col-sm-3">å¤„ç†ç»„ç»‡:</dt>
                        <dd class="col-sm-9">@syncResult.OrganizationsProcessed</dd>
                    }
                </dl>
                
                @if (syncResult.Errors.Any())
                {
                    <hr>
                    <h6>é”™è¯¯è¯¦æƒ…:</h6>
                    <pre class="mb-0" style="max-height: 200px; overflow-y: auto;">@string.Join("\n", syncResult.Errors)</pre>
                }
                
                <button type="button" class="btn-close" @onclick="ClearSyncResult"></button>
            </div>
        </div>
    </div>
}

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">ğŸ“Š åŒæ­¥ç»Ÿè®¡</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h3 class="mb-0">@companies.Count</h3>
                                <small class="text-muted">æ€»å…¬å¸æ•°</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h3 class="mb-0">@companies.Sum(c => c.UserCount)</h3>
                                <small class="text-muted">æ€»ç”¨æˆ·æ•°</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h3 class="mb-0">@companies.Sum(c => c.DeptCount)</h3>
                                <small class="text-muted">æ€»éƒ¨é—¨æ•°</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h3 class="mb-0">@syncedCompaniesCount</h3>
                                <small class="text-muted">å·²åŒæ­¥å…¬å¸</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private List<CompanyInfo> companies = new();
    private string searchText = "";
    private bool isLoading = false;
    private bool isSyncing = false;
    private string currentSyncCompanyId = "";
    private string currentCompanyName = "";
    private SyncResult? syncResult;
    private int syncedCompaniesCount = 0;
    
    private IEnumerable<CompanyInfo> FilteredCompanies
    {
        get
        {
            if (string.IsNullOrWhiteSpace(searchText))
                return companies;
            
            return companies.Where(c => 
                c.Name.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                c.Id.Contains(searchText, StringComparison.OrdinalIgnoreCase));
        }
    }
    
    protected override async Task OnInitializedAsync()
    {
        await LoadCompanies();
    }
    
    private async Task LoadCompanies()
    {
        isLoading = true;
        StateHasChanged();
        
        try
        {
            companies = await SyncService.GetCompaniesAsync();
        }
        catch (Exception ex)
        {
            // TODO: æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
            Console.WriteLine($"åŠ è½½å…¬å¸åˆ—è¡¨å¤±è´¥: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private async Task SyncCompany(string companyId, bool incremental)
    {
        if (isSyncing) return;
        
        isSyncing = true;
        currentSyncCompanyId = companyId;
        var company = companies.FirstOrDefault(c => c.Id == companyId);
        currentCompanyName = company?.Name ?? companyId;
        syncResult = null;
        StateHasChanged();
        
        try
        {
            syncResult = await SyncService.SyncByCompanyAsync(companyId, incremental);
            if (syncResult.Success)
            {
                syncedCompaniesCount++;
            }
        }
        catch (Exception ex)
        {
            syncResult = new SyncResult
            {
                Success = false,
                Message = $"åŒæ­¥å¤±è´¥: {ex.Message}",
                StartTime = DateTime.Now,
                EndTime = DateTime.Now
            };
        }
        finally
        {
            isSyncing = false;
            currentSyncCompanyId = "";
            StateHasChanged();
        }
    }
    
    private void ClearSyncResult()
    {
        syncResult = null;
    }
}
