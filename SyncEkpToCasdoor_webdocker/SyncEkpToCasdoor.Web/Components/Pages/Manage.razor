@page "/manage"
@using SyncEkpToCasdoor.Web.Services
@inject ISyncService SyncService
@rendermode InteractiveServer

<PageTitle>æ•°æ®ç®¡ç†</PageTitle>

<h1>ğŸ—‚ï¸ Casdoor æ•°æ®ç®¡ç†</h1>

<div class="alert alert-warning mt-4">
    <strong>âš ï¸ è­¦å‘Š:</strong> æ­¤é¡µé¢çš„æ“ä½œå…·æœ‰ç ´åæ€§ï¼Œæ— æ³•æ’¤é”€ï¼è¯·è°¨æ…æ“ä½œã€‚
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">ğŸ—‘ï¸ æ¸…ç©º Casdoor æ•°æ®</h5>
            </div>
            <div class="card-body">
                <p class="card-text">
                    æ­¤æ“ä½œå°†åˆ é™¤æŒ‡å®šç»„ç»‡ä¸‹çš„<strong>æ‰€æœ‰ç”¨æˆ·å’Œç»„ç»‡</strong>æ•°æ®ã€‚
                </p>
                
                <div class="mb-3">
                    <label class="form-label">ç›®æ ‡ç»„ç»‡ (Owner)</label>
                    <input type="text" class="form-control" @bind="targetOwner" placeholder="fzswjtOrganization">
                    <small class="form-text text-muted">
                        ä»…åˆ é™¤æ­¤ç»„ç»‡ä¸‹çš„æ•°æ®ï¼Œå…¶ä»–ç»„ç»‡ä¸å—å½±å“
                    </small>
                </div>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" @bind="confirmPurge" id="confirmPurge">
                    <label class="form-check-label" for="confirmPurge">
                        æˆ‘ç¡®è®¤è¦æ¸…ç©º <strong>@targetOwner</strong> ç»„ç»‡çš„æ‰€æœ‰æ•°æ®
                    </label>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">è¾“å…¥ <code>DELETE-ALL</code> ç¡®è®¤</label>
                    <input type="text" class="form-control" @bind="confirmText" placeholder="DELETE-ALL">
                </div>
                
                <button class="btn btn-danger" @onclick="PurgeAllData" disabled="@(!CanPurge || isPurging)">
                    @if (isPurging)
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                        <text>æ­£åœ¨æ¸…ç©º</text>
                    }
                    else
                    {
                        <text>ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ®</text>
                    }
                </button>
                
                @if (purgeResult != null)
                {
                    <div class="alert @(purgeResult.Success ? "alert-success" : "alert-danger") mt-3 mb-0">
                        <strong>@(purgeResult.Success ? "âœ“" : "âœ—")</strong> @purgeResult.Message
                        @if (purgeResult.DeletedCount > 0)
                        {
                            <br />
                            <small>å·²åˆ é™¤ @purgeResult.DeletedCount ä¸ªå¯¹è±¡</small>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card border-warning">
            <div class="card-header bg-warning">
                <h5 class="mb-0">ğŸ§¹ æ¸…ç†å­¤ç«‹æ•°æ®</h5>
            </div>
            <div class="card-body">
                <p class="card-text">
                    æ¸…ç†åœ¨ Casdoor ä¸­å­˜åœ¨ä½†åœ¨ EKP ä¸­ä¸å­˜åœ¨çš„<strong>å­¤ç«‹æ•°æ®</strong>ã€‚
                </p>
                
                <div class="mb-3">
                    <label class="form-label">æ¸…ç†èŒƒå›´</label>
                    <select class="form-select" @bind="cleanupScope">
                        <option value="users">ä»…ç”¨æˆ·</option>
                        <option value="groups">ä»…ç»„ç»‡</option>
                        <option value="both">ç”¨æˆ·å’Œç»„ç»‡</option>
                    </select>
                </div>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" @bind="dryRun" id="dryRun">
                    <label class="form-check-label" for="dryRun">
                        ä»…é¢„è§ˆï¼ˆä¸å®é™…åˆ é™¤ï¼‰
                    </label>
                </div>
                
                <button class="btn btn-warning" @onclick="CleanOrphanData" disabled="@isCleaning">
                    @if (isCleaning)
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                        <text>æ­£åœ¨æ¸…ç†</text>
                    }
                    else
                    {
                        <text>ğŸ§¹ @(dryRun ? "é¢„è§ˆæ¸…ç†" : "å¼€å§‹æ¸…ç†")</text>
                    }
                </button>
                
                @if (cleanupResult != null)
                {
                    <div class="alert alert-info mt-3 mb-0">
                        <h6>æ¸…ç†ç»“æœ:</h6>
                        <ul class="mb-0">
                            <li>æ‰¾åˆ° <strong>@cleanupResult.OrphanUsersCount</strong> ä¸ªå­¤ç«‹ç”¨æˆ·</li>
                            <li>æ‰¾åˆ° <strong>@cleanupResult.OrphanGroupsCount</strong> ä¸ªå­¤ç«‹ç»„ç»‡</li>
                            @if (!dryRun)
                            {
                                <li>å·²åˆ é™¤ <strong>@cleanupResult.DeletedCount</strong> ä¸ªå¯¹è±¡</li>
                            }
                        </ul>
                        @if (dryRun && cleanupResult.DeletedCount == 0)
                        {
                            <hr />
                            <small class="text-muted">
                                è¿™æ˜¯é¢„è§ˆæ¨¡å¼ï¼Œæ²¡æœ‰åˆ é™¤ä»»ä½•æ•°æ®ã€‚å–æ¶ˆå‹¾é€‰"ä»…é¢„è§ˆ"åå¯æ‰§è¡Œå®é™…åˆ é™¤ã€‚
                            </small>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">ğŸ“‹ æ•°æ®ç»Ÿè®¡</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-info mb-3" @onclick="RefreshStats" disabled="@isLoadingStats">
                    @if (isLoadingStats)
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                    }
                    ğŸ”„ åˆ·æ–°ç»Ÿè®¡
                </button>
                
                @if (stats != null)
                {
                    <div class="row">
                        <div class="col-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h2 class="mb-0">@stats.CasdoorUsersCount</h2>
                                    <small class="text-muted">Casdoor ç”¨æˆ·</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h2 class="mb-0">@stats.CasdoorGroupsCount</h2>
                                    <small class="text-muted">Casdoor ç»„ç»‡</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h2 class="mb-0">@stats.EkpUsersCount</h2>
                                    <small class="text-muted">EKP ç”¨æˆ·</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h2 class="mb-0">@stats.EkpOrgsCount</h2>
                                    <small class="text-muted">EKP ç»„ç»‡</small>
                                </div>
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <p class="text-muted">ç‚¹å‡»åˆ·æ–°æŒ‰é’®åŠ è½½ç»Ÿè®¡æ•°æ®</p>
                }
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">ğŸ“¦ æ‰¹é‡æ“ä½œ</h5>
            </div>
            <div class="card-body">
                <h6>å¯¼å‡ºæ•°æ®</h6>
                <div class="d-grid gap-2 mb-3">
                    <button class="btn btn-outline-secondary" @onclick="ExportUsers">
                        ğŸ“„ å¯¼å‡ºç”¨æˆ·åˆ—è¡¨ (CSV)
                    </button>
                    <button class="btn btn-outline-secondary" @onclick="ExportOrganizations">
                        ğŸ“„ å¯¼å‡ºç»„ç»‡æ¶æ„ (CSV)
                    </button>
                    <button class="btn btn-outline-secondary" @onclick="ExportMemberships">
                        ğŸ“„ å¯¼å‡ºæˆå‘˜å…³ç³» (CSV)
                    </button>
                </div>
                
                @if (!string.IsNullOrEmpty(exportMessage))
                {
                    <div class="alert alert-success">
                        @exportMessage
                    </div>
                }
                
                <hr>
                
                <h6>æ•°æ®éªŒè¯</h6>
                <button class="btn btn-outline-primary" @onclick="ValidateData" disabled="@isValidating">
                    @if (isValidating)
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                    }
                    âœ“ éªŒè¯æ•°æ®å®Œæ•´æ€§
                </button>
                
                @if (validationResult != null)
                {
                    <div class="alert @(validationResult.IsValid ? "alert-success" : "alert-warning") mt-3 mb-0">
                        <strong>@(validationResult.IsValid ? "âœ“" : "âš ")</strong> @validationResult.Message
                        @if (validationResult.Issues.Any())
                        {
                            <hr />
                            <ul class="mb-0 small">
                                @foreach (var issue in validationResult.Issues)
                                {
                                    <li>@issue</li>
                                }
                            </ul>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@code {
    // æ¸…ç©ºæ“ä½œ
    private string targetOwner = "fzswjtOrganization";
    private bool confirmPurge = false;
    private string confirmText = "";
    private bool isPurging = false;
    private PurgeResult? purgeResult;
    
    // æ¸…ç†æ“ä½œ
    private string cleanupScope = "both";
    private bool dryRun = true;
    private bool isCleaning = false;
    private CleanupResult? cleanupResult;
    
    // ç»Ÿè®¡æ•°æ®
    private DataStats? stats;
    private bool isLoadingStats = false;
    
    // å¯¼å‡º
    private string exportMessage = "";
    
    // éªŒè¯
    private bool isValidating = false;
    private ValidationResult? validationResult;
    
    private bool CanPurge => confirmPurge && confirmText == "DELETE-ALL" && !string.IsNullOrWhiteSpace(targetOwner);
    
    private async Task PurgeAllData()
    {
        if (!CanPurge) return;
        
        isPurging = true;
        purgeResult = null;
        StateHasChanged();
        
        try
        {
            var deletedCount = await SyncService.CleanOrphanDataAsync(targetOwner);
            purgeResult = new PurgeResult
            {
                Success = true,
                Message = "æ•°æ®æ¸…ç©ºå®Œæˆ",
                DeletedCount = deletedCount
            };
            
            // é‡ç½®ç¡®è®¤çŠ¶æ€
            confirmPurge = false;
            confirmText = "";
            
            // åˆ·æ–°ç»Ÿè®¡
            await RefreshStats();
        }
        catch (Exception ex)
        {
            purgeResult = new PurgeResult
            {
                Success = false,
                Message = $"æ¸…ç©ºå¤±è´¥: {ex.Message}",
                DeletedCount = 0
            };
        }
        finally
        {
            isPurging = false;
            StateHasChanged();
        }
    }
    
    private async Task CleanOrphanData()
    {
        isCleaning = true;
        cleanupResult = null;
        StateHasChanged();
        
        try
        {
            // TODO: å®ç°å®é™…çš„å­¤ç«‹æ•°æ®æ¸…ç†
            await Task.Delay(1000); // æ¨¡æ‹Ÿæ¸…ç†è¿‡ç¨‹
            
            cleanupResult = new CleanupResult
            {
                OrphanUsersCount = 15,
                OrphanGroupsCount = 3,
                DeletedCount = dryRun ? 0 : 18
            };
        }
        finally
        {
            isCleaning = false;
            StateHasChanged();
        }
    }
    
    private async Task RefreshStats()
    {
        isLoadingStats = true;
        StateHasChanged();
        
        try
        {
            var testResult = await SyncService.TestConnectionsAsync();
            stats = new DataStats
            {
                CasdoorUsersCount = testResult.CasdoorUsersCount,
                CasdoorGroupsCount = testResult.CasdoorGroupsCount,
                EkpUsersCount = testResult.EkpUsersCount,
                EkpOrgsCount = testResult.EkpOrgsCount
            };
        }
        finally
        {
            isLoadingStats = false;
            StateHasChanged();
        }
    }
    
    private async Task ExportUsers()
    {
        exportMessage = "æ­£åœ¨å¯¼å‡ºç”¨æˆ·åˆ—è¡¨...";
        StateHasChanged();
        
        try
        {
            // TODO: å®ç°å®é™…çš„å¯¼å‡ºåŠŸèƒ½
            await Task.Delay(500);
            exportMessage = "âœ“ ç”¨æˆ·åˆ—è¡¨å·²å¯¼å‡ºåˆ°: exports/users.csv";
        }
        catch (Exception ex)
        {
            exportMessage = $"âœ— å¯¼å‡ºå¤±è´¥: {ex.Message}";
        }
        
        StateHasChanged();
    }
    
    private async Task ExportOrganizations()
    {
        exportMessage = "æ­£åœ¨å¯¼å‡ºç»„ç»‡æ¶æ„...";
        StateHasChanged();
        
        try
        {
            var filePath = await SyncService.ExportOrganizationHierarchyAsync();
            exportMessage = $"âœ“ ç»„ç»‡æ¶æ„å·²å¯¼å‡ºåˆ°: {filePath}";
        }
        catch (Exception ex)
        {
            exportMessage = $"âœ— å¯¼å‡ºå¤±è´¥: {ex.Message}";
        }
        
        StateHasChanged();
    }
    
    private async Task ExportMemberships()
    {
        exportMessage = "æ­£åœ¨å¯¼å‡ºæˆå‘˜å…³ç³»...";
        StateHasChanged();
        
        try
        {
            await Task.Delay(500);
            exportMessage = "âœ“ æˆå‘˜å…³ç³»å·²å¯¼å‡ºåˆ°: exports/memberships.csv";
        }
        catch (Exception ex)
        {
            exportMessage = $"âœ— å¯¼å‡ºå¤±è´¥: {ex.Message}";
        }
        
        StateHasChanged();
    }
    
    private async Task ValidateData()
    {
        isValidating = true;
        validationResult = null;
        StateHasChanged();
        
        try
        {
            await Task.Delay(1000);
            
            var issues = new List<string>();
            // TODO: å®ç°å®é™…çš„éªŒè¯é€»è¾‘
            
            validationResult = new ValidationResult
            {
                IsValid = issues.Count == 0,
                Message = issues.Count == 0 ? "æ•°æ®éªŒè¯é€šè¿‡ï¼Œæœªå‘ç°é—®é¢˜" : $"å‘ç° {issues.Count} ä¸ªé—®é¢˜",
                Issues = issues
            };
        }
        finally
        {
            isValidating = false;
            StateHasChanged();
        }
    }
    
    // DTO ç±»
    private class PurgeResult
    {
        public bool Success { get; set; }
        public string Message { get; set; } = "";
        public int DeletedCount { get; set; }
    }
    
    private class CleanupResult
    {
        public int OrphanUsersCount { get; set; }
        public int OrphanGroupsCount { get; set; }
        public int DeletedCount { get; set; }
    }
    
    private class DataStats
    {
        public int CasdoorUsersCount { get; set; }
        public int CasdoorGroupsCount { get; set; }
        public int EkpUsersCount { get; set; }
        public int EkpOrgsCount { get; set; }
    }
    
    private class ValidationResult
    {
        public bool IsValid { get; set; }
        public string Message { get; set; } = "";
        public List<string> Issues { get; set; } = new();
    }
}
