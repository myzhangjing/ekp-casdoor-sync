@page "/sync"
@using SyncEkpToCasdoor.Web.Services
@inject ISyncService SyncService
@rendermode InteractiveServer

<PageTitle>åŒæ­¥ç®¡ç†</PageTitle>

<h1>EKP åˆ° Casdoor åŒæ­¥ç®¡ç†</h1>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>åŒæ­¥æ“ä½œ</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-success" @onclick="TestConnections" disabled="@isRunning">
                        @if (isRunning && syncType == "test")
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        ğŸ”Œ æµ‹è¯•è¿æ¥
                    </button>
                    <button class="btn btn-warning" @onclick="PreviewSync" disabled="@isRunning">
                        @if (isRunning && syncType == "preview")
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        ğŸ‘ï¸ é¢„è§ˆåŒæ­¥
                    </button>
                    <hr>
                    <button class="btn btn-primary" @onclick="PerformFullSync" disabled="@isRunning">
                        @if (isRunning && syncType == "full")
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        â–¶ï¸ å…¨é‡åŒæ­¥
                    </button>
                    <button class="btn btn-secondary" @onclick="PerformIncrementalSync" disabled="@isRunning">
                        @if (isRunning && syncType == "incremental")
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        â© å¢é‡åŒæ­¥
                    </button>
                    <button class="btn btn-info" @onclick="ApplyOptimizedViews" disabled="@isRunning">
                        ğŸ”§ åº”ç”¨ä¼˜åŒ–è§†å›¾
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>åŒæ­¥çŠ¶æ€</h5>
            </div>
            <div class="card-body">
                @if (syncState != null)
                {
                    <dl class="row">
                        <dt class="col-sm-6">æœ€åå…¨é‡åŒæ­¥:</dt>
                        <dd class="col-sm-6">@(syncState.LastFullSync?.ToString("yyyy-MM-dd HH:mm:ss") ?? "ä»æœªæ‰§è¡Œ")</dd>
                        
                        <dt class="col-sm-6">æœ€åå¢é‡åŒæ­¥:</dt>
                        <dd class="col-sm-6">@(syncState.LastIncrementalSync?.ToString("yyyy-MM-dd HH:mm:ss") ?? "ä»æœªæ‰§è¡Œ")</dd>
                        
                        <dt class="col-sm-6">å½“å‰çŠ¶æ€:</dt>
                        <dd class="col-sm-6">
                            @if (syncState.IsRunning)
                            {
                                <span class="badge bg-warning">è¿è¡Œä¸­</span>
                            }
                            else
                            {
                                <span class="badge bg-success">ç©ºé—²</span>
                            }
                        </dd>
                    </dl>
                }
                else
                {
                    <p class="text-muted">åŠ è½½ä¸­...</p>
                }
            </div>
        </div>
    </div>
</div>

@if (connectionTestResult != null)
{
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card @(connectionTestResult.EkpConnected ? "border-success" : "border-danger")">
                <div class="card-header">
                    <h6 class="mb-0">EKP æ•°æ®åº“è¿æ¥</h6>
                </div>
                <div class="card-body">
                    <p class="mb-2">
                        <span class="badge @(connectionTestResult.EkpConnected ? "bg-success" : "bg-danger")">
                            @(connectionTestResult.EkpConnected ? "âœ“ å·²è¿æ¥" : "âœ— è¿æ¥å¤±è´¥")
                        </span>
                    </p>
                    <p class="mb-1">@connectionTestResult.EkpMessage</p>
                    @if (connectionTestResult.EkpConnected)
                    {
                        <small class="text-muted">
                            ç”¨æˆ·è§†å›¾: @connectionTestResult.EkpUsersCount æ¡ | 
                            ç»„ç»‡è§†å›¾: @connectionTestResult.EkpOrgsCount æ¡
                        </small>
                    }
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card @(connectionTestResult.CasdoorConnected ? "border-success" : "border-danger")">
                <div class="card-header">
                    <h6 class="mb-0">Casdoor API è¿æ¥</h6>
                </div>
                <div class="card-body">
                    <p class="mb-2">
                        <span class="badge @(connectionTestResult.CasdoorConnected ? "bg-success" : "bg-danger")">
                            @(connectionTestResult.CasdoorConnected ? "âœ“ å·²è¿æ¥" : "âœ— è¿æ¥å¤±è´¥")
                        </span>
                    </p>
                    <p class="mb-1">@connectionTestResult.CasdoorMessage</p>
                    @if (connectionTestResult.CasdoorConnected)
                    {
                        <small class="text-muted">
                            Endpoint: @connectionTestResult.CasdoorEndpoint<br>
                            Owner: @connectionTestResult.CasdoorOwner<br>
                            ç”¨æˆ·: @connectionTestResult.CasdoorUsersCount ä¸ª | 
                            ç»„: @connectionTestResult.CasdoorGroupsCount ä¸ª
                        </small>
                    }
                </div>
            </div>
        </div>
    </div>
}

@if (syncPreview != null)
{
    <div class="row mt-4">
        <div class="col-12">
            <div class="card @(syncPreview.Success ? "border-info" : "border-danger")">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">ğŸ‘ï¸ åŒæ­¥é¢„è§ˆ - @syncPreview.GeneratedAt.ToString("yyyy-MM-dd HH:mm:ss")</h5>
                </div>
                <div class="card-body">
                    @if (syncPreview.Success)
                    {
                        <div class="row">
                            <div class="col-md-6">
                                <h6>ğŸ“ ç»„ç»‡å˜æ›´</h6>
                                <ul class="list-unstyled">
                                    <li><span class="badge bg-primary">@syncPreview.OrgsToCreate</span> ä¸ªç»„ç»‡å°†è¢«åˆ›å»º</li>
                                    <li><span class="badge bg-warning text-dark">@syncPreview.OrgsToUpdate</span> ä¸ªç»„ç»‡å°†è¢«æ›´æ–°</li>
                                    <li><span class="badge bg-secondary">@syncPreview.OrgsInCasdoorOnly</span> ä¸ªç»„ç»‡ä»…åœ¨ Casdoorï¼ˆä¸å¤„ç†ï¼‰</li>
                                </ul>
                                @if (syncPreview.OrgCreateSamples.Any())
                                {
                                    <details>
                                        <summary class="text-muted small" style="cursor: pointer;">æŸ¥çœ‹åˆ›å»ºç¤ºä¾‹ (å‰ @syncPreview.OrgCreateSamples.Count ä¸ª)</summary>
                                        <ul class="small mt-2">
                                            @foreach (var org in syncPreview.OrgCreateSamples)
                                            {
                                                <li>@org</li>
                                            }
                                        </ul>
                                    </details>
                                }
                            </div>
                            <div class="col-md-6">
                                <h6>ğŸ‘¤ ç”¨æˆ·å˜æ›´</h6>
                                <ul class="list-unstyled">
                                    <li><span class="badge bg-primary">@syncPreview.UsersToCreate</span> ä¸ªç”¨æˆ·å°†è¢«åˆ›å»º</li>
                                    <li><span class="badge bg-warning text-dark">@syncPreview.UsersToUpdate</span> ä¸ªç”¨æˆ·å°†è¢«æ›´æ–°</li>
                                    <li><span class="badge bg-secondary">@syncPreview.UsersInCasdoorOnly</span> ä¸ªç”¨æˆ·ä»…åœ¨ Casdoorï¼ˆä¸å¤„ç†ï¼‰</li>
                                </ul>
                                @if (syncPreview.UserCreateSamples.Any())
                                {
                                    <details>
                                        <summary class="text-muted small" style="cursor: pointer;">æŸ¥çœ‹åˆ›å»ºç¤ºä¾‹ (å‰ @syncPreview.UserCreateSamples.Count ä¸ª)</summary>
                                        <ul class="small mt-2">
                                            @foreach (var user in syncPreview.UserCreateSamples)
                                            {
                                                <li>@user</li>
                                            }
                                        </ul>
                                    </details>
                                }
                            </div>
                        </div>
                        <hr>
                        <p class="mb-0 text-muted">
                            <strong>æ€»ç»“:</strong> å°†åˆ›å»º @(syncPreview.OrgsToCreate + syncPreview.UsersToCreate) ä¸ªå¯¹è±¡ï¼Œ
                            æ›´æ–° @(syncPreview.OrgsToUpdate + syncPreview.UsersToUpdate) ä¸ªå¯¹è±¡
                        </p>
                    }
                    else
                    {
                        <div class="alert alert-danger mb-0">@syncPreview.Message</div>
                    }
                </div>
            </div>
        </div>
    </div>
}

@if (syncResult != null)
{
    <div class="row mt-4">
        <div class="col-12">
            <div class="alert @(syncResult.Success ? "alert-success" : "alert-danger")" role="alert">
                <h5 class="alert-heading">@(syncResult.Success ? "âœ“" : "âœ—") @syncResult.Message</h5>
                <hr>
                <p class="mb-0">
                    <strong>å¼€å§‹æ—¶é—´:</strong> @syncResult.StartTime.ToString("yyyy-MM-dd HH:mm:ss")<br>
                    <strong>ç»“æŸæ—¶é—´:</strong> @syncResult.EndTime.ToString("yyyy-MM-dd HH:mm:ss")<br>
                    <strong>è€—æ—¶:</strong> @((syncResult.EndTime - syncResult.StartTime).TotalSeconds.ToString("F2")) ç§’<br>
                    @if (syncResult.UsersProcessed > 0)
                    {
                        <text><strong>å¤„ç†ç”¨æˆ·:</strong> @syncResult.UsersProcessed<br></text>
                    }
                    @if (syncResult.OrganizationsProcessed > 0)
                    {
                        <text><strong>å¤„ç†ç»„ç»‡:</strong> @syncResult.OrganizationsProcessed<br></text>
                    }
                </p>
                @if (syncResult.Errors.Any())
                {
                    <hr>
                    <h6>é”™è¯¯è¯¦æƒ…:</h6>
                    <pre class="mb-0" style="max-height: 300px; overflow-y: auto;">@string.Join("\n", syncResult.Errors)</pre>
                }
            </div>
        </div>
    </div>
}

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>ç”¨æˆ·æŸ¥è¯¢</h5>
            </div>
            <div class="card-body">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" placeholder="è¾“å…¥ç”¨æˆ·åæˆ–å§“å" @bind="searchUserName">
                    <button class="btn btn-outline-secondary" type="button" @onclick="SearchUser">æŸ¥è¯¢</button>
                </div>
                
                @if (searchedUser != null)
                {
                    <div class="card">
                        <div class="card-body">
                            <dl class="row mb-0">
                                <dt class="col-sm-3">ç”¨æˆ·å:</dt>
                                <dd class="col-sm-9">@searchedUser.Username</dd>
                                
                                <dt class="col-sm-3">æ˜¾ç¤ºå:</dt>
                                <dd class="col-sm-9">@searchedUser.DisplayName</dd>
                                
                                <dt class="col-sm-3">éƒ¨é—¨:</dt>
                                <dd class="col-sm-9">@searchedUser.Affiliation</dd>
                                
                                <dt class="col-sm-3">å…¬å¸:</dt>
                                <dd class="col-sm-9">@searchedUser.CompanyName</dd>
                                
                                <dt class="col-sm-3">ç»„ç»‡:</dt>
                                <dd class="col-sm-9">@searchedUser.Owner</dd>
                            </dl>
                        </div>
                    </div>
                }
                else if (!string.IsNullOrEmpty(searchUserName) && searchPerformed)
                {
                    <div class="alert alert-warning">æœªæ‰¾åˆ°ç”¨æˆ·</div>
                }
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0">ğŸ“œ å®æ—¶åŒæ­¥æ—¥å¿— (æœ€è¿‘50æ¡)</h5>
            </div>
            <div class="card-body p-0">
                <div style="max-height: 400px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.85rem;">
                    @if (syncLogs.Any())
                    {
                        <table class="table table-sm table-hover mb-0">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th style="width: 150px;">æ—¶é—´</th>
                                    <th style="width: 80px;">çº§åˆ«</th>
                                    <th>æ¶ˆæ¯</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var log in syncLogs)
                                {
                                    var levelClass = log.Level switch
                                    {
                                        "Error" => "table-danger",
                                        "Warning" => "table-warning",
                                        _ => ""
                                    };
                                    <tr class="@levelClass">
                                        <td class="text-muted small">@log.Timestamp.ToString("HH:mm:ss.fff")</td>
                                        <td>
                                            <span class="badge @(log.Level == "Error" ? "bg-danger" : log.Level == "Warning" ? "bg-warning" : "bg-info")">
                                                @log.Level
                                            </span>
                                        </td>
                                        <td>
                                            @log.Message
                                            @if (!string.IsNullOrEmpty(log.Details))
                                            {
                                                <br />
                                                <small class="text-muted">@log.Details</small>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <div class="p-3 text-center text-muted">
                            æš‚æ— æ—¥å¿—ï¼Œæ‰§è¡ŒåŒæ­¥æ“ä½œåå°†æ˜¾ç¤ºå®æ—¶æ—¥å¿—
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private SyncState? syncState;
    private SyncResult? syncResult;
    private ConnectionTestResult? connectionTestResult;
    private SyncPreview? syncPreview;
    private UserInfo? searchedUser;
    private string searchUserName = "";
    private bool searchPerformed = false;
    private bool isRunning = false;
    private string syncType = "";
    
    protected override async Task OnInitializedAsync()
    {
        await RefreshState();
    }
    
    private async Task RefreshState()
    {
        syncState = await SyncService.GetSyncStateAsync();
    }
    
    private async Task TestConnections()
    {
        isRunning = true;
        syncType = "test";
        connectionTestResult = null;
        StateHasChanged();
        
        connectionTestResult = await SyncService.TestConnectionsAsync();
        
        isRunning = false;
        StateHasChanged();
    }
    
    private async Task PreviewSync()
    {
        isRunning = true;
        syncType = "preview";
        syncPreview = null;
        StateHasChanged();
        
        syncPreview = await SyncService.PreviewSyncAsync();
        
        isRunning = false;
        StateHasChanged();
    }
    
    private async Task PerformFullSync()
    {
        isRunning = true;
        syncType = "full";
        syncResult = null;
        StateHasChanged();
        
        syncResult = await SyncService.SyncAllAsync();
        
        isRunning = false;
        await RefreshState();
        StateHasChanged();
    }
    
    private async Task PerformIncrementalSync()
    {
        isRunning = true;
        syncType = "incremental";
        syncResult = null;
        StateHasChanged();
        
        syncResult = await SyncService.SyncIncrementalAsync();
        
        isRunning = false;
        await RefreshState();
        StateHasChanged();
    }
    
    private async Task ApplyOptimizedViews()
    {
        isRunning = true;
        StateHasChanged();
        
        var success = await SyncService.ApplyOptimizedViewsAsync();
        syncResult = new SyncResult
        {
            Success = success,
            Message = success ? "è§†å›¾ä¼˜åŒ–å·²åº”ç”¨" : "è§†å›¾ä¼˜åŒ–å¤±è´¥",
            StartTime = DateTime.Now,
            EndTime = DateTime.Now
        };
        
        isRunning = false;
        StateHasChanged();
    }
    
    private async Task SearchUser()
    {
        searchPerformed = true;
        searchedUser = await SyncService.PeekUserAsync(searchUserName);
        StateHasChanged();
    }
    
    private List<SyncLog> syncLogs = new();
    private System.Threading.Timer? logRefreshTimer;
    
    protected override void OnInitialized()
    {
        base.OnInitialized();
        // æ¯2ç§’åˆ·æ–°ä¸€æ¬¡æ—¥å¿—
        logRefreshTimer = new System.Threading.Timer(async _ => 
        {
            syncLogs = await SyncService.GetSyncLogsAsync(50);
            await InvokeAsync(StateHasChanged);
        }, null, TimeSpan.Zero, TimeSpan.FromSeconds(2));
    }
    
    public void Dispose()
    {
        logRefreshTimer?.Dispose();
    }
}
