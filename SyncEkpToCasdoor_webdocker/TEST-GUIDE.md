# 快速测试指南

## ✅ 应用已启动
**访问:** http://localhost:5233/sync

---

## 🔬 测试步骤（按顺序执行）

### 1️⃣ 测试连接 (30秒)
- **操作:** 点击 "🔌 测试连接" 按钮
- **预期结果:**
  - ✓ EKP 数据库: 连接成功 (用户: 1187, 组织: 177)
  - ✓ Casdoor API: 连接成功 (显示endpoint和owner)
- **如果失败:** 检查 appsettings.Development.json 配置

---

### 2️⃣ 预览同步 (1分钟)
- **操作:** 点击 "👁️ 预览同步" 按钮
- **预期结果:**
  - 显示将要创建的组织/用户数量
  - 显示将要更新的组织/用户数量
  - 显示示例列表（前20个创建，前10个更新）
- **如果失败:** 查看错误消息，可能是数据查询问题

---

### 3️⃣ 执行全量同步 (5-10分钟) ⭐ **核心测试**
- **操作:** 点击 "▶️ 全量同步" 按钮
- **观察点1 - UI状态:**
  - 按钮变灰，显示加载动画
  - 页面顶部状态显示"运行中"
  
- **观察点2 - 终端日志:** (切换到 dotnet 终端查看)
  ```
  [时间] 开始全量同步...
  [时间] 用户视图记录数: 1187
  [时间] 组织视图记录数: 177
  [时间] 成员关系视图记录数: 1291
  [时间] 同步组织进度: 10/177 (5%)      ← 新增的进度日志
  [时间] 同步组织进度: 20/177 (11%)     ← 每10个组织记录一次
  ...
  [时间] 同步用户进度: 50/1187 (4%)     ← 新增的进度日志
  [时间] 同步用户进度: 100/1187 (8%)    ← 每50个用户记录一次
  [时间] 同步用户进度: 150/1187 (12%)
  ...
  [时间] 用户同步完成: 1187 个用户已处理  ← 完成摘要
  ```

- **预期结果:**
  - ✓ 同步成功完成
  - ✓ UI 显示同步结果（耗时、处理数量）
  - ✓ 状态恢复为"空闲"
  - ✓ 按钮可再次点击

---

### 4️⃣ 测试并发保护 (30秒)
- **操作:** 
  1. 点击 "▶️ 全量同步"
  2. **立即再次点击** "▶️ 全量同步"（趁还在运行）
  
- **预期结果:**
  - ✓ 第二次点击返回: "同步任务正在运行中，请稍后再试 (已运行 X 秒)"
  - ✓ 第一次同步继续正常执行
  - ✓ 没有数据冲突或错误

---

### 5️⃣ 验证状态恢复 (1分钟)
- **操作:** 等待同步完成
- **检查点:**
  - ✓ UI 状态从"运行中"变为"空闲"
  - ✓ "最后全量同步"时间已更新
  - ✓ 可以立即开始新的同步（不卡住）
  - ✓ 刷新页面后状态仍然正确

---

## 🐛 修复验证

### 修复前的问题:
- ❌ 同步后 UI 一直显示"运行中"
- ❌ 无法再次点击同步按钮
- ❌ 看不到同步进度，不知道是卡死还是在运行
- ❌ 异常时状态无法恢复

### 修复后的改进:
- ✅ 使用 SemaphoreSlim 确保状态正确释放
- ✅ 显示"已运行 X 秒"提示
- ✅ 每10个组织输出进度日志
- ✅ 每50个用户输出进度日志
- ✅ 异常时也能正确恢复状态

---

## 📊 性能预估

基于数据量 (177组织 + 1187用户 + 1291成员关系):
- **预览同步:** ~1分钟 (只读取不写入)
- **全量同步:** ~5-10分钟 (取决于网络和Casdoor响应)
  - 组织同步: ~1-2分钟
  - 用户同步: ~4-8分钟
  - 网络延迟占主要时间

---

## ⚠️ 注意事项

1. **同步期间不要关闭终端** - 会中断同步
2. **观察日志输出频率** - 确认程序在正常运行
3. **首次同步较慢** - 需要创建大量数据
4. **后续同步会快** - 大部分是更新操作
5. **如果卡住超过5分钟无日志** - 按 Ctrl+C 重启应用

---

## 🎯 测试通过标准

✅ **必须通过:**
1. 连接测试成功
2. 预览同步能显示差异
3. 全量同步能看到进度日志
4. 同步完成后状态恢复为"空闲"
5. 并发点击返回正确提示

✅ **加分项:**
1. 进度日志频率合理（不太频繁不太稀疏）
2. 同步速度满足预期（5-10分钟内完成）
3. 错误提示清晰友好
4. UI 响应流畅不卡顿

---

**测试时间:** 2025-10-31  
**修复内容:** 同步状态管理 + 进度日志  
**测试人:** 待填写  
**测试结果:** 待填写
