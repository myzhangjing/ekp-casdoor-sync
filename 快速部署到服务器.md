# 🚀 快速部署到服务器

## 代码已同步完成! ✅

所有代码已推送到GitHub仓库:
- **仓库**: https://github.com/myzhangjing/ekp-casdoor-sync
- **分支**: web-docker
- **提交**: 993f0b9

## 📦 本次更新内容

### 核心功能
- ✅ OAuth 2.0 认证系统 (Casdoor集成)
- ✅ EmptyLayout解决方案 (修复登录页面显示)
- ✅ 定时同步后台服务
- ✅ Cookie会话管理
- ✅ built-in组织验证

### 测试框架
- ✅ 9大类23项完整功能测试
- ✅ OAuth自动化测试
- ✅ 性能基准测试 (平均<100ms)
- ✅ 安全性验证
- ✅ 测试成功率: 84.21%

### 部署工具
- ✅ 一键部署脚本 (`server-deploy.sh`)
- ✅ Docker支持
- ✅ systemd服务配置
- ✅ 完整部署文档

## 🎯 服务器部署步骤

### 方式1: 一键部署 (推荐) ⚡

在你的服务器上执行:

```bash
# 下载部署脚本
wget https://raw.githubusercontent.com/myzhangjing/ekp-casdoor-sync/web-docker/server-deploy.sh

# 添加执行权限
chmod +x server-deploy.sh

# 运行部署 (自动完成所有步骤)
./server-deploy.sh
```

**脚本会自动:**
1. 检查并安装依赖 (Git, .NET 8.0)
2. 克隆代码仓库
3. 编译发布应用
4. 配置systemd服务
5. 启动应用
6. 健康检查

### 方式2: 手动部署

```bash
# 1. 克隆仓库
git clone -b web-docker https://github.com/myzhangjing/ekp-casdoor-sync.git
cd ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/SyncEkpToCasdoor.Web

# 2. 发布应用
dotnet publish -c Release -o ./publish

# 3. 运行应用
cd publish
dotnet SyncEkpToCasdoor.Web.dll
```

## ⚙️ 部署后配置

### 1. 编辑配置文件

```bash
nano ~/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/SyncEkpToCasdoor.Web/appsettings.json
```

**关键配置项:**

```json
{
  "EkpConnection": "Server=你的数据库IP,1433;Database=ecology;User Id=sa;Password=密码;TrustServerCertificate=true",
  
  "CasdoorAuth": {
    "ClientId": "cb838421e04ecd30f72b",
    "ClientSecret": "e54b3c2d06c864ac9243a03b8002b75167dce01d",
    "Authority": "http://sso.fzcsps.com",
    "CallbackPath": "/callback",
    "AllowedOwner": "built-in"
  },
  
  "TargetCompanyIds": "16f1c1a4910426f41649fd14862b99a1,18e389224b660b4d67413f8466285581"
}
```

### 2. 重启服务

```bash
sudo systemctl restart ekp-casdoor-sync
```

### 3. 访问应用

```
http://你的服务器IP:5233/login
```

## 🔍 验证部署

### 检查服务状态

```bash
# 查看服务状态
sudo systemctl status ekp-casdoor-sync

# 查看实时日志
sudo journalctl -u ekp-casdoor-sync -f

# 测试访问
curl http://localhost:5233/login
```

### 预期结果

- ✅ 服务状态: **active (running)**
- ✅ HTTP响应: **200 或 302** (重定向到登录)
- ✅ 日志无ERROR级别错误

## 📊 部署信息

| 项目 | 信息 |
|------|------|
| **应用名称** | ekp-casdoor-sync |
| **部署目录** | ~/ekp-casdoor-sync |
| **运行端口** | 5233 |
| **配置文件** | appsettings.json |
| **日志目录** | logs/ |
| **服务类型** | systemd |
| **.NET版本** | 8.0 |

## 🎮 服务管理命令

```bash
# 启动
sudo systemctl start ekp-casdoor-sync

# 停止
sudo systemctl stop ekp-casdoor-sync

# 重启
sudo systemctl restart ekp-casdoor-sync

# 查看状态
sudo systemctl status ekp-casdoor-sync

# 查看日志
sudo journalctl -u ekp-casdoor-sync -f

# 查看应用日志
tail -f ~/ekp-casdoor-sync/SyncEkpToCasdoor_webdocker/SyncEkpToCasdoor.Web/logs/*.log
```

## 🌐 外网访问配置 (可选)

### 使用Nginx反向代理

```bash
# 安装Nginx
sudo apt-get install -y nginx

# 配置反向代理
sudo nano /etc/nginx/sites-available/ekp-casdoor-sync
```

**配置内容:**

```nginx
server {
    listen 80;
    server_name 你的域名或IP;

    location / {
        proxy_pass http://localhost:5233;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection keep-alive;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

```bash
# 启用配置
sudo ln -s /etc/nginx/sites-available/ekp-casdoor-sync /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

## 🔄 更新部署

当代码有更新时:

```bash
# 重新运行部署脚本即可 (自动保存配置)
./server-deploy.sh
```

或手动更新:

```bash
cd ~/ekp-casdoor-sync
git pull origin web-docker
cd SyncEkpToCasdoor_webdocker/SyncEkpToCasdoor.Web
dotnet publish -c Release -o ./publish
sudo systemctl restart ekp-casdoor-sync
```

## ❗ 常见问题

### 1. 服务无法启动

```bash
# 查看详细错误
sudo journalctl -u ekp-casdoor-sync -n 50

# 检查端口占用
sudo lsof -i :5233
```

### 2. 数据库连接失败

- 检查数据库IP和端口
- 验证用户名密码
- 确认防火墙规则

### 3. OAuth认证失败

- 验证ClientId和ClientSecret
- 检查Casdoor服务可访问性
- 确认回调URL配置正确

### 4. 无法访问应用

```bash
# 检查防火墙
sudo ufw allow 5233/tcp
sudo ufw status

# 测试本地访问
curl http://localhost:5233/login
```

## 📚 详细文档

- 📖 **服务器部署指南**: `服务器部署指南.md`
- 🧪 **完整测试报告**: `完整功能模块测试报告.md`
- 🔐 **OAuth实现文档**: `SyncEkpToCasdoor_webdocker/SyncEkpToCasdoor.Web/OAUTH_IMPLEMENTATION.md`
- 🐛 **Bug修复记录**: `SyncEkpToCasdoor_webdocker/BUGFIX.md`

## ✅ 部署检查清单

部署前:
- [ ] 服务器已安装.NET 8.0 SDK
- [ ] Git已安装
- [ ] 网络可访问GitHub
- [ ] 端口5233未被占用

部署后:
- [ ] 服务运行正常 (`systemctl status`)
- [ ] 可访问登录页面
- [ ] 配置文件已修改
- [ ] 数据库连接测试成功
- [ ] OAuth认证测试通过
- [ ] 日志正常输出

## 🎉 部署完成!

访问你的应用:
```
http://你的服务器IP:5233/login
```

使用测试账号登录:
- 用户名: admin
- 密码: 123
- 组织: built-in

---

**需要帮助?** 查看详细文档或联系支持
